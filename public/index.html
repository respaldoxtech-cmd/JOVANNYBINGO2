<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yovanny Bingo Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="fixes.js"></script>

    <!-- Audio System -->
    <script>
        // Audio System for Bingo Sounds
        class BingoAudio {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.enabled = true;
                this.init();
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.createSounds();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                    this.enabled = false;
                }
            }

            createSounds() {
                // Bingo Celebration Sound
                this.sounds.bingo = () => this.createBingoSound();

                // New Player Join Sound
                this.sounds.playerJoin = () => this.createPlayerJoinSound();

                // Button Click Sound
                this.sounds.buttonClick = () => this.createButtonClickSound();

                // Number Draw Sound
                this.sounds.numberDraw = () => this.createNumberDrawSound();
            }

            createTone(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.enabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            createBingoSound() {
                // Triumphant fanfare-like sound
                const now = this.audioContext.currentTime;

                // C4, E4, G4 chord
                this.createTone(261.63, 0.8, 'triangle', 0.4); // C4
                setTimeout(() => this.createTone(329.63, 0.8, 'triangle', 0.4), 100); // E4
                setTimeout(() => this.createTone(392.00, 1.0, 'triangle', 0.4), 200); // G4

                // Higher celebration notes
                setTimeout(() => this.createTone(523.25, 0.3, 'sine', 0.3), 800); // C5
                setTimeout(() => this.createTone(659.25, 0.3, 'sine', 0.3), 900); // E5
                setTimeout(() => this.createTone(783.99, 0.5, 'sine', 0.3), 1000); // G5
            }

            createPlayerJoinSound() {
                // Pleasant notification sound
                this.createTone(440, 0.15, 'sine', 0.2); // A4
                setTimeout(() => this.createTone(554.37, 0.15, 'sine', 0.2), 150); // C#5
                setTimeout(() => this.createTone(659.25, 0.2, 'sine', 0.2), 300); // E5
            }

            createButtonClickSound() {
                // Short click sound
                this.createTone(800, 0.05, 'square', 0.1);
            }

            createNumberDrawSound() {
                // Ball rolling/dropping sound
                const now = this.audioContext.currentTime;

                // Quick descending tones
                this.createTone(600, 0.1, 'sawtooth', 0.2);
                setTimeout(() => this.createTone(500, 0.1, 'sawtooth', 0.2), 50);
                setTimeout(() => this.createTone(400, 0.15, 'sawtooth', 0.25), 100);
            }

            play(soundName) {
                if (this.enabled && this.sounds[soundName]) {
                    // Resume audio context if suspended (required by browsers)
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    this.sounds[soundName]();
                }
            }

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        }

        // Initialize audio system
        const bingoAudio = new BingoAudio();
    </script>
</head>
<body class="player-app">

    <div class="watermark-layer"></div>

    <div id="login-screen" class="login-wrapper active">
        <!-- Bot√≥n de Admin en esquina superior derecha -->
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel de Administrador">
            üîß
        </button>
        <div class="login-container glass-effect">
            <div class="brand-area">
                <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
            </div>
            <div class="form-group">
                <label>Nombre de Jugador</label>
                <input type="text" id="username" placeholder="Tu Apodo" autocomplete="off" maxlength="15">
            </div>
            <div class="form-group">
                <label>Selecciona tus Cartones</label>

                <div class="card-picker-ui">
                    <div class="picker-controls">
                        <input type="number" id="manual-input" placeholder="#" min="1" max="300">
                        <button onclick="addManualCard()" class="btn-add">+</button>
                        <button onclick="addRandomCard()" class="btn-random">üé≤</button>
                    </div>
                    <small class="hint-text">Elige del 1 al 300</small>

                    <div id="selected-list" class="chips-container"></div>
                </div>
            </div>
            <div id="login-error" style="color: #ef4444; font-size: 0.9rem; margin-top: 10px; display: none; font-weight: bold;"></div>

            <button onclick="joinGame()" class="btn-primary full-width">INGRESAR A SALA</button>
        </div>
    </div>

    <div class="global-announcement">
        <div class="marquee-content">
            <span class="announce-icon">üî¥ EN VIVO:</span>
            <span id="announcement-text">BIENVENIDOS A LA SALA DE BINGO YOVANNY... ESPERANDO INSTRUCCIONES...</span>
        </div>
    </div>

    <div id="game-screen" class="app-shell hidden">

        <header class="app-header glass-effect">
            <div class="header-left">
                <div class="avatar-circle"><span id="user-initial">Y</span></div>
                <div class="user-meta">
                    <span id="player-name-display" class="user-name">Usuario</span>
                    <span class="user-status">En l√≠nea</span>
                </div>
            </div>
            <div class="header-center">
                <div class="current-ball-display">
                    <div class="ball-label">BOLA</div>
                    <div id="current-number" class="ball-value">--</div>
                </div>
            </div>
            <div class="header-right">
                <div class="mode-badge" onclick="showPatternModal()">
                    <span class="mode-label">MODO</span>
                    <strong id="mode-display">FULL</strong>
                </div>
            </div>
        </header>

        <div class="history-bar">
            <span class="history-label">Yovanny Bingo:</span>
            <div id="player-last-5" class="history-track"></div>
        </div>

        <main class="cards-area">
            <div id="cards-container" class="cards-scroll-view"></div>
        </main>

        <nav class="bottom-nav glass-effect">
            <button onclick="toggleHistory()" class="nav-item">
                <span class="icon">üèÜ</span>
                <span class="label">Ganadores</span>
            </button>
            <div class="fab-container">
                <button onclick="shoutBingo()" class="btn-fab pulse" id="bingo-btn">BINGO</button>
            </div>
            <button onclick="logoutUser()" class="nav-item">
                <span class="icon">üö™</span>
                <span class="label">Salir</span>
            </button>
        </nav>


    </div>

    <div id="history-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up">
            <div class="modal-header">
                <h3>Ganadores Recientes</h3>
                <button onclick="toggleHistory()" class="btn-close">‚úï</button>
            </div>
            <ul id="history-list" class="data-list"></ul>
        </div>
    </div>

    <div id="pattern-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up">
            <div class="modal-header">
                <h3>Figura Actual: <span id="pattern-title"></span></h3>
                <button onclick="hidePatternModal()" class="btn-close">‚úï</button>
            </div>
            <div id="pattern-display" class="pattern-display">
                <!-- Mini bingo card will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Modal de Figura Personalizada -->
    <div id="custom-pattern-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up">
            <div class="modal-header">
                <h3>Figura Personalizada</h3>
                <button onclick="hideCustomPatternModal()" class="btn-close">‚úï</button>
            </div>
            <div id="custom-pattern-display" class="custom-pattern-display">
                <!-- Mini bingo card para figura personalizada -->
            </div>
            <div class="modal-actions" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="hideCustomPatternModal()" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="winner-overlay" class="fullscreen-overlay hidden">
        <div class="winner-box zoom-in">
            <div class="icon-trophy">üèÜ</div>
            <h2>¬°BINGO!</h2>
            <h3 id="winner-name-announce">Nombre</h3>
            <p>Cart√≥n <span id="winner-card-announce">#00</span></p>
            <button onclick="closeOverlay()" class="btn-primary">Continuar</button>
        </div>
    </div>

    <script>
        // --- SISTEMA DE FIGURAS COMPLETAMENTE NUEVO Y MEJORADO ---
        // Sistema reescrito desde cero con visualizaci√≥n correcta y validaci√≥n robusta
        const BINGO_PATTERNS = {
    // Patr√≥n b√°sico: cualquier l√≠nea completa
    'line': {
        name: 'L√çNEA',
        description: 'Gana con cualquier l√≠nea horizontal, vertical o diagonal completa',
        positions: [
            // Filas horizontales
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            // Columnas verticales
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            // Diagonales
            [0,6,12,18,24], [4,8,12,16,20]
        ],
        visual: [
            'XXXXX', 'XXXXX', 'XXXXX', 'XXXXX', 'XXXXX',
            'X    ', 'X    ', 'X    ', 'X    ', 'X    ',
            '  X  ', '  X  ', '  X  ', '  X  ', '  X  ',
            '    X', '    X', '    X', '    X', '    X',
            'X   X', ' X X ', '  X  ', ' X X ', 'X   X'
        ]
    },

            // Cart√≥n completo
            'full': {
                name: 'CART√ìN LLENO',
                description: 'Todo el cart√≥n debe estar marcado (Blackout completo)',
                positions: [[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]],
                visual: [
                    'XXXXX', 'XXXXX', 'XXXXX', 'XXXXX', 'XXXXX'
                ]
            },

            // Figuras geom√©tricas b√°sicas
            'corners': {
                name: '4 ESQUINAS',
                description: 'Las cuatro esquinas del cart√≥n',
                positions: [[0,4,20,24]],
                visual: [
                    'X   X', '     ', '     ', '     ', 'X   X'
                ]
            },

            'center': {
                name: 'CENTRO',
                description: 'Solo la casilla central del cart√≥n',
                positions: [[12]],
                visual: [
                    '     ', '     ', '  X  ', '     ', '     '
                ]
            },

            'cross': {
                name: 'CRUZ',
                description: 'Centro m√°s los cuatro brazos (forma de cruz)',
                positions: [[2,7,12,17,22]],
                visual: [
                    '  X  ', '  X  ', 'XXXXX', '  X  ', '  X  '
                ]
            },

            'plus': {
                name: 'PLUS',
                description: 'Centro m√°s los cuatro brazos (s√≠mbolo +)',
                positions: [[7,11,12,13,17]],
                visual: [
                    '     ', ' XXX ', ' XXX ', ' XXX ', '     '
                ]
            },

            'x_shape': {
                name: 'EQUIS (X)',
                description: 'Ambas diagonales cruzadas',
                positions: [[0,6,12,18,24], [4,8,12,16,20]],
                visual: [
                    'X   X', ' X X ', '  X  ', ' X X ', 'X   X'
                ]
            },

            // Marcos y bordes
            'frame': {
                name: 'MARCO EXTERIOR',
                description: 'Todo el borde exterior del cart√≥n',
                positions: [[0,1,2,3,4,9,14,19,24,23,22,21,20,15,10,5]],
                visual: [
                    'XXXXX', 'X   X', 'X   X', 'X   X', 'XXXXX'
                ]
            },

            'inner_square': {
                name: 'CUADRADO INTERIOR',
                description: 'Cuadrado central de 3x3 casillas',
                positions: [[6,7,8,11,13,16,17,18]],
                visual: [
                    '     ', ' XXX ', ' XXX ', ' XXX ', '     '
                ]
            },

            // Figuras de letras mejoradas
            'letter_l': {
                name: 'LETRA L',
                description: 'Forma de L may√∫scula',
                positions: [[0,5,10,15,20,21,22,23,24]],
                visual: [
                    'X    ', 'X    ', 'X    ', 'X    ', 'XXXXX'
                ]
            },

            'letter_t': {
                name: 'LETRA T',
                description: 'Forma de T may√∫scula',
                positions: [[0,1,2,3,4,7,12,17]],
                visual: [
                    'XXXXX', '  X  ', '  X  ', '  X  ', '  X  '
                ]
            },

            'letter_h': {
                name: 'LETRA H',
                description: 'Forma de H may√∫scula',
                positions: [[0,5,10,15,20,2,7,12,17,22,4,9,14,19,24]],
                visual: [
                    'X   X', 'X   X', 'XXXXX', 'X   X', 'X   X'
                ]
            },

            'letter_o': {
                name: 'LETRA O',
                description: 'Forma de O may√∫scula',
                positions: [[1,2,3,5,9,10,14,15,19,21,22,23]],
                visual: [
                    ' XXX ', 'X   X', 'X   X', 'X   X', ' XXX '
                ]
            },

            'letter_x': {
                name: 'LETRA X',
                description: 'Forma de X may√∫scula',
                positions: [[0,4,6,8,12,16,18,20,24]],
                visual: [
                    'X   X', ' X X ', '  X  ', ' X X ', 'X   X'
                ]
            },

            // Figuras especiales
            'diamond': {
                name: 'DIAMANTE',
                description: 'Forma de diamante',
                positions: [[2,6,10,14,18,22]],
                visual: [
                    '  X  ', ' X X ', 'X   X', ' X X ', '  X  '
                ]
            },

            'star': {
                name: 'ESTRELLA',
                description: 'Forma de estrella de 5 puntas',
                positions: [[2,6,7,8,10,12,14,16,17,18]],
                visual: [
                    '  X  ', ' X X ', 'XXXXX', ' X X ', '  X  '
                ]
            },

            'heart': {
                name: 'CORAZ√ìN',
                description: 'Forma de coraz√≥n',
                positions: [[1,3,5,7,8,9,11,12,13,15,17]],
                visual: [
                    ' X X ', 'XXXXX', 'XXXXX', ' XXX ', '  X  '
                ]
            },

            'arrow': {
                name: 'FLECHA',
                description: 'Forma de flecha apuntando hacia arriba',
                positions: [[2,6,7,8,10,11,12,13,14]],
                visual: [
                    '  X  ', ' XXX ', 'XXXXX', '  X  ', '  X  '
                ]
            },

            'pyramid': {
                name: 'PIR√ÅMIDE',
                description: 'Forma triangular de pir√°mide',
                positions: [[2,6,7,8,10,11,12,13,14,16,17,18]],
                visual: [
                    '  X  ', ' XXX ', 'XXXXX', '     ', '     '
                ]
            },

            'small_square': {
                name: 'CUADRADO PEQUE√ëO',
                description: 'Cuadrado 2x2 en esquina superior izquierda',
                positions: [[0,1,5,6]],
                visual: [
                    'XX   ', 'XX   ', '     ', '     ', '     '
                ]
            },

            'corner_square': {
                name: 'ESQUINA CUADRADA',
                description: 'Cuadrado 3x3 en esquina superior izquierda',
                positions: [[0,1,2,5,6,7,10,11,12]],
                visual: [
                    'XXX  ', 'XXX  ', 'XXX  ', '     ', '     '
                ]
            },

            'zigzag': {
                name: 'ZIGZAG',
                description: 'Patr√≥n en zigzag a trav√©s del cart√≥n',
                positions: [[0,6,8,10,12,14,16,18,20,24]],
                visual: [
                    'X    ', ' XXX ', 'X   X', ' XXX ', 'X   X'
                ]
            },

            'checkerboard': {
                name: 'AJEDREZ',
                description: 'Patr√≥n de ajedrez (casillas alternas)',
                positions: [[0,2,4,6,8,10,12,14,16,18,20,22,24]],
                visual: [
                    'X X X', ' X X ', 'X X X', ' X X ', 'X X X'
                ]
            },

            'hourglass': {
                name: 'RELOJ DE ARENA',
                description: 'Forma de reloj de arena',
                positions: [[0,4,6,8,12,16,18,20,24]],
                visual: [
                    'X   X', ' X X ', '  X  ', ' X X ', 'X   X'
                ]
            },

            'butterfly': {
                name: 'MARIPOSA',
                description: 'Forma de mariposa',
                positions: [[2,6,7,8,10,12,14,16,17,18]],
                visual: [
                    '  X  ', ' X X ', 'XXXXX', ' X X ', '  X  '
                ]
            },

            'crown': {
                name: 'CORONA',
                description: 'Forma de corona real',
                positions: [[0,1,2,3,4,6,8,12,16,18]],
                visual: [
                    'XXXXX', ' X X ', '  X  ', '     ', '     '
                ]
            },

            'lightning': {
                name: 'RAYO',
                description: 'Forma de rayo o rel√°mpago',
                positions: [[0,5,6,7,8,13,18,23]],
                visual: [
                    'X    ', 'XX   ', 'XXX  ', '  X  ', '   X '
                ]
            },

            'snake': {
                name: 'SERPIENTE',
                description: 'Patr√≥n serpenteante',
                positions: [[0,1,2,7,12,17,22,21,20,15,10,5]],
                visual: [
                    'XXX  ', '   X ', '  X  ', ' X   ', 'X    '
                ]
            },

            'spiral': {
                name: 'ESPIRAL',
                description: 'Patr√≥n en espiral',
                positions: [[0,1,2,3,8,13,18,23,22,21,20,15,10,5]],
                visual: [
                    'XXXX ', '    X', 'XXXX ', 'X    ', 'XXXX '
                ]
            },

            // Figuras personalizadas (admin puede definir)
            'custom': {
                name: 'FIGURA PERSONALIZADA',
                description: 'Figura definida manualmente por el administrador',
                positions: null, // Se define din√°micamente
                visual: ['     ', '     ', '     ', '     ', '     ']
            }
        };

        const socket = io();
        let myCards = []; // Cartones descargados
        let selectedIds = []; // Cartones seleccionados en el login
        let currentPattern = 'line'; // Patr√≥n actual del juego
        let currentCustomPatternGrid = null; // Para figuras personalizadas
        let playerSession = null; // Datos de sesi√≥n persistente



        // Cargar sesi√≥n guardada al iniciar
        function loadSavedSession() {
            const saved = localStorage.getItem('yovanny_bingo_session');
            if (saved) {
                try {
                    playerSession = JSON.parse(saved);
                    console.log('Sesi√≥n guardada encontrada:', playerSession);
                    return playerSession;
                } catch (e) {
                    localStorage.removeItem('yovanny_bingo_session');
                    return null;
                }
            }
            return null;
        }

        // Guardar sesi√≥n actual
        function saveSession(sessionData) {
            playerSession = sessionData;
            localStorage.setItem('yovanny_bingo_session', JSON.stringify(sessionData));
        }

        // Limpiar sesi√≥n
        function clearSession() {
            playerSession = null;
            localStorage.removeItem('yovanny_bingo_session');
        }

        // Intentar reconexi√≥n autom√°tica
        function attemptAutoReconnect() {
            const session = loadSavedSession();
            if (session && session.status === 'approved') {
                console.log('Intentando reconexi√≥n autom√°tica...');

                // Mostrar pantalla de reconexi√≥n
                document.getElementById('login-screen').classList.remove('active');
                setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);

                const reconnectScreen = document.createElement('div');
                reconnectScreen.id = 'reconnect-screen';
                reconnectScreen.className = 'login-wrapper active';
                reconnectScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üîÑ</div>
                        <h2>Reconectando...</h2>
                        <p>Restaurando tu sesi√≥n de juego...</p>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 20px;">
                            Usuario: ${session.username}<br>
                            Cartones: ${session.cardIds.length}
                        </p>
                    </div>
                `;
                document.body.appendChild(reconnectScreen);

                // Intentar reconectar
                socket.emit('reconnect_player', {
                    username: session.username,
                    cardIds: session.cardIds,
                    sessionId: session.sessionId
                });

                // Timeout por si falla la reconexi√≥n
                setTimeout(() => {
                    if (document.getElementById('reconnect-screen')) {
                        document.getElementById('reconnect-screen').remove();
                        document.getElementById('login-screen').classList.add('active');
                        document.getElementById('login-screen').classList.remove('hidden');
                        clearSession();
                        alert('No se pudo reconectar. Por favor inicia sesi√≥n nuevamente.');
                    }
                }, 5000);
            }
        }

        // Manejar reconexi√≥n exitosa
        socket.on('reconnection_success', (data) => {
            // Remover pantalla de reconexi√≥n
            const reconnectScreen = document.getElementById('reconnect-screen');
            if(reconnectScreen) {
                reconnectScreen.remove();
            }

            myCards = data.cards;
            const user = playerSession.username;

            // Ocultar login y mostrar juego
            document.getElementById('login-screen').classList.remove('active');
            setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);
            document.getElementById('game-screen').classList.remove('hidden');

            document.getElementById('player-name-display').innerText = user;
            document.getElementById('user-initial').innerText = user.charAt(0).toUpperCase();

            // üéµ Sonido de entrada al juego
            bingoAudio.play('playerJoin');

            // Renderizar cartones
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            data.cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-visual-${card.id}`;

                const head = document.createElement('div');
                head.className = 'card-head';
                head.innerHTML = `<span><b>Yovanny Bingo #${card.id}</b></span> <button class='btn-mini-dl' onclick='downloadSingleCard(${card.id})'>‚¨á</button>`;
                cardEl.appendChild(head);

                const grid = document.createElement('div');
                grid.className = 'card-grid disable-clicks';

                ['B','I','N','G','O'].forEach(l => {
                    const cell = document.createElement('div');
                    cell.className = `grid-header col-${l}`;
                    cell.innerText = l;
                    grid.appendChild(cell);
                });

                for(let i=0; i<5; i++) {
                    const row = [card.B[i], card.I[i], card.N[i], card.G[i], card.O[i]];
                    row.forEach(n => {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        if(n === "FREE") {
                            cell.classList.add('marked', 'free');
                            cell.innerHTML = "‚òÖ";
                        } else {
                            cell.innerText = n;
                            cell.id = `c${card.id}-n${n}`;
                            // Los jugadores NO pueden marcar/desmarcar manualmente
                            // Solo el administrador puede llamar n√∫meros
                        }
                        grid.appendChild(cell);
                    });
                }
                cardEl.appendChild(grid);
                container.appendChild(cardEl);
            });

            console.log(`Jugador ${user} reconectado exitosamente con ${data.cards.length} cartones`);
        });

        socket.on('reconnection_failed', (data) => {
            // Remover pantalla de reconexi√≥n
            const reconnectScreen = document.getElementById('reconnect-screen');
            if(reconnectScreen) {
                reconnectScreen.remove();
            }

            // Mostrar error y volver al login
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('login-screen').classList.remove('hidden');
            clearSession();
            alert(data.message);
        });

        // Intentar reconexi√≥n autom√°tica al cargar la p√°gina
        window.addEventListener('load', () => {
            attemptAutoReconnect();
        });

        // Intentar reconexi√≥n cuando el socket se reconecta
        socket.on('connect', () => {
            // Si ya ten√≠amos un cart√≥n (significa que es una reconexi√≥n tras ca√≠da), recargamos
            if (myCards.length > 0) {
                console.log("Reconectado, recargando p√°gina para resincronizar...");
                window.location.reload();
            }
        });

        // Si el servidor se desconecta y vuelve a conectar, recargamos para evitar errores de sincronizaci√≥n
        socket.on('disconnect', () => {
            console.log("Desconectado del servidor...");
        });

        // --- L√ìGICA DEL SELECTOR DE CARTONES ---

        function renderChips() {
            const container = document.getElementById('selected-list');
            container.innerHTML = '';

            if (selectedIds.length === 0) {
                container.innerHTML = '<span style="color:#666; font-size:0.8rem">Ning√∫n cart√≥n seleccionado</span>';
                return;
            }

            selectedIds.forEach(id => {
                const chip = document.createElement('div');
                chip.className = 'card-chip';
                chip.innerHTML = `<span>#${id}</span> <button onclick="removeCard(${id})">√ó</button>`;
                container.appendChild(chip);
            });
        }

        function addCardToSelection(id) {
            id = parseInt(id);
            if (isNaN(id) || id < 1 || id > 300) return alert("El n√∫mero debe estar entre 1 y 300");
            if (selectedIds.includes(id)) return alert("Ya seleccionaste este cart√≥n");

            selectedIds.push(id);
            renderChips();
        }

        function removeCard(id) {
            selectedIds = selectedIds.filter(x => x !== id);
            renderChips();
        }

        function addManualCard() {
            const input = document.getElementById('manual-input');
            addCardToSelection(input.value);
            input.value = '';
            input.focus();
        }

        function addRandomCard() {
            let rand;
            let safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (selectedIds.includes(rand) && safety < 500);

            addCardToSelection(rand);
        }

        // --- L√ìGICA DEL JUEGO ---

        function joinGame() {
            const user = document.getElementById('username').value;
            const errorDiv = document.getElementById('login-error');

            if(!user) {
                errorDiv.innerText = "Escribe tu nombre";
                errorDiv.style.display = 'block';
                return;
            }
            if(selectedIds.length === 0) {
                errorDiv.innerText = "Selecciona al menos un cart√≥n";
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            // Enviamos el array selectedIds directamente
            socket.emit('join_game', { username: user, cardIds: selectedIds });

            // Mostrar pantalla de espera de aprobaci√≥n
            document.getElementById('login-screen').classList.remove('active');
            setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);

            // Crear pantalla de espera
            const waitingScreen = document.createElement('div');
            waitingScreen.id = 'waiting-screen';
            waitingScreen.className = 'login-wrapper active';
            waitingScreen.innerHTML = `
                <div class="login-container glass-effect" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                    <h2>Esperando Aprobaci√≥n</h2>
                    <p>El administrador est√° revisando tu solicitud...</p>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 20px;">
                        Por favor espera mientras el admin aprueba tu ingreso.
                    </p>
                </div>
            `;
            document.body.appendChild(waitingScreen);
        }

        // --- MANEJO DE ERROR: CART√ìN OCUPADO ---
        socket.on('join_error', (data) => {
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                // Mostrar el error en la pantalla de espera
                waitingScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;">‚ùå</div>
                        <h2>Error de Ingreso</h2>
                        <p>${data.message}</p>
                        <button onclick="backToLogin()" class="btn-primary" style="margin-top: 20px;">Volver al Login</button>
                    </div>
                `;
            } else {
                // Fallback: mostrar en la pantalla de login
                const errorDiv = document.getElementById('login-error');
                errorDiv.innerText = data.message;
                errorDiv.style.display = 'block';
                document.querySelector('.login-container').animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
                document.getElementById('login-screen').classList.add('active');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // Mensaje de espera de aprobaci√≥n
        socket.on('waiting_approval', (data) => {
            // La pantalla de espera ya se cre√≥ en joinGame()
            console.log(data.message);
        });

        // Jugador aceptado
        socket.on('player_accepted', () => {
            // Remover pantalla de espera
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                waitingScreen.remove();
            }
            
            // Guardar sesi√≥n exitosa
            const user = document.getElementById('username').value;
            saveSession({
                username: user,
                cardIds: selectedIds,
                status: 'approved',
                sessionId: Date.now().toString()
            });
            
            // El init_cards se manejar√° normalmente
        });

        // Actualizar la l√≥gica para mostrar el modal correcto seg√∫n el patr√≥n
        function showPatternModal() {
            // Si es una figura personalizada, mostrar el modal de figura personalizada
            if (currentPattern === 'custom') {
                showCustomPatternModal();
                return;
            }

            const modal = document.getElementById('pattern-modal');
            const title = document.getElementById('pattern-title');
            const display = document.getElementById('pattern-display');

            // Set title
            const map = {
                'line': 'NORMAL (L√çNEA)',
                'line_horizontal': 'L√çNEA HORIZONTAL',
                'line_vertical': 'L√çNEA VERTICAL',
                'line_diagonal': 'L√çNEA DIAGONAL',
                'full': 'CART√ìN LLENO',
                'corners': '4 ESQUINAS',
                'x': 'X (DIAGONALES)',
                'plus': 'PLUS (CENTRO + BRAZOS)',
                'corners_center': 'ESQUINAS + CENTRO',
                'frame': 'MARCO EXTERIOR',
                'inner_frame': 'MARCO INTERIOR',
                'letter_h': 'LETRA H',
                'letter_t': 'LETRA T',
                'small_square': 'CUADRADO PEQUE√ëO',
                'diamond': 'DIAMANTE',
                'star': 'ESTRELLA',
                'heart': 'CORAZ√ìN',
                'airplane': 'AVI√ìN',
                'arrow': 'FLECHA',
                'crazy': 'CRAZY (ZIGZAG)',
                'pyramid': 'PIR√ÅMIDE',
                'cross': 'CRUZ',
                'custom': 'FIGURA MANUAL'
            };
            title.textContent = map[currentPattern] || currentPattern;

            // Generate mini card
            let html = '<div class="mini-bingo-card">';
            html += '<div class="mini-grid">';
            // Headers B I N G O
            ['B','I','N','G','O'].forEach(l => {
                html += `<div class="mini-header">${l}</div>`;
            });
            // 5x5 grid
            for(let row=0; row<5; row++) {
                for(let col=0; col<5; col++) {
                    const idx = row + col*5;
                    let classes = 'mini-cell';
                    if(isWinningCell(idx, currentPattern)) classes += ' winning';
                    if(idx === 12) classes += ' free';
                    html += `<div class="${classes}">${idx === 12 ? '‚òÖ' : ''}</div>`;
                }
            }
            html += '</div></div>';

            // Add explanations for each pattern
            const explanations = {
                'line': 'Gana cualquier l√≠nea: horizontal, vertical o diagonal',
                'line_horizontal_1': 'Gana cuando se completa la fila 1',
                'line_horizontal_2': 'Gana cuando se completa la fila 2',
                'line_horizontal_3': 'Gana cuando se completa la fila 3',
                'line_horizontal_4': 'Gana cuando se completa la fila 4',
                'line_horizontal_5': 'Gana cuando se completa la fila 5',
                'line_vertical_B': 'Gana cuando se completa la columna B',
                'line_vertical_I': 'Gana cuando se completa la columna I',
                'line_vertical_N': 'Gana cuando se completa la columna N',
                'line_vertical_G': 'Gana cuando se completa la columna G',
                'line_vertical_O': 'Gana cuando se completa la columna O',
                'line_diagonal_main': 'Gana cuando se completa la diagonal principal',
                'line_diagonal_secondary': 'Gana cuando se completa la diagonal secundaria',
                'line_horizontal': 'Gana cualquier l√≠nea horizontal (filas)',
                'line_vertical': 'Gana cualquier l√≠nea vertical (columnas)',
                'line_diagonal': 'Gana cualquier l√≠nea diagonal',
                'full': 'Todo el cart√≥n marcado (Blackout)',
                'corners': 'Las 4 esquinas del cart√≥n',
                'x': 'Ambas diagonales cruzadas (X)',
                'plus': 'Centro m√°s los 4 brazos (+)',
                'corners_center': '4 esquinas m√°s el centro',
                'frame': 'Marco exterior del cart√≥n',
                'inner_frame': 'Marco interior (cuadrado central)',
                'letter_h': 'Patr√≥n en forma de H',
                'letter_t': 'Patr√≥n en forma de T',
                'small_square': 'Cuadrado peque√±o en esquina superior izquierda',
                'diamond': 'Patr√≥n en forma de diamante',
                'star': 'Patr√≥n en forma de estrella',
                'heart': 'Patr√≥n en forma de coraz√≥n',
                'airplane': 'Patr√≥n en forma de avi√≥n',
                'arrow': 'Patr√≥n en forma de flecha',
                'crazy': 'Patr√≥n en forma de zigzag',
                'pyramid': 'Patr√≥n en forma de pir√°mide',
                'cross': 'Patr√≥n en forma de cruz',
                'custom': 'El administrador define la figura manualmente'
            };

            if(explanations[currentPattern]) {
                html += `<p class="pattern-explanation">${explanations[currentPattern]}</p>`;
            }

            display.innerHTML = html;
            modal.classList.remove('hidden');
        }

        // Jugador rechazado
        socket.on('player_rejected', (data) => {
            // Remover pantalla de espera y mostrar mensaje de rechazo
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                waitingScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;">‚ùå</div>
                        <h2>Solicitud Rechazada</h2>
                        <p>${data.message}</p>
                        <button onclick="location.reload()" class="btn-primary" style="margin-top: 20px;">Intentar de Nuevo</button>
                    </div>
                `;
            }
        });

        // Si entra con √©xito, inicializamos la UI
        socket.on('init_cards', ({ cards }) => {
            myCards = cards;
            const user = document.getElementById('username').value;

            // Ocultar login y mostrar juego
            document.getElementById('login-screen').classList.remove('active');
            setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);
            document.getElementById('game-screen').classList.remove('hidden');

            document.getElementById('player-name-display').innerText = user;
            document.getElementById('user-initial').innerText = user.charAt(0).toUpperCase();

            // üéµ Sonido de entrada al juego
            bingoAudio.play('playerJoin');

            // Renderizar cartones
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-visual-${card.id}`;

                const head = document.createElement('div');
                head.className = 'card-head';
                head.innerHTML = `<span><b>Yovanny Bingo #${card.id}</b></span> <button class='btn-mini-dl' onclick='downloadSingleCard(${card.id})'>‚¨á</button>`;
                cardEl.appendChild(head);

                const grid = document.createElement('div');
                grid.className = 'card-grid disable-clicks';

                ['B','I','N','G','O'].forEach(l => {
                    const cell = document.createElement('div');
                    cell.className = `grid-header col-${l}`;
                    cell.innerText = l;
                    grid.appendChild(cell);
                });

                for(let i=0; i<5; i++) {
                    const row = [card.B[i], card.I[i], card.N[i], card.G[i], card.O[i]];
                    row.forEach(n => {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        if(n === "FREE") {
                            cell.classList.add('marked', 'free');
                            cell.innerHTML = "‚òÖ";
                        } else {
                            cell.innerText = n;
                            cell.id = `c${card.id}-n${n}`;

                        }
                        grid.appendChild(cell);
                    });
                }
                cardEl.appendChild(grid);
                container.appendChild(cardEl);
            });
        });

        socket.on('kicked', () => { alert("Has sido expulsado."); location.reload(); });

        socket.on('sync_state', (s) => {
            document.getElementById('announcement-text').innerText = s.message;
            updateMode(s.pattern);
            updateHistory(s.last5Winners);
            updateLast5(s.last5Numbers);
            s.calledNumbers.forEach(markNumberInAllCards);
        });



        socket.on('number_called', (data) => {
            const { num, last5, totalCalled, pattern } = data;

            // Actualizar patr√≥n si cambi√≥
            if (pattern && pattern !== currentPattern) {
                currentPattern = pattern;
                updateMode(pattern);
            }

            // üéµ Sonido al sacar n√∫mero
            bingoAudio.play('numberDraw');

            const ball = document.getElementById('current-number');
            ball.style.transform = "scale(0.8)";
            setTimeout(() => {
                ball.innerText = num;
                ball.style.transform = "scale(1)";
            }, 150);

            markNumberInAllCards(num);
            updateLast5(last5);
            if(navigator.vibrate) navigator.vibrate(50);

            // Mostrar progreso en consola
            console.log(`üéØ N√∫mero llamado: ${num} | Total: ${totalCalled} | Patr√≥n: ${currentPattern}`);

            // Verificar victoria autom√°tica despu√©s de marcar el n√∫mero
            setTimeout(() => {
                checkAutomaticBingo();
            }, 0); // Delay cero para m√°xima inmediatez instant√°nea
        });



        socket.on('message_updated', (msg) => document.getElementById('announcement-text').innerText = msg);
        socket.on('pattern_changed', (data) => {
            if (typeof data === 'string') {
                updateMode(data);
            } else {
                currentPattern = data.type;
                currentCustomPatternGrid = data.grid || null;
                updateMode(data.type);
            }
        });
        
        socket.on('winner_announced', (data) => {
            document.getElementById('winner-name-announce').innerText = data.user;
            document.getElementById('winner-card-announce').innerText = `#${data.card}`;
            document.getElementById('winner-overlay').classList.remove('hidden');
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });


        });

        // üéµ AUDIO AUTOM√ÅTICO INMEDIATO - El cart√≥n "canta" bingo apenas se detecta
        socket.on('bingo_audio_automatic', (data) => {
            console.log('üéµ ¬°BINGO DETECTADO! Reproduciendo audio autom√°tico...');

            // üéµ AUDIO INMEDIATO - El cart√≥n canta bingo autom√°ticamente
            bingoAudio.play('bingo');

            // Vibraci√≥n inmediata para todos los dispositivos
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // Confetti inmediato para celebraci√≥n visual
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            // Mostrar mensaje de bingo inmediato en el anuncio
            const originalMessage = document.getElementById('announcement-text').innerText;
            document.getElementById('announcement-text').innerText = `¬°BINGO AUTOM√ÅTICO! ${data.winner.user} con cart√≥n #${data.winner.card}`;

            // Restaurar mensaje despu√©s de 8 segundos
            setTimeout(() => {
                document.getElementById('announcement-text').innerText = originalMessage;
            }, 8000);
        });

        // Celebraci√≥n autom√°tica cuando alguien gana
        socket.on('bingo_celebration', (data) => {
            // üéµ Sonido adicional de celebraci√≥n (ya se reprodujo el autom√°tico)
            // bingoAudio.play('bingo'); // Ya se reprodujo arriba

            // Mostrar mensaje de celebraci√≥n en el anuncio
            const originalMessage = document.getElementById('announcement-text').innerText;
            document.getElementById('announcement-text').innerText = data.message;

            // Efectos de celebraci√≥n adicionales para todos los jugadores
            if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);

            // Confetti m√°s moderado para otros jugadores
            setTimeout(() => {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
            }, 500);

            // Restaurar mensaje original despu√©s de 10 segundos
            setTimeout(() => {
                document.getElementById('announcement-text').innerText = originalMessage;
            }, 10000);
        });

        socket.on('update_history', (h) => updateHistory(h));
        
        socket.on('invalid_bingo', () => {
            const btn = document.querySelector('.btn-fab');
            btn.style.background = "#ef4444";
            btn.innerText = "Error";
            setTimeout(() => { 
                btn.style.background = ""; 
                btn.innerText = "BINGO"; 
            }, 1000);
        });

        socket.on('game_reset', () => {
            document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('marked'));
            document.getElementById('current-number').innerText = "--";
            document.getElementById('winner-overlay').classList.add('hidden');
            updateLast5([]);
        });

        function markNumberInAllCards(num) {
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${num}`);
                if(el) el.classList.add('marked');
            });
        }

        function updateLast5(arr) {
            document.getElementById('player-last-5').innerHTML = arr.map(n => `<div class="hist-ball">${n}</div>`).join('');
        }
        function updateMode(p) {
            currentPattern = p; // Actualizar patr√≥n actual para bingo autom√°tico

            // Usar el nuevo sistema de figuras centralizado
            const patternData = BINGO_PATTERNS[p];
            if (patternData) {
                document.getElementById('mode-display').innerText = patternData.name;
            } else {
                document.getElementById('mode-display').innerText = p;
            }
        }
        function updateHistory(l) {
            document.getElementById('history-list').innerHTML = l.length ? l.map(w => `<li><span class="t-name">${w.user}</span> <span class="t-card">#${w.card}</span></li>`).join('') : '<li class="empty">Lista vac√≠a</li>';
        }

        function toggleHistory() { document.getElementById('history-modal').classList.toggle('hidden'); }
        function shoutBingo() { socket.emit('bingo_shout'); }
        function closeOverlay() { document.getElementById('winner-overlay').classList.add('hidden'); }

        // Funci√≥n para mostrar el modal de patr√≥n
        function showPatternModal() {
            const modal = document.getElementById('pattern-modal');
            const title = document.getElementById('pattern-title');
            const display = document.getElementById('pattern-display');

            // Obtener el patr√≥n actual
            const patternData = BINGO_PATTERNS[currentPattern];
            if (patternData) {
                title.textContent = patternData.name;
            } else {
                title.textContent = currentPattern;
            }

            // Generate mini card
            let html = '<div class="mini-bingo-card">';
            html += '<div class="mini-grid">';
            // Headers B I N G O
            ['B','I','N','G','O'].forEach(l => {
                html += `<div class="mini-header">${l}</div>`;
            });
            // 5x5 grid
            for(let row=0; row<5; row++) {
                for(let col=0; col<5; col++) {
                    const idx = row + col*5;
                    let classes = 'mini-cell';
                    if(isWinningCell(idx, currentPattern)) classes += ' winning';
                    if(idx === 12) classes += ' free';
                    html += `<div class="${classes}">${idx === 12 ? '‚òÖ' : ''}</div>`;
                }
            }
            html += '</div></div>';

            // Add description for the pattern
            if (patternData && patternData.description) {
                html += `<p class="pattern-explanation">${patternData.description}</p>`;
            }

            display.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function isWinningCell(idx, pattern) {
            // Usar el nuevo sistema de figuras centralizado
            const patternData = BINGO_PATTERNS[pattern];
            if (!patternData || !patternData.positions) return false;

            // Verificar si alguna de las l√≠neas del patr√≥n contiene este √≠ndice
            return patternData.positions.some(line => {
                if (Array.isArray(line)) {
                    return line.includes(idx);
                }
                return line === idx;
            });
        }

        function hidePatternModal() {
            document.getElementById('pattern-modal').classList.add('hidden');
        }

        // Funci√≥n para mostrar el modal de figura personalizada
        function showCustomPatternModal() {
            const modal = document.getElementById('custom-pattern-modal');
            const display = document.getElementById('custom-pattern-display');

            // Generar mini card para figura personalizada
            let html = '<div class="mini-bingo-card">';
            html += '<div class="mini-grid">';
            // Headers B I N G O
            ['B','I','N','G','O'].forEach(l => {
                html += `<div class="mini-header">${l}</div>`;
            });
            // 5x5 grid
            for(let row=0; row<5; row++) {
                for(let col=0; col<5; col++) {
                    const idx = row + col*5;
                    let classes = 'mini-cell';
                    // Para figuras personalizadas, usar el grid actual
                    if(currentCustomPatternGrid && currentCustomPatternGrid[idx]) {
                        classes += ' winning';
                    }
                    if(idx === 12) classes += ' free';
                    html += `<div class="${classes}">${idx === 12 ? '‚òÖ' : ''}</div>`;
                }
            }
            html += '</div></div>';

            display.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function hideCustomPatternModal() {
            document.getElementById('custom-pattern-modal').classList.add('hidden');
        }



        // Funci√≥n para salir del juego
        function logoutUser() {
            if(confirm("¬øEst√°s seguro de que quieres salir del juego? Perder√°s tu progreso actual y tus cartones ser√°n liberados.")) {
                // Limpiar sesi√≥n guardada
                clearSession();
                
                // Desconectar del socket
                socket.disconnect();
                
                // Recargar la p√°gina para volver al login
                location.reload();
            }
        }

        // Funci√≥n para volver al login desde error
        function backToLogin() {
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) waitingScreen.remove();
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // Funci√≥n para ir al panel de admin
        function goToAdmin() {
            window.location.href = '/admin-login.html';
        }

        // --- VERIFICACI√ìN AUTOM√ÅTICA DE BINGO ---
        function checkAutomaticBingo() {
            // Solo verificar si tenemos cartones y estamos conectados
            if(!myCards || myCards.length === 0) return;

            // Obtener n√∫meros llamados actuales (de los elementos marcados)
            const calledNumbers = [];
            document.querySelectorAll('.grid-cell.marked').forEach(cell => {
                if(cell.innerText && cell.innerText !== '‚òÖ') {
                    calledNumbers.push(parseInt(cell.innerText));
                }
            });

            // Usar el patr√≥n actual sincronizado desde el servidor
            for(let card of myCards) {
                if(checkCardWin(card, calledNumbers, currentPattern)) {
                    // ¬°BINGO AUTOM√ÅTICO! Emitir el grito autom√°ticamente
                    console.log(`¬°BINGO AUTOM√ÅTICO! Cart√≥n ${card.id} completado con patr√≥n ${currentPattern}`);
                    socket.emit('bingo_shout');
                    return; // Solo el primer cart√≥n que gane
                }
            }
        }

        // Funci√≥n auxiliar para verificar victoria (usando el nuevo sistema centralizado)
        function checkCardWin(card, calledNumbers, pattern) {
            console.log(`üîç Verificando victoria cliente - Patr√≥n: ${pattern}, N√∫meros llamados: ${calledNumbers.length}`);

            // Aplanar el cart√≥n por columnas: √≠ndices 0-4(B), 5-9(I), 10-14(N), etc.
            // √çndice 12 es el centro (FREE)
            let flatCard = [...card.B, ...card.I, ...card.N, ...card.G, ...card.O];

            // Funci√≥n auxiliar para ver si una celda est√° marcada
            const isMarked = (val) => val === "FREE" || calledNumbers.includes(val);

            // Usar el nuevo sistema de validaci√≥n centralizada
            return validatePattern(pattern, flatCard, calledNumbers);
        }

        // Funci√≥n de validaci√≥n centralizada (igual que en el servidor)
        function validatePattern(patternType, flatCard, calledNumbers) {
            const isMarked = (val) => val === "FREE" || calledNumbers.includes(val);

            // Obtener el patr√≥n desde la definici√≥n centralizada
            const pattern = BINGO_PATTERNS[patternType];
            if (!pattern) return false;

            // Para patrones que tienen posiciones definidas
            if (pattern.positions) {
                // Verificar si alguna de las l√≠neas del patr√≥n est√° completa
                return pattern.positions.some(line => {
                    // Si es un array de arrays (m√∫ltiples l√≠neas posibles)
                    if (Array.isArray(line)) {
                        return line.every(idx => isMarked(flatCard[idx]));
                    }
                    // Si es un array simple (una sola l√≠nea)
                    return line.every ? line.every(idx => isMarked(flatCard[idx])) : isMarked(flatCard[line]);
                });
            }

            return false;
        }
        
        // --- FUNCI√ìN DE DESCARGA INTELIGENTE ---
        
        // 1. Descargar UN SOLO cart√≥n (cuando clickean el icono del cart√≥n)
        async function downloadSingleCard(cardId) {
            const cardElement = document.getElementById(`card-visual-${cardId}`);
            if(!cardElement) return;

            // Ocultar bot√≥n de descarga temporalmente para la foto
            const btn = cardElement.querySelector('.btn-mini-dl');
            if(btn) btn.style.display = 'none';

            await captureAndSave(cardElement, `Yovanny-Bingo-Carton-${cardId}.png`);

            // Restaurar bot√≥n
            if(btn) btn.style.display = 'flex';
        }

        // 2. Descargar TODOS los cartones (Bot√≥n del Dock)
        async function downloadAllCards() {
            if(myCards.length === 0) return alert("No tienes cartones.");
            
            const mainBtn = document.querySelector('.nav-item span.label');
            const originalText = mainBtn.innerText;
            mainBtn.innerText = "Guardando...";

            // Iterar y descargar uno por uno con un peque√±o delay para no bloquear
            for (let i = 0; i < myCards.length; i++) {
                await downloadSingleCard(myCards[i].id);
                // Peque√±a pausa para que el navegador procese la descarga
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            mainBtn.innerText = originalText;
        }

        // Funci√≥n auxiliar de captura
        async function captureAndSave(element, filename) {
            // Guardar estilos originales
            const originalBg = element.style.background;
            const originalColor = element.style.color;
            const originalBorder = element.style.border;

            // Aplicar estilos "Modo Impresi√≥n" (Alto Contraste) para que se vea bien la imagen
            element.style.background = "#ffffff";
            element.style.color = "#000000";
            element.style.border = "3px solid #000000";
            element.style.borderRadius = "8px";

            // Cambiar colores de celdas para alto contraste
            const cells = element.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                c.style.border = "2px solid #333333";
                c.style.backgroundColor = "#ffffff"; // Fondo blanco
                c.style.color = "#000000"; // Texto negro
                c.style.fontWeight = "900";
                c.style.fontSize = "1.4rem";
                if(c.classList.contains('marked')) {
                    c.style.backgroundColor = "#000000"; // Marca negra
                    c.style.color = "#ffffff"; // Texto blanco
                    c.style.border = "2px solid #000000";
                }
                if(c.classList.contains('free')) {
                    c.style.color = "#ff6b35"; // Color especial para FREE
                    c.style.fontSize = "1.8rem";
                }
            });

            // Cambiar colores de headers de columnas
            const headers = element.querySelectorAll('.grid-header');
            headers.forEach(h => {
                h.style.backgroundColor = "#e74c3c"; // Rojo fuerte
                h.style.color = "#ffffff";
                h.style.border = "2px solid #c0392b";
                h.style.fontWeight = "900";
            });

            // Cambiar el t√≠tulo del cart√≥n
            const title = element.querySelector('.card-head span');
            if(title) {
                title.style.color = "#000000";
                title.style.fontWeight = "900";
                title.style.fontSize = "1.1rem";
            }

            try {
                const canvas = await html2canvas(element, {
                    scale: 3, // Mayor calidad
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false,
                    width: element.offsetWidth,
                    height: element.offsetHeight
                });

                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();

            } catch (err) {
                console.error("Error al guardar", err);
            } finally {
                // Restaurar estilos originales (Modo App Oscuro)
                element.style.background = originalBg;
                element.style.color = originalColor;
                element.style.border = originalBorder;
                element.style.borderRadius = "";

                // Restaurar celdas
                cells.forEach(c => {
                    c.style.border = "";
                    c.style.backgroundColor = "";
                    c.style.color = "";
                    c.style.fontWeight = "";
                    c.style.fontSize = "";
                });

                // Restaurar headers
                headers.forEach(h => {
                    h.style.backgroundColor = "";
                    h.style.color = "";
                    h.style.border = "";
                    h.style.fontWeight = "";
                });

                // Restaurar t√≠tulo
                if(title) {
                    title.style.color = "";
                    title.style.fontWeight = "";
                    title.style.fontSize = "";
                }
            }
        }
    </script>
</body>
</html>