<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yovanny Bingo - Juega Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @keyframes pop-highlight {
            0% { transform: scale(1); }
            40% { transform: scale(1.25); filter: brightness(1.3); box-shadow: 0 0 15px rgba(255,255,255,0.6); }
            100% { transform: scale(1); }
        }
        .grid-cell { cursor: default; transition: all 0.2s ease; }
        .grid-cell.pop-anim { animation: pop-highlight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes gold-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); border-color: #ffd700; }
            50% { box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0); border-color: #ffed4a; }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); border-color: #ffd700; }
        }
        .bingo-card.near-win {
            animation: gold-pulse 1.5s infinite;
            border: 2px solid #ffd700 !important;
            z-index: 10;
        }
        
        .bingo-card { position: relative; }
        .proximity-badge {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #ff3b30;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 800;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 15;
            opacity: 0;
            transform: translateY(10px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            border: 2px solid rgba(255,255,255,0.8);
        }
        .bingo-card.near-win .proximity-badge {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        /* Estilos del Chat */
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; background: rgba(0,0,0,0.1); height: 50vh; min-height: 300px; }
        .chat-bubble { max-width: 80%; padding: 0.6rem 1rem; border-radius: 1rem; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .chat-bubble.mine { align-self: flex-end; background: #4f46e5; color: white; border-bottom-right-radius: 0.2rem; }
        .chat-bubble.others { align-self: flex-start; background: rgba(255,255,255,0.15); color: white; border-bottom-left-radius: 0.2rem; }
        .chat-bubble .sender { font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.2rem; display: block; font-weight: 600; }
        .chat-bubble.admin {
            align-self: center;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: 1px solid #fca5a5;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
            animation: pop-highlight 0.5s ease-out;
        }
        .chat-bubble .time { font-size: 0.65rem; opacity: 0.6; float: right; margin-left: 8px; margin-top: 4px; }
        .chat-input-area { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .chat-input-area input { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 0.8rem; border-radius: 2rem; color: white; outline: none; }
        .chat-badge { position: absolute; top: 5px; right: 20px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid rgba(255,255,255,0.2); z-index: 5; }
        
        .quick-reactions { display: flex; gap: 8px; padding: 0 1rem 0.5rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .reaction-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 1.2rem; transition: all 0.2s; flex-shrink: 0; }
        .reaction-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        
        /* Chat Panel Inmersivo */
        #chat-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            pointer-events: auto;
        }
        #chat-panel.open { transform: translateY(0); }
        .chat-header { padding: 10px 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        @media (max-width: 768px) {
            #chat-panel { 
                width: 94%; 
                left: 3%; 
                right: 3%; 
                bottom: 95px; /* MÃ¡s arriba para no tapar la nav */
                height: 45vh; 
                border-radius: 16px;
                z-index: 2000;
            }
        }
    </style>
</head>
<body class="player-app">
    <!-- Marca de agua -->
    <div class="watermark-layer"></div>

    <!-- Ticker de anuncios -->
    <div class="global-announcement">
        <div class="marquee-content">
            <span class="announce-icon">ğŸ”´ EN VIVO:</span>
            <span id="announcement-text">BIENVENIDOS AL BINGO YOVANNY - ESPERANDO INICIO DEL JUEGO...</span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE BIENVENIDA -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="welcome-screen" class="screen active">
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">âš™ï¸</button>
        <div class="login-container glass-card">
            <div class="brand-area">
                <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                <h1 class="brand-title">BINGO YOVANNY</h1>
                <p class="brand-subtitle">Â¡La suerte estÃ¡ de tu lado!</p>
            </div>
            <div class="welcome-buttons">
                <button onclick="enterAsGuest()" class="btn-primary btn-glow btn-block">
                    ğŸ® JUGAR COMO INVITADO
                </button>
                <button onclick="showAuthScreen()" class="btn-secondary btn-block">
                    ğŸ‘¤ CREAR CUENTA O INICIAR SESIÃ“N
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE AUTENTICACIÃ“N -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="auth-screen" class="screen">
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">âš™ï¸</button>
        <div class="login-container glass-card">
            <div class="brand-area">
                <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                <h1 class="brand-title">MI CUENTA</h1>
            </div>
            <div class="auth-tabs">
                <button id="tab-login" class="auth-tab active" onclick="switchAuthTab('login')">Iniciar sesiÃ³n</button>
                <button id="tab-register" class="auth-tab" onclick="switchAuthTab('register')">Crear cuenta</button>
            </div>
            <div id="auth-login" class="auth-form">
                <div class="form-group">
                    <label>ğŸ‘¤ Usuario</label>
                    <input type="text" id="auth-username" placeholder="Tu usuario..." maxlength="50" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>ğŸ”’ ContraseÃ±a</label>
                    <input type="password" id="auth-password" placeholder="Tu contraseÃ±a..." autocomplete="current-password">
                </div>
                <div id="auth-error" class="error-msg"></div>
                <button onclick="doLogin()" class="btn-primary btn-glow btn-block">Ingresar</button>
            </div>
            <div id="auth-register" class="auth-form hidden">
                <div class="form-group">
                    <label>ğŸ‘¤ Usuario</label>
                    <input type="text" id="reg-username" placeholder="Elige un usuario..." maxlength="50" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>ğŸ”’ ContraseÃ±a</label>
                    <input type="password" id="reg-password" placeholder="MÃ­nimo 4 caracteres..." autocomplete="new-password">
                </div>
                <div id="reg-error" class="error-msg"></div>
                <button onclick="doRegister()" class="btn-primary btn-glow btn-block">Crear cuenta</button>
            </div>
            <button onclick="backToWelcome()" class="btn-link">â† Volver</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE LOGIN / SELECCIÃ“N DE CARTONES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="login-screen" class="screen">
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">âš™ï¸</button>
        
        <div class="login-container glass-card">
            <div class="brand-area">
                <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                <h1 class="brand-title">BINGO YOVANNY</h1>
                <p class="brand-subtitle">Â¡La suerte estÃ¡ de tu lado!</p>
            </div>
            
            <div class="form-group">
                <label>ğŸ‘¤ Tu nombre</label>
                <input type="text" id="username" placeholder="Escribe tu apodo..." maxlength="20" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label>ğŸ« Selecciona tus cartones</label>
                <div class="card-picker">
                    <div class="picker-controls">
                        <input type="number" id="manual-input" placeholder="#" min="1" max="300">
                        <button onclick="addManualCard()" class="btn-add" title="Agregar">â•</button>
                        <button onclick="addRandomCard()" class="btn-random" title="Aleatorio">ğŸ²</button>
                    </div>
                    <small class="hint">Cartones disponibles: 1-300</small>
                    <div id="selected-list" class="chips-container">
                        <span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>
                    </div>
                </div>
            </div>
            
            <div id="login-error" class="error-msg"></div>
            
            <button onclick="joinGame()" class="btn-primary btn-glow">
                ğŸ± ENTRAR AL JUEGO
            </button>
            
            <button id="back-to-welcome-btn" onclick="backToWelcomeFromLogin()" class="btn-link" style="display:none;">â† Volver</button>
            <p class="login-footer">Al entrar, aceptas las reglas del juego</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE ESPERA -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="waiting-screen" class="screen">
        <div class="waiting-container glass-card">
            <div class="loader-ring"></div>
            <h2>â³ Esperando AprobaciÃ³n</h2>
            <p>El administrador estÃ¡ revisando tu solicitud...</p>
            <p id="waiting-info" class="waiting-info"></p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE JUEGO -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="game-screen" class="screen">
        <!-- Header -->
        <header class="game-header glass-card">
            <div class="header-left">
                <div class="avatar"><span id="user-initial">?</span></div>
                <div class="user-info">
                    <span id="player-name" class="user-name">Jugador</span>
                    <span class="user-status">ğŸŸ¢ En lÃ­nea</span>
                </div>
                <button onclick="logoutFromGame()" class="btn-logout-game" title="Cerrar sesiÃ³n">ğŸšª</button>
            </div>
            
            <div class="header-center">
                <div class="current-ball">
                    <span class="ball-label">BOLA</span>
                    <span id="current-number" class="ball-number">--</span>
                </div>
            </div>
            
            <div class="header-right">
                <button onclick="showVoiceSettings()" class="btn-logout-game" style="margin-right: 8px;" title="ConfiguraciÃ³n de Voz">ğŸ”Š</button>
                <div class="mode-badge" onclick="showPatternModal()">
                    <span class="mode-label">MODO</span>
                    <span id="mode-display" class="mode-value">LÃNEA</span>
                </div>
            </div>
        </header>

        <!-- Historial de nÃºmeros -->
        <div class="history-bar glass-card">
            <span class="history-label">Ãšltimos:</span>
            <div id="last-numbers" class="history-balls"></div>
            <span id="total-called" class="total-called">0/75</span>
        </div>

        <!-- Ãrea principal: Tablero de nÃºmeros en el centro -->
        <main class="game-main" style="display: block; overflow-y: auto; padding-bottom: 120px; -webkit-overflow-scrolling: touch;">
            <!-- Ãrea de Cartones -->
            <div class="cards-container-full" style="padding: 10px; max-width: 1200px; margin: 0 auto;">
                <div class="cards-header">
                    <h4>ğŸ« Tus Cartones</h4>
                    <span id="cards-count" class="cards-count">0</span>
                </div>
                <div id="cards-container" class="cards-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;"></div>
            </div>
        </main>

        <!-- Barra inferior -->
        <nav class="bottom-nav glass-card">
            <button onclick="showWinnersModal()" class="nav-btn">
                <span class="nav-icon">ğŸ†</span>
                <span class="nav-label">Ganadores</span>
            </button>
            
            <button onclick="toggleChat()" class="nav-btn" style="position: relative;">
                <span class="nav-icon">ğŸ’¬</span>
                <span class="nav-label">Chat</span>
                <div id="chat-badge" class="chat-badge hidden">0</div>
            </button>
            
            <div class="fab-wrapper">
                <button onclick="shoutBingo()" class="btn-bingo pulse" id="bingo-btn">
                    BINGO
                </button>
            </div>
            
            <button onclick="showAchievementsModal()" class="nav-btn">
                <span class="nav-icon">ğŸ…</span>
                <span class="nav-label">Logros</span>
            </button>
            
            <button onclick="showStatsModal()" class="nav-btn">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">Stats</span>
            </button>
        </nav>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MODALES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <!-- Modal de ganadores -->
    <div id="winners-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ† Ganadores Recientes</h3>
                <button onclick="hideModal('winners-modal')" class="btn-close">âœ•</button>
            </div>
            <ul id="winners-list" class="winners-list">
                <li class="empty">No hay ganadores aÃºn</li>
            </ul>
        </div>
    </div>

    <!-- Modal de ConfiguraciÃ³n de Voz -->
    <div id="voice-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ”Š ConfiguraciÃ³n de Voz</h3>
                <button onclick="hideModal('voice-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="voice-settings" style="padding: 1rem;">
                <div class="voice-gender" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem;">GÃ©nero de voz:</label>
                    <div class="gender-buttons" style="display:flex; gap:10px;">
                        <button id="voice-male" class="gender-btn active" onclick="setVoiceGender('male')" style="flex:1; padding:8px;">ğŸ‘¨ Masculino</button>
                        <button id="voice-female" class="gender-btn" onclick="setVoiceGender('female')" style="flex:1; padding:8px;">ğŸ‘© Femenino</button>
                    </div>
                </div>
                <div class="voice-volume" style="margin-bottom: 1.5rem;">
                    <label style="display:block; margin-bottom:0.5rem;">VolÃºmen: <span id="volume-display">80%</span></label>
                    <input type="range" id="voice-volume" min="0" max="100" value="80" oninput="setVoiceVolume(this.value)" style="width:100%;">
                </div>
                <div class="voice-test">
                    <button onclick="testVoice()" class="btn-primary btn-block">ğŸ”Š Probar voz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensaje Privado -->
    <div id="message-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ“¨ Mensaje del Admin</h3>
                <button onclick="hideModal('message-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="message-body" style="padding: 1.5rem; text-align: center;">
                <p id="admin-message-text" style="font-size: 1.2rem; margin-bottom: 1.5rem;"></p>
                <button onclick="hideModal('message-modal')" class="btn-primary btn-block">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Panel de Chat Inmersivo -->
    <div id="chat-panel">
        <div class="chat-header">
                <h3>ğŸ’¬ Chat Global</h3>
                <button onclick="toggleChat()" class="btn-close" style="font-size: 1rem; background:none; border:none; color:white;">â–¼</button>
        </div>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="quick-reactions">
                <button onclick="sendQuickEmoji('ğŸ‘')" class="reaction-btn">ğŸ‘</button>
                <button onclick="sendQuickEmoji('â¤ï¸')" class="reaction-btn">â¤ï¸</button>
                <button onclick="sendQuickEmoji('ğŸ˜‚')" class="reaction-btn">ğŸ˜‚</button>
                <button onclick="sendQuickEmoji('ğŸ˜®')" class="reaction-btn">ğŸ˜®</button>
                <button onclick="sendQuickEmoji('ğŸ‰')" class="reaction-btn">ğŸ‰</button>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." maxlength="100" autocomplete="off">
                <button onclick="sendChatMessage()" class="btn-primary" style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center;">â¤</button>
            </div>
    </div>

    <!-- Modal de patrÃ³n -->
    <div id="pattern-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ¯ PatrÃ³n Actual</h3>
                <button onclick="hideModal('pattern-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="pattern-display">
                <h4 id="pattern-name">LÃNEA</h4>
                <div id="pattern-grid" class="pattern-grid"></div>
                <p id="pattern-description" class="pattern-desc"></p>
            </div>
        </div>
    </div>

    <!-- Modal de estadÃ­sticas -->
    <div id="stats-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ“Š Mis EstadÃ­sticas</h3>
                <button onclick="hideModal('stats-modal')" class="btn-close">âœ•</button>
            </div>
            <div id="stats-content" class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="stat-games">0</span>
                    <span class="stat-label">Partidas</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-wins">0</span>
                    <span class="stat-label">Victorias</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-rate">0%</span>
                    <span class="stat-label">Win Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-level">1</span>
                    <span class="stat-label">Nivel</span>
                </div>
            </div>
            <div class="stats-achievements-preview" id="stats-achievements-preview"></div>
        </div>
    </div>

    <!-- Modal de logros -->
    <div id="achievements-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up modal-large">
            <div class="modal-header">
                <h3>ğŸ… Todos los Logros</h3>
                <button onclick="hideModal('achievements-modal')" class="btn-close">âœ•</button>
            </div>
            <div id="achievements-grid" class="achievements-grid"></div>
        </div>
    </div>

    <!-- Toast para logros desbloqueados -->
    <div id="achievement-toast" class="achievement-toast hidden">
        <span class="toast-icon">ğŸ†</span>
        <div>
            <strong>Â¡Logro desbloqueado!</strong>
            <span id="achievement-toast-name"></span>
        </div>
    </div>

    <!-- Overlay de victoria -->
    <div id="winner-overlay" class="overlay hidden">
        <div class="winner-celebration">
            <div class="trophy-icon">ğŸ†</div>
            <h2 class="winner-title">Â¡BINGO!</h2>
            <h3 id="winner-name" class="winner-name">Jugador</h3>
            <p class="winner-card">CartÃ³n <span id="winner-card-id">#00</span></p>
            <button onclick="hideOverlay()" class="btn-primary">Continuar</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- JAVASCRIPT -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SISTEMA DE AUDIO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        class BingoAudio {
            constructor() {
                this.ctx = null;
                this.enabled = true;
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) { this.enabled = false; }
            }
            
            tone(freq, duration, type = 'sine', vol = 0.3) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }
            
            numberDraw() {
                this.tone(600, 0.1, 'sawtooth', 0.2);
                setTimeout(() => this.tone(500, 0.1, 'sawtooth', 0.2), 50);
                setTimeout(() => this.tone(400, 0.15, 'sawtooth', 0.25), 100);
            }
            
            bingo() {
                this.tone(261.63, 0.8, 'triangle', 0.4);
                setTimeout(() => this.tone(329.63, 0.8, 'triangle', 0.4), 100);
                setTimeout(() => this.tone(392.00, 1.0, 'triangle', 0.4), 200);
                setTimeout(() => this.tone(523.25, 0.3, 'sine', 0.3), 800);
                setTimeout(() => this.tone(659.25, 0.3, 'sine', 0.3), 900);
                setTimeout(() => this.tone(783.99, 0.5, 'sine', 0.3), 1000);
            }
            
            click() { this.tone(800, 0.05, 'square', 0.1); }
            join() {
                this.tone(440, 0.15, 'sine', 0.2);
                setTimeout(() => this.tone(554, 0.15, 'sine', 0.2), 150);
                setTimeout(() => this.tone(659, 0.2, 'sine', 0.2), 300);
            }
        }
        
        const audio = new BingoAudio();

        const ALL_ACHIEVEMENTS = [
            { id: 'Primera Victoria', name: 'Primera Victoria', desc: 'Gana tu primera partida', icon: 'ğŸ¯' },
            { id: 'Veterano', name: 'Veterano', desc: 'Gana 10 partidas', icon: 'âš”ï¸' },
            { id: 'Maestro del Bingo', name: 'Maestro del Bingo', desc: 'Gana 50 partidas', icon: 'ğŸ‘‘' },
            { id: 'Leyenda', name: 'Leyenda', desc: 'Gana 100 partidas', icon: 'ğŸŒŸ' },
            { id: 'Racha de 3', name: 'Racha de 3', desc: 'Gana 3 partidas seguidas', icon: 'ğŸ”¥' },
            { id: 'Imparable', name: 'Imparable', desc: 'Gana 5 partidas seguidas', icon: 'ğŸ’ª' },
            { id: 'Invencible', name: 'Invencible', desc: 'Gana 10 partidas seguidas', icon: 'ğŸ›¡ï¸' },
            { id: 'Blackout', name: 'Blackout', desc: 'Gana con cartÃ³n lleno', icon: 'ğŸ±' },
            { id: 'CorazÃ³n de Oro', name: 'CorazÃ³n de Oro', desc: 'Gana con patrÃ³n corazÃ³n', icon: 'ğŸ’›' },
            { id: 'Estrella Brillante', name: 'Estrella Brillante', desc: 'Gana con patrÃ³n estrella', icon: 'â­' },
            { id: 'Velocista', name: 'Velocista', desc: 'Gana con 15 nÃºmeros o menos', icon: 'âš¡' },
            { id: 'Rayo', name: 'Rayo', desc: 'Gana con 10 nÃºmeros o menos', icon: 'ğŸŒ©ï¸' }
        ];

        const socket = io();
        let myCards = [];
        let selectedIds = [];
        let currentPattern = 'line';
        let patterns = {};
        let playerSession = null;
        let unreadChatCount = 0;
        
        const WINNING_PATTERNS = {
            'line': [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], // Cols
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], // Rows
                [0,6,12,18,24], [4,8,12,16,20] // Diagonals
            ],
            'full': [[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]],
            'corners': [[0,4,20,24]],
            'x': [[0,6,12,18,24], [4,8,12,16,20]]
        };

        function loadSession() {
            const saved = localStorage.getItem('bingo_session');
            if (saved) {
                try { return JSON.parse(saved); } catch(e) { localStorage.removeItem('bingo_session'); }
            }
            return null;
        }
        function saveSession(data) {
            playerSession = data;
            localStorage.setItem('bingo_session', JSON.stringify(data));
        }
        function clearSession() {
            const logged = playerSession?.loggedIn ? { loggedIn: true, username: playerSession.username } : null;
            playerSession = logged;
            if (logged) localStorage.setItem('bingo_session', JSON.stringify(logged));
            else localStorage.removeItem('bingo_session');
        }
        function clearSessionFull() {
            playerSession = null;
            localStorage.removeItem('bingo_session');
        }

        function enterAsGuest() {
            saveSession({ guest: true });
            showScreen('login-screen');
            document.getElementById('back-to-welcome-btn').style.display = 'block';
            // Generar nombre temporal para invitado
            const tempName = `Invitado-${Math.floor(Math.random() * 900) + 100}`;
            document.getElementById('username').value = tempName;
            document.getElementById('username').readOnly = false;
        }
        function showAuthScreen() {
            showScreen('auth-screen');
            switchAuthTab('login');
        }
        function backToWelcome() {
            showScreen('welcome-screen');
        }
        function backToWelcomeFromLogin() {
            clearSessionFull();
            showScreen('welcome-screen');
            document.getElementById('back-to-welcome-btn').style.display = 'none';
            // Restaurar estado de invitado
            document.getElementById('username').value = '';
            document.getElementById('username').readOnly = false;
        }
        
        function logoutFromGame() {
            if (!confirm('Â¿Salir de la partida y cerrar sesiÃ³n?')) return;
            clearSessionFull();
            myCards = [];
            selectedIds = [];
            document.getElementById('selected-list').innerHTML = '<span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>';
            document.getElementById('username').value = '';
            document.getElementById('username').readOnly = false;
            document.getElementById('back-to-welcome-btn').style.display = 'none';
            showScreen('welcome-screen');
        }
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.getElementById('auth-login').classList.toggle('hidden', tab !== 'login');
            document.getElementById('auth-register').classList.toggle('hidden', tab !== 'register');
            document.getElementById('auth-error').textContent = '';
            document.getElementById('reg-error').textContent = '';
        }
        async function doLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const err = document.getElementById('auth-error');
            if (!username || !password) { err.textContent = 'Completa todos los campos'; return; }
            try {
                const r = await fetch('/api/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const d = await r.json();
                if (!d.success) { err.textContent = d.error || 'Error'; return; }
                saveSession({ loggedIn: true, username: d.username });
                document.getElementById('username').value = d.username;
                document.getElementById('username').readOnly = true;
                showScreen('login-screen');
                document.getElementById('back-to-welcome-btn').style.display = 'block';
            } catch (e) { err.textContent = 'Error de conexiÃ³n'; }
        }
        async function doRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const err = document.getElementById('reg-error');
            if (!username || !password) { err.textContent = 'Completa todos los campos'; return; }
            if (password.length < 4) { err.textContent = 'ContraseÃ±a mÃ­nimo 4 caracteres'; return; }
            try {
                const r = await fetch('/api/register', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const d = await r.json();
                if (!d.success) { err.textContent = d.error || 'Error'; return; }
                err.textContent = ''; err.style.color = 'var(--success)';
                err.textContent = 'Â¡Cuenta creada! Inicia sesiÃ³n.';
                switchAuthTab('login');
                document.getElementById('auth-username').value = username;
            } catch (e) { err.textContent = 'Error de conexiÃ³n'; }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: PANTALLAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        function hideOverlay() { document.getElementById('winner-overlay').classList.add('hidden'); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: SELECTOR DE CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderChips() {
            const container = document.getElementById('selected-list');
            if (selectedIds.length === 0) {
                container.innerHTML = '<span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>';
                return;
            }
            container.innerHTML = selectedIds.map(id => 
                `<div class="chip"><span>#${id}</span><button onclick="removeCard(${id})">Ã—</button></div>`
            ).join('');
        }
        
        function addCardToSelection(id) {
            id = parseInt(id);
            if (isNaN(id) || id < 1 || id > 300) {
                showError('NÃºmero debe estar entre 1 y 300');
                return;
            }
            if (selectedIds.includes(id)) {
                showError('Ya seleccionaste este cartÃ³n');
                return;
            }
            selectedIds.push(id);
            renderChips();
            audio.click();
        }
        
        function removeCard(id) {
            selectedIds = selectedIds.filter(x => x !== id);
            renderChips();
        }
        
        function addManualCard() {
            const input = document.getElementById('manual-input');
            addCardToSelection(input.value);
            input.value = '';
            input.focus();
        }
        
        function addRandomCard() {
            let rand, safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (selectedIds.includes(rand) && safety < 500);
            addCardToSelection(rand);
        }
        
        function showError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: UNIRSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function joinGame() {
            const username = document.getElementById('username').value.trim();
            if (!username) return showError('Escribe tu nombre');
            if (selectedIds.length === 0) return showError('Selecciona al menos un cartÃ³n');
            
            socket.emit('join_game', { username, cardIds: selectedIds });
            
            document.getElementById('waiting-info').textContent = 
                `${username} - ${selectedIds.length} cartÃ³n(es)`;
            showScreen('waiting-screen');
        }
        
        function goToAdmin() {
            window.location.href = '/admin-login.html';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: GRITAR BINGO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function shoutBingo() {
            socket.emit('bingo_shout');
            audio.click();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SISTEMA DE VOZ PARA JUGADORES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let voiceSettings = {
            gender: 'male',
            volume: 0.8
        };

        function setVoiceGender(gender) {
            voiceSettings.gender = gender;
            document.getElementById('voice-male').classList.toggle('active', gender === 'male');
            document.getElementById('voice-female').classList.toggle('active', gender === 'female');
        }

        function setVoiceVolume(value) {
            voiceSettings.volume = value / 100;
            document.getElementById('volume-display').textContent = `${value}%`;
        }

        function testVoice() {
            const msg = `Â¡NÃºmero ${Math.floor(Math.random() * 75) + 1}!`;
            speakNumber(msg);
        }

        function speakNumber(text) {
            if (!('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = voiceSettings.volume;
            
            // Seleccionar voz segÃºn gÃ©nero
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => 
                (voiceSettings.gender === 'male' && /male|man|espaÃ±ol.*mexicano/i.test(v.name)) ||
                (voiceSettings.gender === 'female' && /female|woman|espaÃ±ol.*mexicano/i.test(v.name))
            ) || voices.find(v => /espaÃ±ol/i.test(v.lang)) || voices[0];
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.rate = 1.0;
            utterance.pitch = voiceSettings.gender === 'male' ? 0.8 : 1.2;
            
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Escuchar eventos de nÃºmeros llamados para anunciarlos
        socket.on('number_called', (data) => {
            // PequeÃ±o delay para asegurar que el nÃºmero estÃ© visible
            setTimeout(() => {
                const letter = getLetterForNumber(data.num);
                const msg = `Â¡NÃºmero ${letter} ${data.num}!`;
                speakNumber(msg);
            }, 500);
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: RENDERIZAR CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderCards(cards) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-${card.id}`;
                
                cardEl.innerHTML = `
                    <div class="proximity-badge">ğŸ”¥ Falta 1</div>
                    <div class="card-header">
                        <span class="card-title">CartÃ³n #${card.id}</span>
                        <button class="btn-download" onclick="downloadCard(${card.id})" title="Descargar">â¬‡ï¸</button>
                    </div>
                    <div class="card-grid">
                        ${['B','I','N','G','O'].map(l => 
                            `<div class="grid-header col-${l}">${l}</div>`
                        ).join('')}
                        ${[0,1,2,3,4].map(row => 
                            ['B','I','N','G','O'].map(col => {
                                const val = card[col][row];
                                const isFree = val === "FREE";
                                const id = isFree ? '' : `id="c${card.id}-n${val}"`;
                                return `<div class="grid-cell ${isFree ? 'marked free' : ''}" ${id}>${isFree ? 'â˜…' : val}</div>`;
                            }).join('')
                        ).join('')}
                    </div>
                `;
                
                container.appendChild(cardEl);
                checkCardProximity(card);
            });
            
            // Actualizar contador de cartones
            document.getElementById('cards-count').textContent = cards.length;
        }
        
        function toggleCell(el) {
            if (el.classList.contains('free')) return;
            
            // AnimaciÃ³n y marcado visual
            el.classList.remove('pop-anim');
            void el.offsetWidth; // Trigger reflow
            el.classList.add('pop-anim');
            el.classList.toggle('marked');
            
            if (el.classList.contains('marked')) audio.click();
        }
        
        function markNumber(num, shouldAnimate = false) {
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${num}`);
                if (el) {
                    if (shouldAnimate) {
                        el.classList.remove('pop-anim');
                        void el.offsetWidth; // Trigger reflow
                        el.classList.add('pop-anim');
                    }
                    if (!el.classList.contains('marked')) el.classList.add('marked');
                    checkCardProximity(card);
                }
            });
        }
        
        function checkCardProximity(card) {
            const cardEl = document.getElementById(`card-${card.id}`);
            if (!cardEl) return;

            const flatValues = [...card.B, ...card.I, ...card.N, ...card.G, ...card.O];
            let sets = WINNING_PATTERNS[currentPattern];
            
            // Fallback para patrones dinÃ¡micos o no definidos en WINNING_PATTERNS
            if (!sets && patterns[currentPattern]?.positions) {
                 sets = [patterns[currentPattern].positions];
            }
            
            if (!sets) {
                cardEl.classList.remove('near-win');
                return;
            }

            let isNearWin = false;
            for (const set of sets) {
                let missing = 0;
                for (const idx of set) {
                    const val = flatValues[idx];
                    if (val === "FREE") continue;
                    const cell = document.getElementById(`c${card.id}-n${val}`);
                    if (!cell || !cell.classList.contains('marked')) missing++;
                    if (missing > 1) break;
                }
                if (missing === 1) { isNearWin = true; break; }
            }

            if (isNearWin) cardEl.classList.add('near-win');
            else cardEl.classList.remove('near-win');
        }
        
        function updateLastNumbers(arr) {
            document.getElementById('last-numbers').innerHTML = 
                arr.map(n => `<div class="history-ball">${n}</div>`).join('');
        }
        
        function updateTotalCalled(total) {
            document.getElementById('total-called').textContent = `${total}/75`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODALES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showVoiceSettings() {
            showModal('voice-modal');
        }

        function showPatternModal() {
            const pattern = patterns[currentPattern];
            document.getElementById('pattern-name').textContent = pattern?.name || currentPattern;
            document.getElementById('pattern-description').textContent = pattern?.description || '';
            
            const grid = document.getElementById('pattern-grid');
            // Usar la misma funciÃ³n estandarizada que el admin
            grid.innerHTML = renderPatternGrid(pattern?.positions || []);
            
            showModal('pattern-modal');
        }
        
        /**
         * Convierte Ã­ndice display (row-major) a flatCard (column-major). Igual que servidor checkWin.
         */
        function displayToFlatIdx(i) {
            const row = Math.floor(i / 5), col = i % 5;
            return col * 5 + row;
        }
        
        /**
         * Renderiza patrÃ³n. positions usa Ã­ndices flatCard (igual que checkWin en servidor).
         */
        function renderPatternGrid(positions) {
            if (!positions || !Array.isArray(positions)) return '';
            const flatPos = positions.length > 0 && Array.isArray(positions[0])
                ? positions[0]
                : positions;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);
            
            let html = '';
            for (let i = 0; i < 25; i++) {
                const flatIdx = displayToFlatIdx(i);
                const isActive = flatSet.has(flatIdx);
                const isFree = flatIdx === 12;
                html += `<div class="pattern-cell ${isActive ? 'active' : ''} ${isFree ? 'free' : ''}">${isFree ? 'â˜…' : ''}</div>`;
            }
            return html;
        }
        
        // FunciÃ³n auxiliar para verificar si un Ã­ndice estÃ¡ en el patrÃ³n
        function isPatternCell(displayIdx, patternType) {
            const pattern = patterns[patternType];
            if (!pattern?.positions) return false;
            const flatIdx = displayToFlatIdx ? displayToFlatIdx(displayIdx) : (displayIdx % 5) * 5 + Math.floor(displayIdx / 5);
            const pos = pattern.positions;
            const flatPos = pos.length > 0 && Array.isArray(pos[0]) ? pos[0] : pos;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);
            return flatSet.has(flatIdx);
        }
        
        function showWinnersModal() {
            showModal('winners-modal');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHAT GLOBAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                unreadChatCount = 0;
                document.getElementById('chat-badge').classList.add('hidden');
                scrollToBottomChat();
                setTimeout(() => document.getElementById('chat-input').focus(), 100);
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                socket.emit('send_chat', text);
                input.value = '';
                input.focus();
            }
        }

        function sendQuickEmoji(emoji) {
            socket.emit('send_chat', emoji);
            document.getElementById('chat-input').focus();
        }

        function appendChatMessage(data) {
            const container = document.getElementById('chat-messages');
            const isMine = data.user === playerSession?.username;
            const isAdmin = data.isAdmin;
            
            const div = document.createElement('div');
            div.className = `chat-bubble ${isAdmin ? 'admin' : (isMine ? 'mine' : 'others')}`;
            div.innerHTML = `
                ${!isMine ? `<span class="sender">${data.user}</span>` : ''}
                ${data.text}
                <span class="time">${data.time}</span>
            `;
            container.appendChild(div);
            
            // OPTIMIZACIÃ“N: Mantener solo los Ãºltimos 15 mensajes
            while (container.children.length > 15) {
                container.removeChild(container.firstChild);
            }
            
            scrollToBottomChat();
        }

        function scrollToBottomChat() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }
        
        async function showStatsModal() {
            showModal('stats-modal');
            const username = playerSession?.username;
            if (!username) {
                document.getElementById('stat-games').textContent = '0';
                document.getElementById('stat-wins').textContent = '0';
                document.getElementById('stat-rate').textContent = '0%';
                document.getElementById('stat-level').textContent = '1';
                document.getElementById('stats-achievements-preview').innerHTML = '<p class="stats-hint">Entra al juego para ver tus estadÃ­sticas</p>';
                return;
            }
            try {
                const r = await fetch('/api/stats/' + encodeURIComponent(username));
                const d = await r.json();
                if (d.stats) {
                    document.getElementById('stat-games').textContent = d.stats.totalGames || 0;
                    document.getElementById('stat-wins').textContent = d.stats.wins || 0;
                    document.getElementById('stat-rate').textContent = `${Math.round(d.stats.winRate || 0)}%`;
                }
                if (d.level) document.getElementById('stat-level').textContent = d.level.current || 1;
                const ach = d.achievements || [];
                const preview = ach.slice(0, 6).map(a => `<span class="ach-badge" title="${a.name}">${ALL_ACHIEVEMENTS.find(x=>x.name===a.name)?.icon||'ğŸ…'} ${a.name}</span>`).join('');
                document.getElementById('stats-achievements-preview').innerHTML = preview ? `<div class="ach-preview">${preview}</div><button onclick="showAchievementsModal(); hideModal('stats-modal');" class="btn-link">Ver todos los logros â†’</button>` : '<p class="stats-hint">Sin logros aÃºn</p>';
            } catch (e) {
                document.getElementById('stats-achievements-preview').innerHTML = '<p class="stats-hint">No se pudieron cargar</p>';
            }
        }
        
        async function showAchievementsModal() {
            showModal('achievements-modal');
            const grid = document.getElementById('achievements-grid');
            const username = playerSession?.username;
            let achieved = [];
            if (username) {
                try {
                    const r = await fetch('/api/stats/' + encodeURIComponent(username));
                    const d = await r.json();
                    achieved = (d.achievements || []).map(a => a.name);
                } catch (e) {}
            }
            grid.innerHTML = ALL_ACHIEVEMENTS.map(a => {
                const unlocked = achieved.includes(a.name);
                return `<div class="achievement-item ${unlocked ? 'unlocked' : 'locked'}">
                    <span class="ach-icon">${a.icon}</span>
                    <div>
                        <strong>${a.name}</strong>
                        <p>${a.desc}</p>
                        ${unlocked ? '<span class="ach-status">âœ“ Desbloqueado</span>' : '<span class="ach-status locked">Bloqueado</span>'}
                    </div>
                </div>`;
            }).join('');
        }
        
        function showAchievementToast(name) {
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-toast-name').textContent = name;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
        
        function updateWinnersList(winners) {
            const list = document.getElementById('winners-list');
            if (!winners?.length) {
                list.innerHTML = '<li class="empty">No hay ganadores aÃºn</li>';
                return;
            }
            list.innerHTML = winners.map(w => 
                `<li><span class="winner-user">ğŸ† ${w.user}</span><span class="winner-info">#${w.card} - ${w.time}</span></li>`
            ).join('');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DESCARGA DE CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function downloadCard(cardId) {
            const el = document.getElementById(`card-${cardId}`);
            if (!el) return;
            
            const btn = el.querySelector('.btn-download');
            if (btn) btn.style.display = 'none';
            
            try {
                const canvas = await html2canvas(el, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });
                
                const link = document.createElement('a');
                link.download = `Bingo-Carton-${cardId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error('Error descargando:', e);
            }
            
            if (btn) btn.style.display = '';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOCKET EVENTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        socket.on('connect', () => {
            // Re-identificarse al reconectar para poder enviar mensajes
            if (playerSession?.username && playerSession?.cardIds) {
                socket.emit('reconnect_player', { 
                    username: playerSession.username, 
                    cardIds: playerSession.cardIds 
                });
            }
        });

        socket.on('sync_state', (state) => {
            document.getElementById('announcement-text').textContent = state.message;
            currentPattern = state.pattern;
            
            // Sincronizar patrones recibidos del servidor (fuente de verdad)
            if (state.patterns && state.patterns.length > 0) {
                patterns = {}; // Limpiar patrones anteriores
                state.patterns.forEach(p => {
                    patterns[p.id] = {
                        name: p.name,
                        description: p.description || '',
                        positions: p.positions || []
                    };
                });
                console.log('âœ… Patrones sincronizados desde servidor:', Object.keys(patterns).length);
            }
            
            const patternInfo = patterns[state.pattern];
            document.getElementById('mode-display').textContent = patternInfo?.name || state.pattern;
            
            updateWinnersList(state.last5Winners);
            updateLastNumbers(state.last5Numbers);
            state.calledNumbers.forEach(n => markNumber(n, false));
            updateTotalCalled(state.calledNumbers.length);
            myCards.forEach(checkCardProximity);
        });
        
        socket.on('waiting_approval', (data) => {
            document.getElementById('waiting-info').textContent = data.message;
        });
        
        socket.on('join_error', (data) => {
            showScreen('login-screen');
            showError(data.message);
        });
        
        socket.on('player_accepted', () => {
            audio.join();
        });
        
        socket.on('player_rejected', (data) => {
            showScreen('login-screen');
            showError(data.message || 'Solicitud rechazada');
        });
        
        socket.on('init_cards', (data) => {
            myCards = data.cards;
            const username = document.getElementById('username').value.trim();
            
            saveSession({
                ...playerSession,
                username,
                cardIds: [...selectedIds],
                status: 'approved'
            });
            
            document.getElementById('player-name').textContent = username;
            document.getElementById('user-initial').textContent = username.charAt(0).toUpperCase();
            
            renderCards(data.cards);
            showScreen('game-screen');
        });
        
        socket.on('number_called', (data) => {
            audio.numberDraw();
            
            const ball = document.getElementById('current-number');
            ball.classList.add('animate');
            ball.textContent = data.num;
            setTimeout(() => ball.classList.remove('animate'), 300);
            
            markNumber(data.num, true);
            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);
            
            if (navigator.vibrate) navigator.vibrate(50);
        });
        
        socket.on('number_undone', (data) => {
            document.getElementById('current-number').textContent = 
                data.calledNumbers.length > 0 ? data.calledNumbers[data.calledNumbers.length - 1] : '--';
            
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${data.number}`);
                if (el) el.classList.remove('marked');
            });
            myCards.forEach(checkCardProximity);
            
            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);
        });
        
        socket.on('pattern_changed', (data) => {
            currentPattern = data.type;
            
            // Actualizar informaciÃ³n del patrÃ³n desde el servidor (fuente de verdad)
            if (!patterns[data.type]) {
                patterns[data.type] = {};
            }
            patterns[data.type].name = data.name;
            patterns[data.type].description = data.description || '';
            if (data.positions !== undefined) {
                patterns[data.type].positions = data.positions;
            }
            
            const patternInfo = patterns[data.type] || { name: data.name };
            document.getElementById('mode-display').textContent = patternInfo.name || data.type;
            
            // Actualizar visualizaciÃ³n del patrÃ³n en el modal si estÃ¡ abierto
            // Usar la funciÃ³n estandarizada para asegurar consistencia
            if (!document.getElementById('pattern-modal').classList.contains('hidden')) {
                const pattern = patterns[currentPattern];
                const grid = document.getElementById('pattern-grid');
                grid.innerHTML = renderPatternGrid(pattern?.positions || []);
            }
            myCards.forEach(checkCardProximity);
        });
        
        socket.on('message_updated', (msg) => {
            document.getElementById('announcement-text').textContent = msg;
        });
        
        socket.on('winner_announced', (data) => {
            document.getElementById('winner-name').textContent = data.user;
            document.getElementById('winner-card-id').textContent = `#${data.card}`;
            document.getElementById('winner-overlay').classList.remove('hidden');
            
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        });
        
        socket.on('bingo_audio', () => {
            audio.bingo();
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });
        
        socket.on('bingo_celebration', (data) => {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
        });
        
        socket.on('update_history', updateWinnersList);
        
        socket.on('invalid_bingo', () => {
            const btn = document.getElementById('bingo-btn');
            btn.style.background = '#ef4444';
            btn.textContent = 'âŒ';
            setTimeout(() => {
                btn.style.background = '';
                btn.textContent = 'BINGO';
            }, 1000);
        });
        
        socket.on('game_reset', () => {
            document.querySelectorAll('.grid-cell').forEach(c => {
                if (!c.classList.contains('free')) c.classList.remove('marked');
            });
            document.getElementById('current-number').textContent = '--';
            document.getElementById('winner-overlay').classList.add('hidden');
            updateLastNumbers([]);
            updateTotalCalled(0);
        });
        
        socket.on('full_reset', () => {
            const wasLoggedIn = playerSession?.loggedIn;
            const savedUsername = playerSession?.username;
            clearSession();
            myCards = [];
            selectedIds = [];
            document.getElementById('selected-list').innerHTML = '<span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>';
            if (wasLoggedIn && savedUsername) {
                document.getElementById('username').value = savedUsername;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                showScreen('login-screen');
            } else {
                showScreen('welcome-screen');
            }
        });
        
        socket.on('kicked', () => {
            clearSession();
            alert('Has sido expulsado del juego');
            location.reload();
        });
        
        socket.on('reconnection_success', (data) => {
            myCards = data.cards;
            document.getElementById('player-name').textContent = playerSession.username;
            document.getElementById('user-initial').textContent = playerSession.username.charAt(0).toUpperCase();
            renderCards(data.cards);
            showScreen('game-screen');
            audio.join();
        });
        
        socket.on('reconnection_failed', () => {
            clearSession();
            if (playerSession?.loggedIn && playerSession?.username) {
                document.getElementById('username').value = playerSession.username;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
            }
            showScreen('login-screen');
        });
        
        socket.on('player_stats', (data) => {
            if (data.stats) {
                document.getElementById('stat-games').textContent = data.stats.totalGames || 0;
                document.getElementById('stat-wins').textContent = data.stats.wins || 0;
                document.getElementById('stat-rate').textContent = `${Math.round(data.stats.winRate || 0)}%`;
            }
            if (data.level) {
                document.getElementById('stat-level').textContent = data.level.current || 1;
            }
        });

        socket.on('achievement_unlocked', (data) => {
            if (data?.name) showAchievementToast(data.name);
        });
        
        socket.on('private_message', (data) => {
            document.getElementById('admin-message-text').textContent = data.message;
            showModal('message-modal');
            if (audio && audio.join) audio.join();
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        });
        
        socket.on('chat_message', (data) => {
            appendChatMessage(data);
            const panel = document.getElementById('chat-panel');
            if (!panel.classList.contains('open')) {
                unreadChatCount++;
                const badge = document.getElementById('chat-badge');
                badge.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
                badge.classList.remove('hidden');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.addEventListener('load', async () => {
            const session = loadSession();
            playerSession = session;
            
            if (session?.status === 'approved') {
                socket.emit('reconnect_player', { username: session.username, cardIds: session.cardIds });
                showScreen('waiting-screen');
                document.getElementById('waiting-info').textContent = 'Reconectando...';
                setTimeout(() => {
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        const wasLoggedIn = playerSession?.loggedIn;
                        const savedUsername = playerSession?.username;
                        clearSession();
                        if (wasLoggedIn && savedUsername) {
                            document.getElementById('username').value = savedUsername;
                            document.getElementById('username').readOnly = true;
                            document.getElementById('back-to-welcome-btn').style.display = 'block';
                        }
                        showScreen('login-screen');
                    }
                }, 5000);
                return;
            }
            
            if (session?.guest) {
                showScreen('login-screen');
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                document.getElementById('username').readOnly = false;
                return;
            }
            
            if (session?.loggedIn && session?.username) {
                document.getElementById('username').value = session.username;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                showScreen('login-screen');
                try {
                    const r = await fetch('/api/active-game/' + encodeURIComponent(session.username));
                    const d = await r.json();
                    if (d.hasGame && d.cardIds?.length > 0) {
                        socket.emit('reconnect_player', { username: session.username, cardIds: d.cardIds });
                        showScreen('waiting-screen');
                        document.getElementById('waiting-info').textContent = 'Reconectando...';
                    }
                } catch (e) {}
                return;
            }
            
            showScreen('welcome-screen');
        });
        
        // Enter para agregar cartÃ³n
        document.getElementById('manual-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addManualCard();
        });
        
        // Enter para unirse
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && selectedIds.length > 0) joinGame();
        });

        // Enter para enviar chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
    </script>
</body>
</html>
