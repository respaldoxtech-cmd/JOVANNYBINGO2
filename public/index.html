<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yovanny Bingo - Juega Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="player-app">
    <!-- Marca de agua -->
    <div class="watermark-layer"></div>

    <!-- Ticker de anuncios -->
    <div class="global-announcement">
        <div class="marquee-content">
            <span class="announce-icon">ğŸ”´ EN VIVO:</span>
            <span id="announcement-text">BIENVENIDOS AL BINGO YOVANNY - ESPERANDO INICIO DEL JUEGO...</span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE LOGIN -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="login-screen" class="screen active">
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">âš™ï¸</button>
        
        <div class="login-container glass-card">
            <div class="brand-area">
                <img src="logo.svg" alt="Yovanny Bingo" class="brand-logo">
                <h1 class="brand-title">BINGO YOVANNY</h1>
                <p class="brand-subtitle">Â¡La suerte estÃ¡ de tu lado!</p>
            </div>
            
            <div class="form-group">
                <label>ğŸ‘¤ Tu nombre</label>
                <input type="text" id="username" placeholder="Escribe tu apodo..." maxlength="20" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label>ğŸ« Selecciona tus cartones</label>
                <div class="card-picker">
                    <div class="picker-controls">
                        <input type="number" id="manual-input" placeholder="#" min="1" max="300">
                        <button onclick="addManualCard()" class="btn-add" title="Agregar">â•</button>
                        <button onclick="addRandomCard()" class="btn-random" title="Aleatorio">ğŸ²</button>
                    </div>
                    <small class="hint">Cartones disponibles: 1-300</small>
                    <div id="selected-list" class="chips-container">
                        <span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>
                    </div>
                </div>
            </div>
            
            <div id="login-error" class="error-msg"></div>
            
            <button onclick="joinGame()" class="btn-primary btn-glow">
                ğŸ± ENTRAR AL JUEGO
            </button>
            
            <p class="login-footer">Al entrar, aceptas las reglas del juego</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE ESPERA -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="waiting-screen" class="screen">
        <div class="waiting-container glass-card">
            <div class="loader-ring"></div>
            <h2>â³ Esperando AprobaciÃ³n</h2>
            <p>El administrador estÃ¡ revisando tu solicitud...</p>
            <p id="waiting-info" class="waiting-info"></p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- PANTALLA DE JUEGO -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="game-screen" class="screen">
        <!-- Header -->
        <header class="game-header glass-card">
            <div class="header-left">
                <div class="avatar"><span id="user-initial">?</span></div>
                <div class="user-info">
                    <span id="player-name" class="user-name">Jugador</span>
                    <span class="user-status">ğŸŸ¢ En lÃ­nea</span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="current-ball">
                    <span class="ball-label">BOLA</span>
                    <span id="current-number" class="ball-number">--</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="mode-badge" onclick="showPatternModal()">
                    <span class="mode-label">MODO</span>
                    <span id="mode-display" class="mode-value">LÃNEA</span>
                </div>
            </div>
        </header>

        <!-- Historial de nÃºmeros -->
        <div class="history-bar glass-card">
            <span class="history-label">Ãšltimos:</span>
            <div id="last-numbers" class="history-balls"></div>
            <span id="total-called" class="total-called">0/75</span>
        </div>

        <!-- Ãrea de cartones -->
        <main class="cards-area">
            <div id="cards-container" class="cards-grid"></div>
        </main>

        <!-- Barra inferior -->
        <nav class="bottom-nav glass-card">
            <button onclick="showWinnersModal()" class="nav-btn">
                <span class="nav-icon">ğŸ†</span>
                <span class="nav-label">Ganadores</span>
            </button>
            
            <div class="fab-wrapper">
                <button onclick="shoutBingo()" class="btn-bingo pulse" id="bingo-btn">
                    BINGO
                </button>
            </div>
            
            <button onclick="showStatsModal()" class="nav-btn">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">Stats</span>
            </button>
        </nav>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MODALES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <!-- Modal de ganadores -->
    <div id="winners-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ† Ganadores Recientes</h3>
                <button onclick="hideModal('winners-modal')" class="btn-close">âœ•</button>
            </div>
            <ul id="winners-list" class="winners-list">
                <li class="empty">No hay ganadores aÃºn</li>
            </ul>
        </div>
    </div>

    <!-- Modal de patrÃ³n -->
    <div id="pattern-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ¯ PatrÃ³n Actual</h3>
                <button onclick="hideModal('pattern-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="pattern-display">
                <h4 id="pattern-name">LÃNEA</h4>
                <div id="pattern-grid" class="pattern-grid"></div>
                <p id="pattern-description" class="pattern-desc"></p>
            </div>
        </div>
    </div>

    <!-- Modal de estadÃ­sticas -->
    <div id="stats-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>ğŸ“Š Mis EstadÃ­sticas</h3>
                <button onclick="hideModal('stats-modal')" class="btn-close">âœ•</button>
            </div>
            <div id="stats-content" class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="stat-games">0</span>
                    <span class="stat-label">Partidas</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-wins">0</span>
                    <span class="stat-label">Victorias</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-rate">0%</span>
                    <span class="stat-label">Win Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-level">1</span>
                    <span class="stat-label">Nivel</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de victoria -->
    <div id="winner-overlay" class="overlay hidden">
        <div class="winner-celebration">
            <div class="trophy-icon">ğŸ†</div>
            <h2 class="winner-title">Â¡BINGO!</h2>
            <h3 id="winner-name" class="winner-name">Jugador</h3>
            <p class="winner-card">CartÃ³n <span id="winner-card-id">#00</span></p>
            <button onclick="hideOverlay()" class="btn-primary">Continuar</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- JAVASCRIPT -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SISTEMA DE AUDIO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        class BingoAudio {
            constructor() {
                this.ctx = null;
                this.enabled = true;
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) { this.enabled = false; }
            }
            
            tone(freq, duration, type = 'sine', vol = 0.3) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }
            
            numberDraw() {
                this.tone(600, 0.1, 'sawtooth', 0.2);
                setTimeout(() => this.tone(500, 0.1, 'sawtooth', 0.2), 50);
                setTimeout(() => this.tone(400, 0.15, 'sawtooth', 0.25), 100);
            }
            
            bingo() {
                this.tone(261.63, 0.8, 'triangle', 0.4);
                setTimeout(() => this.tone(329.63, 0.8, 'triangle', 0.4), 100);
                setTimeout(() => this.tone(392.00, 1.0, 'triangle', 0.4), 200);
                setTimeout(() => this.tone(523.25, 0.3, 'sine', 0.3), 800);
                setTimeout(() => this.tone(659.25, 0.3, 'sine', 0.3), 900);
                setTimeout(() => this.tone(783.99, 0.5, 'sine', 0.3), 1000);
            }
            
            click() { this.tone(800, 0.05, 'square', 0.1); }
            join() {
                this.tone(440, 0.15, 'sine', 0.2);
                setTimeout(() => this.tone(554, 0.15, 'sine', 0.2), 150);
                setTimeout(() => this.tone(659, 0.2, 'sine', 0.2), 300);
            }
        }
        
        const audio = new BingoAudio();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ESTADO Y CONEXIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const socket = io();
        let myCards = [];
        let selectedIds = [];
        let currentPattern = 'line';
        let patterns = {};
        let playerSession = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SESIÃ“N PERSISTENTE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadSession() {
            const saved = localStorage.getItem('bingo_session');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch(e) {
                    localStorage.removeItem('bingo_session');
                }
            }
            return null;
        }
        
        function saveSession(data) {
            playerSession = data;
            localStorage.setItem('bingo_session', JSON.stringify(data));
        }
        
        function clearSession() {
            playerSession = null;
            localStorage.removeItem('bingo_session');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: PANTALLAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        function hideOverlay() { document.getElementById('winner-overlay').classList.add('hidden'); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: SELECTOR DE CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderChips() {
            const container = document.getElementById('selected-list');
            if (selectedIds.length === 0) {
                container.innerHTML = '<span class="empty-hint">NingÃºn cartÃ³n seleccionado</span>';
                return;
            }
            container.innerHTML = selectedIds.map(id => 
                `<div class="chip"><span>#${id}</span><button onclick="removeCard(${id})">Ã—</button></div>`
            ).join('');
        }
        
        function addCardToSelection(id) {
            id = parseInt(id);
            if (isNaN(id) || id < 1 || id > 300) {
                showError('NÃºmero debe estar entre 1 y 300');
                return;
            }
            if (selectedIds.includes(id)) {
                showError('Ya seleccionaste este cartÃ³n');
                return;
            }
            selectedIds.push(id);
            renderChips();
            audio.click();
        }
        
        function removeCard(id) {
            selectedIds = selectedIds.filter(x => x !== id);
            renderChips();
        }
        
        function addManualCard() {
            const input = document.getElementById('manual-input');
            addCardToSelection(input.value);
            input.value = '';
            input.focus();
        }
        
        function addRandomCard() {
            let rand, safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (selectedIds.includes(rand) && safety < 500);
            addCardToSelection(rand);
        }
        
        function showError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: UNIRSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function joinGame() {
            const username = document.getElementById('username').value.trim();
            if (!username) return showError('Escribe tu nombre');
            if (selectedIds.length === 0) return showError('Selecciona al menos un cartÃ³n');
            
            socket.emit('join_game', { username, cardIds: selectedIds });
            
            document.getElementById('waiting-info').textContent = 
                `${username} - ${selectedIds.length} cartÃ³n(es)`;
            showScreen('waiting-screen');
        }
        
        function goToAdmin() {
            window.location.href = '/admin-login.html';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: GRITAR BINGO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function shoutBingo() {
            socket.emit('bingo_shout');
            audio.click();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JUEGO: RENDERIZAR CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderCards(cards) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-${card.id}`;
                
                cardEl.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">CartÃ³n #${card.id}</span>
                        <button class="btn-download" onclick="downloadCard(${card.id})" title="Descargar">â¬‡ï¸</button>
                    </div>
                    <div class="card-grid">
                        ${['B','I','N','G','O'].map(l => 
                            `<div class="grid-header col-${l}">${l}</div>`
                        ).join('')}
                        ${[0,1,2,3,4].map(row => 
                            ['B','I','N','G','O'].map(col => {
                                const val = card[col][row];
                                const isFree = val === "FREE";
                                const id = isFree ? '' : `id="c${card.id}-n${val}"`;
                                return `<div class="grid-cell ${isFree ? 'marked free' : ''}" ${id}>${isFree ? 'â˜…' : val}</div>`;
                            }).join('')
                        ).join('')}
                    </div>
                `;
                
                container.appendChild(cardEl);
            });
        }
        
        function markNumber(num) {
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${num}`);
                if (el && !el.classList.contains('marked')) {
                    el.classList.add('marked');
                }
            });
        }
        
        function updateLastNumbers(arr) {
            document.getElementById('last-numbers').innerHTML = 
                arr.map(n => `<div class="history-ball">${n}</div>`).join('');
        }
        
        function updateTotalCalled(total) {
            document.getElementById('total-called').textContent = `${total}/75`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODALES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPatternModal() {
            const pattern = patterns[currentPattern];
            document.getElementById('pattern-name').textContent = pattern?.name || currentPattern;
            document.getElementById('pattern-description').textContent = pattern?.description || '';
            
            const grid = document.getElementById('pattern-grid');
            grid.innerHTML = '';
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const idx = col * 5 + row;
                    const isActive = isPatternCell(idx, currentPattern);
                    const isFree = idx === 12;
                    grid.innerHTML += `<div class="pattern-cell ${isActive ? 'active' : ''} ${isFree ? 'free' : ''}">${isFree ? 'â˜…' : ''}</div>`;
                }
            }
            
            showModal('pattern-modal');
        }
        
        function isPatternCell(idx, patternType) {
            const pattern = patterns[patternType];
            if (!pattern?.positions) return false;
            return pattern.positions.some(line => 
                Array.isArray(line) ? line.includes(idx) : line === idx
            );
        }
        
        function showWinnersModal() {
            showModal('winners-modal');
        }
        
        function showStatsModal() {
            socket.emit('get_player_stats', playerSession?.username);
            showModal('stats-modal');
        }
        
        function updateWinnersList(winners) {
            const list = document.getElementById('winners-list');
            if (!winners?.length) {
                list.innerHTML = '<li class="empty">No hay ganadores aÃºn</li>';
                return;
            }
            list.innerHTML = winners.map(w => 
                `<li><span class="winner-user">ğŸ† ${w.user}</span><span class="winner-info">#${w.card} - ${w.time}</span></li>`
            ).join('');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DESCARGA DE CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function downloadCard(cardId) {
            const el = document.getElementById(`card-${cardId}`);
            if (!el) return;
            
            const btn = el.querySelector('.btn-download');
            if (btn) btn.style.display = 'none';
            
            try {
                const canvas = await html2canvas(el, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });
                
                const link = document.createElement('a');
                link.download = `Bingo-Carton-${cardId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error('Error descargando:', e);
            }
            
            if (btn) btn.style.display = '';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOCKET EVENTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        socket.on('sync_state', (state) => {
            document.getElementById('announcement-text').textContent = state.message;
            currentPattern = state.pattern;
            
            if (state.patterns) {
                state.patterns.forEach(p => patterns[p.id] = p);
            }
            
            const patternInfo = patterns[state.pattern];
            document.getElementById('mode-display').textContent = patternInfo?.name || state.pattern;
            
            updateWinnersList(state.last5Winners);
            updateLastNumbers(state.last5Numbers);
            state.calledNumbers.forEach(markNumber);
            updateTotalCalled(state.calledNumbers.length);
        });
        
        socket.on('waiting_approval', (data) => {
            document.getElementById('waiting-info').textContent = data.message;
        });
        
        socket.on('join_error', (data) => {
            showScreen('login-screen');
            showError(data.message);
        });
        
        socket.on('player_accepted', () => {
            audio.join();
        });
        
        socket.on('player_rejected', (data) => {
            showScreen('login-screen');
            showError(data.message || 'Solicitud rechazada');
        });
        
        socket.on('init_cards', (data) => {
            myCards = data.cards;
            const username = document.getElementById('username').value.trim();
            
            saveSession({
                username,
                cardIds: selectedIds,
                status: 'approved'
            });
            
            document.getElementById('player-name').textContent = username;
            document.getElementById('user-initial').textContent = username.charAt(0).toUpperCase();
            
            renderCards(data.cards);
            showScreen('game-screen');
        });
        
        socket.on('number_called', (data) => {
            audio.numberDraw();
            
            const ball = document.getElementById('current-number');
            ball.classList.add('animate');
            ball.textContent = data.num;
            setTimeout(() => ball.classList.remove('animate'), 300);
            
            markNumber(data.num);
            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);
            
            if (navigator.vibrate) navigator.vibrate(50);
        });
        
        socket.on('number_undone', (data) => {
            document.getElementById('current-number').textContent = 
                data.calledNumbers.length > 0 ? data.calledNumbers[data.calledNumbers.length - 1] : '--';
            
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${data.number}`);
                if (el) el.classList.remove('marked');
            });
            
            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);
        });
        
        socket.on('pattern_changed', (data) => {
            currentPattern = data.type;
            const patternInfo = patterns[data.type] || { name: data.name };
            document.getElementById('mode-display').textContent = patternInfo.name || data.type;
        });
        
        socket.on('message_updated', (msg) => {
            document.getElementById('announcement-text').textContent = msg;
        });
        
        socket.on('winner_announced', (data) => {
            document.getElementById('winner-name').textContent = data.user;
            document.getElementById('winner-card-id').textContent = `#${data.card}`;
            document.getElementById('winner-overlay').classList.remove('hidden');
            
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        });
        
        socket.on('bingo_audio', () => {
            audio.bingo();
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });
        
        socket.on('bingo_celebration', (data) => {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
        });
        
        socket.on('update_history', updateWinnersList);
        
        socket.on('invalid_bingo', () => {
            const btn = document.getElementById('bingo-btn');
            btn.style.background = '#ef4444';
            btn.textContent = 'âŒ';
            setTimeout(() => {
                btn.style.background = '';
                btn.textContent = 'BINGO';
            }, 1000);
        });
        
        socket.on('game_reset', () => {
            document.querySelectorAll('.grid-cell').forEach(c => {
                if (!c.classList.contains('free')) c.classList.remove('marked');
            });
            document.getElementById('current-number').textContent = '--';
            document.getElementById('winner-overlay').classList.add('hidden');
            updateLastNumbers([]);
            updateTotalCalled(0);
        });
        
        socket.on('full_reset', () => {
            clearSession();
        });
        
        socket.on('kicked', () => {
            clearSession();
            alert('Has sido expulsado del juego');
            location.reload();
        });
        
        socket.on('reconnection_success', (data) => {
            myCards = data.cards;
            document.getElementById('player-name').textContent = playerSession.username;
            document.getElementById('user-initial').textContent = playerSession.username.charAt(0).toUpperCase();
            renderCards(data.cards);
            showScreen('game-screen');
            audio.join();
        });
        
        socket.on('reconnection_failed', () => {
            clearSession();
            showScreen('login-screen');
        });
        
        socket.on('player_stats', (data) => {
            if (data.stats) {
                document.getElementById('stat-games').textContent = data.stats.totalGames || 0;
                document.getElementById('stat-wins').textContent = data.stats.wins || 0;
                document.getElementById('stat-rate').textContent = `${Math.round(data.stats.winRate || 0)}%`;
            }
            if (data.level) {
                document.getElementById('stat-level').textContent = data.level.current || 1;
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.addEventListener('load', () => {
            const session = loadSession();
            if (session?.status === 'approved') {
                playerSession = session;
                socket.emit('reconnect_player', {
                    username: session.username,
                    cardIds: session.cardIds
                });
                showScreen('waiting-screen');
                document.getElementById('waiting-info').textContent = 'Reconectando...';
                
                setTimeout(() => {
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        clearSession();
                        showScreen('login-screen');
                    }
                }, 5000);
            }
        });
        
        // Enter para agregar cartÃ³n
        document.getElementById('manual-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addManualCard();
        });
        
        // Enter para unirse
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && selectedIds.length > 0) joinGame();
        });
    </script>
</body>
</html>
