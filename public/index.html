<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yovanny Bingo Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="player-app">

    <div class="watermark-layer"></div>

    <div id="login-screen" class="login-wrapper active">
        <!-- Bot√≥n de Admin en esquina superior derecha -->
        <button onclick="goToAdmin()" class="admin-access-btn" title="Panel de Administrador">
            üîß
        </button>
        <div class="login-container glass-effect">
            <div class="brand-area">
                <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
            </div>
            <div class="form-group">
                <label>Nombre de Jugador</label>
                <input type="text" id="username" placeholder="Tu Apodo" autocomplete="off" maxlength="15">
            </div>
            <div class="form-group">
                <label>Selecciona tus Cartones</label>

                <div class="card-picker-ui">
                    <div class="picker-controls">
                        <input type="number" id="manual-input" placeholder="#" min="1" max="300">
                        <button onclick="addManualCard()" class="btn-add">+</button>
                        <button onclick="addRandomCard()" class="btn-random">üé≤</button>
                    </div>
                    <small class="hint-text">Elige del 1 al 300</small>

                    <div id="selected-list" class="chips-container"></div>
                </div>
            </div>
            <div id="login-error" style="color: #ef4444; font-size: 0.9rem; margin-top: 10px; display: none; font-weight: bold;"></div>

            <button onclick="joinGame()" class="btn-primary full-width">INGRESAR A SALA</button>
        </div>
    </div>

    <div class="global-announcement">
        <div class="marquee-content">
            <span class="announce-icon">üî¥ EN VIVO:</span>
            <span id="announcement-text">BIENVENIDOS A LA SALA DE BINGO YOVANNY... ESPERANDO INSTRUCCIONES...</span>
        </div>
    </div>

    <div id="game-screen" class="app-shell hidden">

        <header class="app-header glass-effect">
            <div class="header-left">
                <div class="avatar-circle"><span id="user-initial">Y</span></div>
                <div class="user-meta">
                    <span id="player-name-display" class="user-name">Usuario</span>
                    <span class="user-status">En l√≠nea</span>
                </div>
            </div>
            <div class="header-center">
                <div class="current-ball-display">
                    <div class="ball-label">BOLA</div>
                    <div id="current-number" class="ball-value">--</div>
                </div>
            </div>
            <div class="header-right">
                <div class="mode-badge" onclick="showPatternModal()">
                    <span class="mode-label">MODO</span>
                    <strong id="mode-display">FULL</strong>
                </div>
            </div>
        </header>

        <div class="history-bar">
            <span class="history-label">Yovanny Bingo:</span>
            <div id="player-last-5" class="history-track"></div>
        </div>

        <main class="cards-area">
            <div id="cards-container" class="cards-scroll-view"></div>
        </main>

        <nav class="bottom-nav glass-effect">
            <button onclick="toggleHistory()" class="nav-item">
                <span class="icon">üèÜ</span>
                <span class="label">Ganadores</span>
            </button>
            <div class="fab-container">
                <button onclick="shoutBingo()" class="btn-fab pulse">BINGO</button>
            </div>
            <button onclick="logoutUser()" class="nav-item">
                <span class="icon">üö™</span>
                <span class="label">Salir</span>
            </button>
        </nav>


    </div>

    <div id="history-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up">
            <div class="modal-header">
                <h3>Ganadores Recientes</h3>
                <button onclick="toggleHistory()" class="btn-close">‚úï</button>
            </div>
            <ul id="history-list" class="data-list"></ul>
        </div>
    </div>

    <div id="pattern-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up">
            <div class="modal-header">
                <h3>Figura Actual: <span id="pattern-title"></span></h3>
                <button onclick="hidePatternModal()" class="btn-close">‚úï</button>
            </div>
            <div id="pattern-display" class="pattern-display">
                <!-- Mini bingo card will be inserted here -->
            </div>
        </div>
    </div>

    <div id="winner-overlay" class="fullscreen-overlay hidden">
        <div class="winner-box zoom-in">
            <div class="icon-trophy">üèÜ</div>
            <h2>¬°BINGO!</h2>
            <h3 id="winner-name-announce">Nombre</h3>
            <p>Cart√≥n <span id="winner-card-announce">#00</span></p>
            <button onclick="closeOverlay()" class="btn-primary">Continuar</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myCards = []; // Cartones descargados
        let selectedIds = []; // Cartones seleccionados en el login
        let currentPattern = 'line'; // Patr√≥n actual del juego
        let playerSession = null; // Datos de sesi√≥n persistente

        // Cargar sesi√≥n guardada al iniciar
        function loadSavedSession() {
            const saved = localStorage.getItem('yovanny_bingo_session');
            if (saved) {
                try {
                    playerSession = JSON.parse(saved);
                    console.log('Sesi√≥n guardada encontrada:', playerSession);
                    return playerSession;
                } catch (e) {
                    localStorage.removeItem('yovanny_bingo_session');
                    return null;
                }
            }
            return null;
        }

        // Guardar sesi√≥n actual
        function saveSession(sessionData) {
            playerSession = sessionData;
            localStorage.setItem('yovanny_bingo_session', JSON.stringify(sessionData));
        }

        // Limpiar sesi√≥n
        function clearSession() {
            playerSession = null;
            localStorage.removeItem('yovanny_bingo_session');
        }

        // Intentar reconexi√≥n autom√°tica
        function attemptAutoReconnect() {
            const session = loadSavedSession();
            if (session && session.status === 'approved') {
                console.log('Intentando reconexi√≥n autom√°tica...');

                // Mostrar pantalla de reconexi√≥n
                document.getElementById('login-screen').classList.remove('active');
                setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);

                const reconnectScreen = document.createElement('div');
                reconnectScreen.id = 'reconnect-screen';
                reconnectScreen.className = 'login-wrapper active';
                reconnectScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üîÑ</div>
                        <h2>Reconectando...</h2>
                        <p>Restaurando tu sesi√≥n de juego...</p>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 20px;">
                            Usuario: ${session.username}<br>
                            Cartones: ${session.cardIds.length}
                        </p>
                    </div>
                `;
                document.body.appendChild(reconnectScreen);

                // Intentar reconectar
                socket.emit('reconnect_player', {
                    username: session.username,
                    cardIds: session.cardIds,
                    sessionId: session.sessionId
                });

                // Timeout por si falla la reconexi√≥n
                setTimeout(() => {
                    if (document.getElementById('reconnect-screen')) {
                        document.getElementById('reconnect-screen').remove();
                        document.getElementById('login-screen').classList.add('active');
                        document.getElementById('login-screen').classList.remove('hidden');
                        clearSession();
                        alert('No se pudo reconectar. Por favor inicia sesi√≥n nuevamente.');
                    }
                }, 5000);
            }
        }

        // --- L√ìGICA DEL SELECTOR DE CARTONES ---

        function renderChips() {
            const container = document.getElementById('selected-list');
            container.innerHTML = '';

            if (selectedIds.length === 0) {
                container.innerHTML = '<span style="color:#666; font-size:0.8rem">Ning√∫n cart√≥n seleccionado</span>';
                return;
            }

            selectedIds.forEach(id => {
                const chip = document.createElement('div');
                chip.className = 'card-chip';
                chip.innerHTML = `<span>#${id}</span> <button onclick="removeCard(${id})">√ó</button>`;
                container.appendChild(chip);
            });
        }

        function addCardToSelection(id) {
            id = parseInt(id);
            if (isNaN(id) || id < 1 || id > 300) return alert("El n√∫mero debe estar entre 1 y 300");
            if (selectedIds.includes(id)) return alert("Ya seleccionaste este cart√≥n");

            selectedIds.push(id);
            renderChips();
        }

        function removeCard(id) {
            selectedIds = selectedIds.filter(x => x !== id);
            renderChips();
        }

        function addManualCard() {
            const input = document.getElementById('manual-input');
            addCardToSelection(input.value);
            input.value = '';
            input.focus();
        }

        function addRandomCard() {
            let rand;
            let safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (selectedIds.includes(rand) && safety < 500);

            addCardToSelection(rand);
        }

        // --- L√ìGICA DEL JUEGO ---

        function joinGame() {
            const user = document.getElementById('username').value;
            const errorDiv = document.getElementById('login-error');

            if(!user) {
                errorDiv.innerText = "Escribe tu nombre";
                errorDiv.style.display = 'block';
                return;
            }
            if(selectedIds.length === 0) {
                errorDiv.innerText = "Selecciona al menos un cart√≥n";
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            // Enviamos el array selectedIds directamente
            socket.emit('join_game', { username: user, cardIds: selectedIds });

            // Mostrar pantalla de espera de aprobaci√≥n
            document.getElementById('login-screen').classList.remove('active');
            setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);

            // Crear pantalla de espera
            const waitingScreen = document.createElement('div');
            waitingScreen.id = 'waiting-screen';
            waitingScreen.className = 'login-wrapper active';
            waitingScreen.innerHTML = `
                <div class="login-container glass-effect" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                    <h2>Esperando Aprobaci√≥n</h2>
                    <p>El administrador est√° revisando tu solicitud...</p>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 20px;">
                        Por favor espera mientras el admin aprueba tu ingreso.
                    </p>
                </div>
            `;
            document.body.appendChild(waitingScreen);
        }

        // --- MANEJO DE ERROR: CART√ìN OCUPADO ---
        socket.on('join_error', (data) => {
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                // Mostrar el error en la pantalla de espera
                waitingScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;">‚ùå</div>
                        <h2>Error de Ingreso</h2>
                        <p>${data.message}</p>
                        <button onclick="backToLogin()" class="btn-primary" style="margin-top: 20px;">Volver al Login</button>
                    </div>
                `;
            } else {
                // Fallback: mostrar en la pantalla de login
                const errorDiv = document.getElementById('login-error');
                errorDiv.innerText = data.message;
                errorDiv.style.display = 'block';
                document.querySelector('.login-container').animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
                document.getElementById('login-screen').classList.add('active');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // Mensaje de espera de aprobaci√≥n
        socket.on('waiting_approval', (data) => {
            // La pantalla de espera ya se cre√≥ en joinGame()
            console.log(data.message);
        });

        // Jugador aceptado
        socket.on('player_accepted', () => {
            // Remover pantalla de espera
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                waitingScreen.remove();
            }
            // El init_cards se manejar√° normalmente
        });

        // Jugador rechazado
        socket.on('player_rejected', (data) => {
            // Remover pantalla de espera y mostrar mensaje de rechazo
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) {
                waitingScreen.innerHTML = `
                    <div class="login-container glass-effect" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;">‚ùå</div>
                        <h2>Solicitud Rechazada</h2>
                        <p>${data.message}</p>
                        <button onclick="location.reload()" class="btn-primary" style="margin-top: 20px;">Intentar de Nuevo</button>
                    </div>
                `;
            }
        });

        // Si entra con √©xito, inicializamos la UI
        socket.on('init_cards', ({ cards }) => {
            myCards = cards;
            const user = document.getElementById('username').value;

            // Ocultar login y mostrar juego
            document.getElementById('login-screen').classList.remove('active');
            setTimeout(() => document.getElementById('login-screen').classList.add('hidden'), 300);
            document.getElementById('game-screen').classList.remove('hidden');

            document.getElementById('player-name-display').innerText = user;
            document.getElementById('user-initial').innerText = user.charAt(0).toUpperCase();

            // Renderizar cartones
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-visual-${card.id}`;

                const head = document.createElement('div');
                head.className = 'card-head';
                head.innerHTML = `<span><b>Yovanny Bingo #${card.id}</b></span> <button class='btn-mini-dl' onclick='downloadSingleCard(${card.id})'>‚¨á</button>`;
                cardEl.appendChild(head);

                const grid = document.createElement('div');
                grid.className = 'card-grid disable-clicks';

                ['B','I','N','G','O'].forEach(l => {
                    const cell = document.createElement('div');
                    cell.className = `grid-header col-${l}`;
                    cell.innerText = l;
                    grid.appendChild(cell);
                });

                for(let i=0; i<5; i++) {
                    const row = [card.B[i], card.I[i], card.N[i], card.G[i], card.O[i]];
                    row.forEach(n => {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        if(n === "FREE") {
                            cell.classList.add('marked', 'free');
                            cell.innerHTML = "‚òÖ";
                        } else {
                            cell.innerText = n;
                            cell.id = `c${card.id}-n${n}`;
                        }
                        grid.appendChild(cell);
                    });
                }
                cardEl.appendChild(grid);
                container.appendChild(cardEl);
            });
        });

        socket.on('kicked', () => { alert("Has sido expulsado."); location.reload(); });

        socket.on('sync_state', (s) => {
            document.getElementById('announcement-text').innerText = s.message;
            updateMode(s.pattern);
            updateHistory(s.last5Winners);
            updateLast5(s.last5Numbers);
            s.calledNumbers.forEach(markNumberInAllCards);
        });



        socket.on('number_called', ({ num, last5 }) => {
            const ball = document.getElementById('current-number');
            ball.style.transform = "scale(0.8)";
            setTimeout(() => {
                ball.innerText = num;
                ball.style.transform = "scale(1)";
            }, 150);

            markNumberInAllCards(num);
            updateLast5(last5);
            if(navigator.vibrate) navigator.vibrate(50);

            // Verificar victoria autom√°tica despu√©s de marcar el n√∫mero
            setTimeout(() => {
                checkAutomaticBingo();
            }, 500); // Peque√±o delay para que se vea la animaci√≥n
        });

        socket.on('message_updated', (msg) => document.getElementById('announcement-text').innerText = msg);
        socket.on('pattern_changed', (p) => updateMode(p));
        
        socket.on('winner_announced', (data) => {
            document.getElementById('winner-name-announce').innerText = data.user;
            document.getElementById('winner-card-announce').innerText = `#${data.card}`;
            document.getElementById('winner-overlay').classList.remove('hidden');
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });


        });

        // Celebraci√≥n autom√°tica cuando alguien gana
        socket.on('bingo_celebration', (data) => {
            // Mostrar mensaje de celebraci√≥n en el anuncio
            const originalMessage = document.getElementById('announcement-text').innerText;
            document.getElementById('announcement-text').innerText = data.message;

            // Efectos de celebraci√≥n para todos los jugadores
            if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);

            // Confetti m√°s moderado para otros jugadores
            setTimeout(() => {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
            }, 500);

            // Restaurar mensaje original despu√©s de 10 segundos
            setTimeout(() => {
                document.getElementById('announcement-text').innerText = originalMessage;
            }, 10000);
        });

        socket.on('update_history', (h) => updateHistory(h));
        
        socket.on('invalid_bingo', () => {
            const btn = document.querySelector('.btn-fab');
            btn.style.background = "#ef4444";
            btn.innerText = "Error";
            setTimeout(() => { 
                btn.style.background = ""; 
                btn.innerText = "BINGO"; 
            }, 1000);
        });

        socket.on('game_reset', () => {
            document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('marked'));
            document.getElementById('current-number').innerText = "--";
            document.getElementById('winner-overlay').classList.add('hidden');
            updateLast5([]);
        });

        function markNumberInAllCards(num) {
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${num}`);
                if(el) el.classList.add('marked');
            });
        }

        function updateLast5(arr) {
            document.getElementById('player-last-5').innerHTML = arr.map(n => `<div class="hist-ball">${n}</div>`).join('');
        }
        function updateMode(p) {
            currentPattern = p; // Actualizar patr√≥n actual para bingo autom√°tico
            // Mapeo actualizado de nombres para el usuario
            const map = {
                'line': 'NORMAL (L√çNEA)',
                'full': 'CART√ìN LLENO',
                'corners': '4 ESQUINAS',
                'custom': 'FIGURA MANUAL'
            };
            document.getElementById('mode-display').innerText = map[p] || p;
        }
        function updateHistory(l) {
            document.getElementById('history-list').innerHTML = l.length ? l.map(w => `<li><span class="t-name">${w.user}</span> <span class="t-card">#${w.card}</span></li>`).join('') : '<li class="empty">Lista vac√≠a</li>';
        }

        function toggleHistory() { document.getElementById('history-modal').classList.toggle('hidden'); }
        function shoutBingo() { socket.emit('bingo_shout'); }
        function closeOverlay() { document.getElementById('winner-overlay').classList.add('hidden'); }

        // Funci√≥n para mostrar el modal de patr√≥n
        function showPatternModal() {
            const modal = document.getElementById('pattern-modal');
            const title = document.getElementById('pattern-title');
            const display = document.getElementById('pattern-display');

            // Set title
            const map = {
                'line': 'NORMAL (L√çNEA)',
                'full': 'CART√ìN LLENO',
                'corners': '4 ESQUINAS',
                'custom': 'FIGURA MANUAL'
            };
            title.textContent = map[currentPattern] || currentPattern;

            // Generate mini card
            let html = '<div class="mini-bingo-card">';
            html += '<div class="mini-grid">';
            // Headers B I N G O
            ['B','I','N','G','O'].forEach(l => {
                html += `<div class="mini-header">${l}</div>`;
            });
            // 5x5 grid
            for(let row=0; row<5; row++) {
                for(let col=0; col<5; col++) {
                    const idx = row + col*5;
                    let classes = 'mini-cell';
                    if(isWinningCell(idx, currentPattern)) classes += ' winning';
                    if(idx === 12) classes += ' free';
                    html += `<div class="${classes}">${idx === 12 ? '‚òÖ' : ''}</div>`;
                }
            }
            html += '</div></div>';

            // For line, add explanation
            if(currentPattern === 'line') {
                html += '<p class="pattern-explanation">Gana cualquier l√≠nea: horizontal, vertical o diagonal.</p>';
            } else if(currentPattern === 'custom') {
                html += '<p class="pattern-explanation">El administrador define la figura manualmente.</p>';
            }

            display.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function isWinningCell(idx, pattern) {
            if(pattern === 'full') return true;
            if(pattern === 'corners') {
                const corners = [0, 4, 20, 24];
                return corners.includes(idx);
            }
            if(pattern === 'line') {
                // Highlight an example horizontal line (middle row)
                return idx >= 10 && idx <= 14;
            }
            return false;
        }

        function hidePatternModal() {
            document.getElementById('pattern-modal').classList.add('hidden');
        }

        // Funci√≥n para salir del juego
        function logoutUser() {
            if(confirm("¬øEst√°s seguro de que quieres salir del juego? Perder√°s tu progreso actual.")) {
                // Desconectar del socket
                socket.disconnect();
                // Recargar la p√°gina para volver al login
                location.reload();
            }
        }

        // Funci√≥n para volver al login desde error
        function backToLogin() {
            const waitingScreen = document.getElementById('waiting-screen');
            if(waitingScreen) waitingScreen.remove();
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // Funci√≥n para ir al panel de admin
        function goToAdmin() {
            window.location.href = '/admin-login.html';
        }

        // --- VERIFICACI√ìN AUTOM√ÅTICA DE BINGO ---
        function checkAutomaticBingo() {
            // Solo verificar si tenemos cartones y estamos conectados
            if(!myCards || myCards.length === 0) return;

            // Obtener n√∫meros llamados actuales (de los elementos marcados)
            const calledNumbers = [];
            document.querySelectorAll('.grid-cell.marked').forEach(cell => {
                if(cell.innerText && cell.innerText !== '‚òÖ') {
                    calledNumbers.push(parseInt(cell.innerText));
                }
            });

            // Usar el patr√≥n actual sincronizado desde el servidor
            for(let card of myCards) {
                if(checkCardWin(card, calledNumbers, currentPattern)) {
                    // ¬°BINGO AUTOM√ÅTICO! Emitir el grito autom√°ticamente
                    console.log(`¬°BINGO AUTOM√ÅTICO! Cart√≥n ${card.id} completado con patr√≥n ${currentPattern}`);
                    socket.emit('bingo_shout');
                    return; // Solo el primer cart√≥n que gane
                }
            }
        }

        // Funci√≥n auxiliar para verificar victoria (misma l√≥gica que en el servidor)
        function checkCardWin(card, calledNumbers, pattern) {
            // Aplanar el cart√≥n por columnas: √≠ndices 0-4(B), 5-9(I), 10-14(N), etc.
            // √çndice 12 es el centro (FREE)
            let flatCard = [...card.B, ...card.I, ...card.N, ...card.G, ...card.O];

            // Funci√≥n auxiliar para ver si una celda est√° marcada
            const isMarked = (val) => val === "FREE" || calledNumbers.includes(val);

            // MODO NORMAL (Cualquier L√≠nea: Horizontal, Vertical o Diagonal)
            if (pattern === 'line') {
                const winningLines = [
                    // Columnas (B, I, N, G, O)
                    [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
                    // Filas
                    [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
                    // Diagonales
                    [0,6,12,18,24], [4,8,12,16,20]
                ];
                // Si CUALQUIERA de estas combinaciones est√° completa
                return winningLines.some(line => line.every(idx => isMarked(flatCard[idx])));
            }

            // MODO CART√ìN LLENO (Full House)
            if (pattern === 'full') {
                return flatCard.every(val => isMarked(val));
            }

            // MODO 4 ESQUINAS
            if (pattern === 'corners') {
                const corners = [0, 4, 20, 24];
                return corners.every(idx => isMarked(flatCard[idx]));
            }

            // MODO PERSONALIZADO (Figura manual) - No implementado en cliente por simplicidad
            if (pattern === 'custom') {
                // Para custom necesitar√≠amos sincronizar el patr√≥n desde el servidor
                // Por ahora, asumimos que no hay victoria autom√°tica en modo custom
                return false;
            }

            return false;
        }
        
        // --- FUNCI√ìN DE DESCARGA INTELIGENTE ---
        
        // 1. Descargar UN SOLO cart√≥n (cuando clickean el icono del cart√≥n)
        async function downloadSingleCard(cardId) {
            const cardElement = document.getElementById(`card-visual-${cardId}`);
            if(!cardElement) return;

            // Ocultar bot√≥n de descarga temporalmente para la foto
            const btn = cardElement.querySelector('.btn-mini-dl');
            if(btn) btn.style.display = 'none';

            await captureAndSave(cardElement, `Yovanny-Bingo-Carton-${cardId}.png`);

            // Restaurar bot√≥n
            if(btn) btn.style.display = 'flex';
        }

        // 2. Descargar TODOS los cartones (Bot√≥n del Dock)
        async function downloadAllCards() {
            if(myCards.length === 0) return alert("No tienes cartones.");
            
            const mainBtn = document.querySelector('.nav-item span.label');
            const originalText = mainBtn.innerText;
            mainBtn.innerText = "Guardando...";

            // Iterar y descargar uno por uno con un peque√±o delay para no bloquear
            for (let i = 0; i < myCards.length; i++) {
                await downloadSingleCard(myCards[i].id);
                // Peque√±a pausa para que el navegador procese la descarga
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            mainBtn.innerText = originalText;
        }

        // Funci√≥n auxiliar de captura
        async function captureAndSave(element, filename) {
            // Guardar estilos originales
            const originalBg = element.style.background;
            const originalColor = element.style.color;
            const originalBorder = element.style.border;

            // Aplicar estilos "Modo Impresi√≥n" (Alto Contraste) para que se vea bien la imagen
            element.style.background = "#ffffff";
            element.style.color = "#000000";
            element.style.border = "3px solid #000000";
            element.style.borderRadius = "8px";

            // Cambiar colores de celdas para alto contraste
            const cells = element.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                c.style.border = "2px solid #333333";
                c.style.backgroundColor = "#ffffff"; // Fondo blanco
                c.style.color = "#000000"; // Texto negro
                c.style.fontWeight = "900";
                c.style.fontSize = "1.4rem";
                if(c.classList.contains('marked')) {
                    c.style.backgroundColor = "#000000"; // Marca negra
                    c.style.color = "#ffffff"; // Texto blanco
                    c.style.border = "2px solid #000000";
                }
                if(c.classList.contains('free')) {
                    c.style.color = "#ff6b35"; // Color especial para FREE
                    c.style.fontSize = "1.8rem";
                }
            });

            // Cambiar colores de headers de columnas
            const headers = element.querySelectorAll('.grid-header');
            headers.forEach(h => {
                h.style.backgroundColor = "#e74c3c"; // Rojo fuerte
                h.style.color = "#ffffff";
                h.style.border = "2px solid #c0392b";
                h.style.fontWeight = "900";
            });

            // Cambiar el t√≠tulo del cart√≥n
            const title = element.querySelector('.card-head span');
            if(title) {
                title.style.color = "#000000";
                title.style.fontWeight = "900";
                title.style.fontSize = "1.1rem";
            }

            try {
                const canvas = await html2canvas(element, {
                    scale: 3, // Mayor calidad
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false,
                    width: element.offsetWidth,
                    height: element.offsetHeight
                });

                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL("image/png");
                link.click();

            } catch (err) {
                console.error("Error al guardar", err);
            } finally {
                // Restaurar estilos originales (Modo App Oscuro)
                element.style.background = originalBg;
                element.style.color = originalColor;
                element.style.border = originalBorder;
                element.style.borderRadius = "";

                // Restaurar celdas
                cells.forEach(c => {
                    c.style.border = "";
                    c.style.backgroundColor = "";
                    c.style.color = "";
                    c.style.fontWeight = "";
                    c.style.fontSize = "";
                });

                // Restaurar headers
                headers.forEach(h => {
                    h.style.backgroundColor = "";
                    h.style.color = "";
                    h.style.border = "";
                    h.style.fontWeight = "";
                });

                // Restaurar t√≠tulo
                if(title) {
                    title.style.color = "";
                    title.style.fontWeight = "";
                    title.style.fontSize = "";
                }
            }
        }
    </script>
</body>
</html>