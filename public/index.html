<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yovanny Bingo - Juega Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/animation.js"></script>
    <style>
        @keyframes pop-highlight {
            0% {
                transform: scale(1);
            }

            40% {
                transform: scale(1.25);
                filter: brightness(1.3);
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            }

            100% {
                transform: scale(1);
            }
        }

        .grid-cell {
            cursor: default;
            transition: all 0.2s ease;
        }

        .grid-cell.pop-anim {
            animation: pop-highlight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes gold-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
                border-color: #ffd700;
            }

            50% {
                box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0);
                border-color: #ffed4a;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
                border-color: #ffd700;
            }
        }

        .bingo-card.near-win {
            animation: gold-pulse 1.5s infinite;
            border: 2px solid #ffd700 !important;
            z-index: 10;
        }

        .bingo-card {
            position: relative;
        }

        .proximity-badge {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #ff3b30;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 800;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 15;
            opacity: 0;
            transform: translateY(10px) scale(0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .bingo-card.near-win .proximity-badge {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Estilos del Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            background: rgba(0, 0, 0, 0.1);
            height: 50vh;
            min-height: 300px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 0.6rem 1rem;
            border-radius: 1rem;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .chat-bubble.mine {
            align-self: flex-end;
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 0.2rem;
        }

        .chat-bubble.others {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-bottom-left-radius: 0.2rem;
        }

        .chat-bubble .sender {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 0.2rem;
            display: block;
            font-weight: 600;
        }

        .chat-bubble {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Asegurar visibilidad */
        .chat-bubble.admin {
            align-self: center;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: 1px solid #fca5a5;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
            animation: pop-highlight 0.5s ease-out;
        }

        .chat-bubble .time {
            font-size: 0.65rem;
            opacity: 0.6;
            float: right;
            margin-left: 8px;
            margin-top: 4px;
        }

        .chat-input-area {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 2rem;
            color: white;
            outline: none;
        }

        .chat-badge {
            position: absolute;
            top: 5px;
            right: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 5;
        }

        .quick-reactions {
            display: flex;
            gap: 8px;
            padding: 0 1rem 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .reaction-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Chat Panel Inmersivo */
        #chat-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            z-index: 2000;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        #chat-panel.open {
            transform: translateY(0);
        }

        .chat-header {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        @media (max-width: 768px) {
            #chat-panel {
                width: 94%;
                left: 3%;
                right: 3%;
                bottom: 95px;
                /* M√°s arriba para no tapar la nav */
                height: 45vh;
                border-radius: 16px;
                z-index: 2100;
            }
        }

        /* Estado de Pausa */
        body.is-paused .bingo-card {
            filter: grayscale(0.8) opacity(0.7);
            pointer-events: none;
        }

        body.is-paused .game-main::after {
            content: "‚è∏Ô∏è JUEGO PAUSADO";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 40px;
            border-radius: 20px;
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="player-app">
    <!-- Marca de agua -->
    <div class="watermark-layer"></div>

    <!-- Ticker de anuncios -->
    <div class="global-announcement">
        <div class="marquee-content">
            <span class="announce-icon">üî¥ EN VIVO:</span>
            <span id="announcement-text">BIENVENIDOS AL BINGO YOVANNY - ESPERANDO INICIO DEL JUEGO...</span>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PANTALLA DE BIENVENIDA -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- LAYOUT DIVIDIDO (Auth Flow) -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="auth-layout" class="split-layout">

        <!-- PANELES IZQUIERDOS (Formularios) -->
        <div class="split-left">

            <!-- PANTALLA DE BIENVENIDA -->
            <div id="welcome-screen" class="auth-panel">
                <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">‚öôÔ∏è</button>
                <div class="login-container">
                    <div class="brand-area">
                        <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                        <h1 class="brand-title">BINGO YOVANNY</h1>
                        <p class="brand-subtitle">¬°La suerte est√° de tu lado!</p>
                    </div>
                    <div class="welcome-buttons">
                        <button onclick="enterAsGuest()" class="btn-primary btn-glow btn-block">
                            üéÆ JUGAR COMO INVITADO
                        </button>
                        <button onclick="showScreen('auth-login')" class="btn-secondary btn-block">
                            üë§ CREAR CUENTA O INICIAR SESI√ìN
                        </button>
                    </div>
                </div>
            </div>

            <!-- PANTALLA DE LOGIN (SEPARADA) -->
            <div id="auth-login" class="auth-panel hidden">
                <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">‚öôÔ∏è</button>
                <div class="login-container">
                    <div class="brand-area">
                        <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                        <h1 class="brand-title">INICIAR SESI√ìN</h1>
                    </div>

                    <div class="google-auth-wrapper" style="margin-bottom: 20px;">
                        <button class="btn-google" onclick="alert('Google Auth integration pending backend setup')">
                            <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px;">
                                <path
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                    fill="#4285F4" />
                                <path
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                    fill="#34A853" />
                                <path
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                    fill="#FBBC05" />
                                <path
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                    fill="#EA4335" />
                            </svg>
                            Continuar con Google
                        </button>
                        <div class="separator"
                            style="display: flex; align-items: center; margin: 15px 0; color: var(--text-muted); font-size: 0.8rem;">
                            <span style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></span>
                            <span style="padding: 0 10px;">O usa tu correo</span>
                            <span style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üë§ Usuario</label>
                        <input type="text" id="auth-username" placeholder="Tu usuario..." maxlength="50"
                            autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>üîí Contrase√±a</label>
                        <input type="password" id="auth-password" placeholder="Tu contrase√±a..."
                            autocomplete="current-password">
                    </div>
                    <div id="auth-error" class="error-msg"></div>
                    <button onclick="doLogin()" class="btn-primary btn-glow btn-block">Ingresar</button>

                    <div class="switch-link" style="text-align: center; margin-top: 15px;">
                        ¬øNo tienes cuenta? <a onclick="showScreen('auth-register')"
                            style="color: var(--primary); cursor: pointer;">Reg√≠strate aqu√≠</a>
                    </div>
                    <button onclick="forgotPassword()" class="btn-link"
                        style="margin-top: 10px; width: 100%; font-size: 0.9rem; opacity: 0.8;">¬øOlvidaste tu
                        contrase√±a?</button>
                    <button onclick="showScreen('welcome-screen')" class="btn-link">‚Üê Volver</button>
                </div>
            </div>

            <!-- PANTALLA DE REGISTRO (SEPARADA) -->
            <div id="auth-register" class="auth-panel hidden">
                <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">‚öôÔ∏è</button>
                <div class="login-container">
                    <div class="brand-area">
                        <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                        <h1 class="brand-title">CREAR CUENTA</h1>
                    </div>

                    <div class="google-auth-wrapper" style="margin-bottom: 20px;">
                        <button class="btn-google" onclick="alert('Google Auth integration pending backend setup')">
                            <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px;">
                                <path
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                    fill="#4285F4" />
                                <path
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                    fill="#34A853" />
                                <path
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                    fill="#FBBC05" />
                                <path
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                    fill="#EA4335" />
                            </svg>
                            Continuar con Google
                        </button>
                        <div class="separator"
                            style="display: flex; align-items: center; margin: 15px 0; color: var(--text-muted); font-size: 0.8rem;">
                            <span style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></span>
                            <span style="padding: 0 10px;">O usa tu correo</span>
                            <span style="flex: 1; height: 1px; background: rgba(255,255,255,0.1);"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üë§ Usuario</label>
                        <input type="text" id="reg-username" placeholder="Elige un usuario..." maxlength="50"
                            autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>üìß Correo</label>
                        <input type="email" id="reg-email" placeholder="tu@correo.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>üîí Contrase√±a</label>
                        <input type="password" id="reg-password" placeholder="M√≠nimo 4 caracteres..."
                            autocomplete="new-password">
                    </div>
                    <div id="reg-error" class="error-msg"></div>
                    <button onclick="doRegister()" class="btn-primary btn-glow btn-block">Crear cuenta</button>

                    <div class="switch-link" style="text-align: center; margin-top: 15px;">
                        ¬øYa tienes cuenta? <a onclick="showScreen('auth-login')"
                            style="color: var(--primary); cursor: pointer;">Inicia Sesi√≥n</a>
                    </div>
                    <button onclick="showScreen('welcome-screen')" class="btn-link">‚Üê Volver</button>
                </div>
            </div>

            <!-- PANTALLA DE LOGIN / SELECCI√ìN DE CARTONES -->
            <div id="login-screen" class="auth-panel hidden">
                <button onclick="goToAdmin()" class="admin-access-btn" title="Panel Admin">‚öôÔ∏è</button>

                <div class="login-container">
                    <div class="brand-area">
                        <img src="logo.png" alt="Yovanny Bingo" class="brand-logo">
                        <h1 class="brand-title">BINGO YOVANNY</h1>
                        <p class="brand-subtitle">¬°La suerte est√° de tu lado!</p>
                    </div>

                    <div class="form-group">
                        <label>üë§ Tu nombre</label>
                        <input type="text" id="username" placeholder="Escribe tu apodo..." maxlength="20"
                            autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label>üé´ Selecciona tus cartones</label>
                        <div class="card-picker">
                            <div class="picker-controls">
                                <input type="number" id="manual-input" placeholder="#" min="1" max="300">
                                <button onclick="addManualCard()" class="btn-add" title="Agregar">‚ûï</button>
                                <button onclick="addRandomCard()" class="btn-random" title="Aleatorio">üé≤</button>
                            </div>
                            <small class="hint">Cartones disponibles: 1-300</small>
                            <div id="selected-list" class="chips-container">
                                <span class="empty-hint">Ning√∫n cart√≥n seleccionado</span>
                            </div>
                        </div>
                    </div>

                    <div id="login-error" class="error-msg"></div>

                    <button onclick="joinGame()" class="btn-primary btn-glow">
                        üé± ENTRAR AL JUEGO
                    </button>

                    <button id="back-to-welcome-btn" onclick="backToWelcomeFromLogin()" class="btn-link"
                        style="display:none;">‚Üê Volver</button>
                    <p class="login-footer">Al entrar, aceptas las reglas del juego</p>
                </div>
            </div>

            <!-- PANTALLA DE ESPERA -->
            <div id="waiting-screen" class="auth-panel hidden">
                <div class="waiting-container">
                    <div class="loader-ring"></div>
                    <h2>‚è≥ Esperando Aprobaci√≥n</h2>
                    <p>El administrador est√° revisando tu solicitud...</p>
                    <p id="waiting-info" class="waiting-info"></p>
                </div>
            </div>

        </div>

        <!-- PANEL DERECHO (Animaci√≥n) -->
        <div class="split-right">
            <canvas id="liquid-canvas"></canvas>
            <div class="overlay-text">
                <h2>√önete a la<br>Diversi√≥n</h2>
                <p>La mejor experiencia de Bingo Online con amigos.</p>
            </div>
        </div>

    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PANTALLA DE JUEGO -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="game-screen" class="screen">
        <!-- Header -->
        <header class="game-header glass-card">
            <div class="header-left">
                <div class="avatar"><span id="user-initial">?</span></div>
                <div class="user-info">
                    <span id="player-name" class="user-name">Jugador</span>
                    <span class="user-status">üü¢ En l√≠nea</span>
                </div>
                <button onclick="logoutFromGame()" class="btn-logout-game" title="Cerrar sesi√≥n">üö™</button>
            </div>

            <div class="header-center">
                <div class="current-ball">
                    <span class="ball-label">BOLA</span>
                    <span id="current-number" class="ball-number">--</span>
                </div>
            </div>

            <div class="header-right">
                <button onclick="showCustomizeModal()" class="btn-logout-game" style="margin-right: 8px;"
                    title="Personalizar Color">üé®</button>
                <button onclick="showSettingsModal()" class="btn-logout-game" style="margin-right: 8px;"
                    title="Configuraci√≥n">‚öôÔ∏è</button>
                <div class="mode-badge" onclick="showPatternModal()">
                    <span class="mode-label">MODO</span>
                    <span id="mode-display" class="mode-value">L√çNEA</span>
                </div>
            </div>
        </header>

        <!-- Historial de n√∫meros -->
        <div class="history-bar glass-card">
            <span class="history-label">√öltimos:</span>
            <div id="last-numbers" class="history-balls"></div>
            <span id="total-called" class="total-called">0/75</span>
        </div>

        <!-- √Årea principal: Tablero de n√∫meros en el centro -->
        <main class="game-main"
            style="display: block; overflow-y: auto; padding-bottom: 120px; -webkit-overflow-scrolling: touch;">
            <!-- √Årea de Cartones -->
            <div class="cards-container-full" style="padding: 10px; max-width: 1200px; margin: 0 auto;">
                <div class="cards-header">
                    <h4>üé´ Tus Cartones</h4>
                    <span id="cards-count" class="cards-count">0</span>
                </div>
                <div id="cards-container" class="cards-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                </div>
            </div>
        </main>

        <!-- Barra inferior -->
        <nav class="bottom-nav glass-card">
            <button onclick="showWinnersModal()" class="nav-btn">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-label">Ganadores</span>
            </button>

            <button onclick="toggleChat()" class="nav-btn" style="position: relative;">
                <span class="nav-icon">üí¨</span>
                <span class="nav-label">Chat</span>
                <div id="chat-badge" class="chat-badge hidden">0</div>
            </button>

            <div class="fab-wrapper">
                <button onclick="shoutBingo()" class="btn-bingo pulse" id="bingo-btn">
                    BINGO
                </button>
            </div>

            <button onclick="showAchievementsModal()" class="nav-btn">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-label">Logros</span>
            </button>

            <button onclick="showStatsModal()" class="nav-btn">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Stats</span>
            </button>
        </nav>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODALES -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- Modal de ganadores -->
    <div id="winners-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üèÜ Ganadores Recientes</h3>
                <button onclick="hideModal('winners-modal')" class="btn-close">‚úï</button>
            </div>
            <ul id="winners-list" class="winners-list">
                <li class="empty">No hay ganadores a√∫n</li>
            </ul>
        </div>
    </div>

    <!-- Modal de Personalizaci√≥n -->
    <div id="customize-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üé® Personalizar Color</h3>
                <button onclick="hideModal('customize-modal')" class="btn-close">‚úï</button>
            </div>
            <div class="customize-options" style="padding: 1rem;">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">Elige el color de tus cartones:</p>
                <div class="color-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <button onclick="setTheme('default')" class="color-btn" style="background: #8b5cf6;"
                        title="Violeta (Default)"></button>
                    <button onclick="setTheme('blue')" class="color-btn" style="background: #3b82f6;"
                        title="Azul"></button>
                    <button onclick="setTheme('red')" class="color-btn" style="background: #ef4444;"
                        title="Rojo"></button>
                    <button onclick="setTheme('green')" class="color-btn" style="background: #10b981;"
                        title="Verde"></button>
                    <button onclick="setTheme('orange')" class="color-btn" style="background: #f59e0b;"
                        title="Naranja"></button>
                    <button onclick="setTheme('pink')" class="color-btn" style="background: #ec4899;"
                        title="Rosa"></button>
                    <button onclick="setTheme('teal')" class="color-btn" style="background: #14b8a6;"
                        title="Turquesa"></button>
                    <button onclick="setTheme('slate')" class="color-btn" style="background: #64748b;"
                        title="Gris"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configuraci√≥n</h3>
                <button onclick="hideModal('settings-modal')" class="btn-close">‚úï</button>
            </div>
            <div class="settings-section">
                <h4>üîä Voz del Narrador</h4>
                <div class="voice-settings" style="padding-top: 1rem;">
                    <div class="voice-gender" style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">G√©nero de voz:</label>
                        <div class="gender-buttons" style="display:flex; gap:10px;">
                            <button id="voice-male" class="gender-btn active" onclick="setVoiceGender('male')"
                                style="flex:1; padding:8px;">üë® Masculino</button>
                            <button id="voice-female" class="gender-btn" onclick="setVoiceGender('female')"
                                style="flex:1; padding:8px;">üë© Femenino</button>
                        </div>
                    </div>
                    <div class="voice-volume" style="margin-bottom: 1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem;">Vol√∫men: <span
                                id="volume-display">80%</span></label>
                        <input type="range" id="voice-volume" min="0" max="100" value="80"
                            oninput="setVoiceVolume(this.value)" style="width:100%;">
                    </div>
                    <div class="voice-test">
                        <button onclick="testVoice()" class="btn-primary btn-block">üîä Probar voz</button>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h4>üîî Notificaciones</h4>
                <div class="setting-item">
                    <span>Avisarme de nuevas partidas</span>
                    <label class="switch">
                        <input type="checkbox" id="notifications-toggle"
                            onchange="handleNotificationsToggle(this.checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensaje Privado -->
    <div id="message-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üì® Mensaje del Admin</h3>
                <button onclick="hideModal('message-modal')" class="btn-close">‚úï</button>
            </div>
            <div class="message-body" style="padding: 1.5rem; text-align: center;">
                <p id="admin-message-text" style="font-size: 1.2rem; margin-bottom: 1.5rem;"></p>
                <button onclick="hideModal('message-modal')" class="btn-primary btn-block">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Panel de Chat Inmersivo -->
    <div id="chat-panel">
        <div class="chat-header">
            <h3>üí¨ Chat Global</h3>
            <button onclick="toggleChat()" class="btn-close"
                style="font-size: 1rem; background:none; border:none; color:white;">‚ñº</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="quick-reactions">
            <button onclick="sendQuickEmoji('üëç')" class="reaction-btn">üëç</button>
            <button onclick="sendQuickEmoji('‚ù§Ô∏è')" class="reaction-btn">‚ù§Ô∏è</button>
            <button onclick="sendQuickEmoji('üòÇ')" class="reaction-btn">üòÇ</button>
            <button onclick="sendQuickEmoji('üòÆ')" class="reaction-btn">üòÆ</button>
            <button onclick="sendQuickEmoji('üéâ')" class="reaction-btn">üéâ</button>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escribe un mensaje..." maxlength="100" autocomplete="off">
            <button onclick="sendChatMessage()" class="btn-primary"
                style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center;">‚û§</button>
        </div>
    </div>

    <!-- Modal de patr√≥n -->
    <div id="pattern-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üéØ Patr√≥n Actual</h3>
                <button onclick="hideModal('pattern-modal')" class="btn-close">‚úï</button>
            </div>
            <div class="pattern-display">
                <h4 id="pattern-name">L√çNEA</h4>
                <div id="pattern-grid" class="pattern-grid"></div>
                <p id="pattern-description" class="pattern-desc"></p>
            </div>
        </div>
    </div>

    <!-- Modal de estad√≠sticas -->
    <div id="stats-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üìä Mis Estad√≠sticas</h3>
                <button onclick="hideModal('stats-modal')" class="btn-close">‚úï</button>
            </div>
            <div id="stats-content" class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="stat-games">0</span>
                    <span class="stat-label">Partidas</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-wins">0</span>
                    <span class="stat-label">Victorias</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-rate">0%</span>
                    <span class="stat-label">Win Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="stat-level">1</span>
                    <span class="stat-label">Nivel</span>
                </div>
            </div>
            <!-- Barra de Progreso de Nivel -->
            <div class="level-progress-section"
                style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;">
                    <span>Progreso Nivel <span id="lvl-current">1</span></span>
                    <span id="lvl-exp" style="opacity: 0.8;">0 / 100 XP</span>
                </div>
                <div style="height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden;">
                    <div id="lvl-bar"
                        style="height: 100%; width: 0%; background: linear-gradient(90deg, #4f46e5, #ec4899); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);">
                    </div>
                </div>
            </div>
            <div class="stats-achievements-preview" id="stats-achievements-preview"></div>
        </div>
    </div>

    <!-- Modal de logros -->
    <div id="achievements-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up modal-large">
            <div class="modal-header">
                <h3>üèÖ Todos los Logros</h3>
                <button onclick="hideModal('achievements-modal')" class="btn-close">‚úï</button>
            </div>
            <div id="achievements-grid" class="achievements-grid"></div>
        </div>
    </div>

    <!-- Modal de Recuperaci√≥n de Contrase√±a -->
    <div id="recovery-modal" class="modal hidden">
        <div class="modal-content glass-card slide-up">
            <div class="modal-header">
                <h3>üîí Recuperar Contrase√±a</h3>
                <button onclick="hideModal('recovery-modal')" class="btn-close">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="recovery-step-1">
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Ingresa tu usuario y el correo que
                        registraste para verificar tu identidad.</p>
                    <div class="form-group">
                        <label>üë§ Usuario</label>
                        <input type="text" id="recovery-username" placeholder="Tu usuario...">
                    </div>
                    <div class="form-group">
                        <label>üìß Correo Registrado</label>
                        <input type="email" id="recovery-email" placeholder="tu@correo.com">
                    </div>
                    <div id="recovery-error-1" class="error-msg"></div>
                    <button onclick="doVerifyRecovery()" class="btn-primary btn-block">Verificar Datos</button>
                </div>
                <div id="recovery-step-2" class="hidden">
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Datos verificados. Ahora puedes
                        establecer tu nueva contrase√±a.</p>
                    <div class="form-group">
                        <label>üîë Nueva Contrase√±a</label>
                        <input type="password" id="recovery-new-password" placeholder="M√≠nimo 4 caracteres...">
                    </div>
                    <div id="recovery-error-2" class="error-msg"></div>
                    <button onclick="doResetPassword()" class="btn-primary btn-block">Cambiar Contrase√±a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para logros desbloqueados -->
    <div id="achievement-toast" class="achievement-toast hidden">
        <span class="toast-icon">üèÜ</span>
        <div>
            <strong>¬°Logro desbloqueado!</strong>
            <span id="achievement-toast-name"></span>
        </div>
    </div>

    <!-- Overlay de victoria -->
    <div id="winner-overlay" class="overlay hidden">
        <div class="winner-celebration">
            <div class="trophy-icon">üèÜ</div>
            <h2 class="winner-title">¬°BINGO!</h2>
            <h3 id="winner-name" class="winner-name">Jugador</h3>
            <p class="winner-card">Cart√≥n <span id="winner-card-id">#00</span></p>
            <button onclick="hideOverlay()" class="btn-primary">Continuar</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- JAVASCRIPT -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SISTEMA DE AUDIO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        class BingoAudio {
            constructor() {
                this.ctx = null;
                this.enabled = true;
                // Cargar sonido personalizado (puedes cambiar esta URL por tu propio archivo mp3)
                this.winSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) { this.enabled = false; }
            }

            tone(freq, duration, type = 'sine', vol = 0.3) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            numberDraw() {
                this.tone(600, 0.1, 'sawtooth', 0.2);
                setTimeout(() => this.tone(500, 0.1, 'sawtooth', 0.2), 50);
                setTimeout(() => this.tone(400, 0.15, 'sawtooth', 0.25), 100);
            }

            bingo() {
                // Reproducir el sonido cargado
                this.winSound.currentTime = 0;
                this.winSound.play().catch(e => console.log('Error audio:', e));
                if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            }

            click() { this.tone(800, 0.05, 'square', 0.1); }
            join() {
                this.tone(440, 0.15, 'sine', 0.2);
                setTimeout(() => this.tone(554, 0.15, 'sine', 0.2), 150);
                setTimeout(() => this.tone(659, 0.2, 'sine', 0.2), 300);
            }
        }

        const audio = new BingoAudio();

        const ALL_ACHIEVEMENTS = [
            { id: 'Primera Victoria', name: 'Primera Victoria', desc: 'Gana tu primera partida', icon: 'üéØ' },
            { id: 'Veterano', name: 'Veterano', desc: 'Gana 10 partidas', icon: '‚öîÔ∏è' },
            { id: 'Maestro del Bingo', name: 'Maestro del Bingo', desc: 'Gana 50 partidas', icon: 'üëë' },
            { id: 'Leyenda', name: 'Leyenda', desc: 'Gana 100 partidas', icon: 'üåü' },
            { id: 'Racha de 3', name: 'Racha de 3', desc: 'Gana 3 partidas seguidas', icon: 'üî•' },
            { id: 'Imparable', name: 'Imparable', desc: 'Gana 5 partidas seguidas', icon: 'üí™' },
            { id: 'Invencible', name: 'Invencible', desc: 'Gana 10 partidas seguidas', icon: 'üõ°Ô∏è' },
            { id: 'Blackout', name: 'Blackout', desc: 'Gana con cart√≥n lleno', icon: 'üé±' },
            { id: 'Coraz√≥n de Oro', name: 'Coraz√≥n de Oro', desc: 'Gana con patr√≥n coraz√≥n', icon: 'üíõ' },
            { id: 'Estrella Brillante', name: 'Estrella Brillante', desc: 'Gana con patr√≥n estrella', icon: '‚≠ê' },
            { id: 'Velocista', name: 'Velocista', desc: 'Gana con 15 n√∫meros o menos', icon: '‚ö°' },
            { id: 'Rayo', name: 'Rayo', desc: 'Gana con 10 n√∫meros o menos', icon: 'üå©Ô∏è' }
        ];

        const socket = io();
        let myCards = [];
        let selectedIds = [];
        let currentPattern = 'line';
        let patterns = {};
        let playerSession = loadSession(); // Cargar sesi√≥n inmediatamente
        let unreadChatCount = 0;
        let wakeLock = null;

        const WINNING_PATTERNS = {
            'line': [
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24], // Rows (column-major internal)
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24], // Cols
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20] // Diagonals
            ],
            'full': [Array.from({ length: 25 }, (_, i) => i)],
            'corners': [[0, 4, 20, 24]],
            'x': [[0, 6, 12, 18, 24], [4, 8, 12, 16, 20]],
            'plus': [[2, 7, 10, 11, 12, 13, 14, 17, 22]]
        };

        function loadSession() {
            const saved = localStorage.getItem('bingo_session');
            if (saved) {
                try { return JSON.parse(saved); } catch (e) { localStorage.removeItem('bingo_session'); }
            }
            return null;
        }
        function saveSession(data) {
            playerSession = data;
            localStorage.setItem('bingo_session', JSON.stringify(data));
        }
        function clearSession() {
            const logged = playerSession?.loggedIn ? { loggedIn: true, username: playerSession.username } : null;
            playerSession = logged;
            if (logged) localStorage.setItem('bingo_session', JSON.stringify(logged));
            else localStorage.removeItem('bingo_session');
        }
        function clearSessionFull() {
            playerSession = null;
            localStorage.removeItem('bingo_session');
        }

        function enterAsGuest() {
            saveSession({ guest: true });
            showScreen('login-screen');
            document.getElementById('back-to-welcome-btn').style.display = 'block';
            // Generar nombre temporal para invitado
            const tempName = `Invitado-${Math.floor(Math.random() * 900) + 100}`;
            document.getElementById('username').value = tempName;
            document.getElementById('username').readOnly = false;
        }
        function showAuthScreen() {
            showScreen('auth-login');
        }
        function backToWelcome() {
            showScreen('welcome-screen');
        }
        function backToWelcomeFromLogin() {
            clearSessionFull();
            showScreen('welcome-screen');
            document.getElementById('back-to-welcome-btn').style.display = 'none';
            // Restaurar estado de invitado
            document.getElementById('username').value = '';
            document.getElementById('username').readOnly = false;
        }

        function forgotPassword() {
            document.getElementById('recovery-step-1').classList.remove('hidden');
            document.getElementById('recovery-step-2').classList.add('hidden');
            document.getElementById('recovery-error-1').style.display = 'none';
            document.getElementById('recovery-error-2').style.display = 'none';
            document.getElementById('recovery-username').value = '';
            document.getElementById('recovery-email').value = '';
            showModal('recovery-modal');
        }

        async function doVerifyRecovery() {
            const username = document.getElementById('recovery-username').value.trim();
            const email = document.getElementById('recovery-email').value.trim();
            const err = document.getElementById('recovery-error-1');

            if (!username || !email) {
                err.textContent = 'Completa ambos campos';
                err.style.display = 'block';
                return;
            }

            try {
                const r = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                const d = await r.json();
                if (!d.success) {
                    err.textContent = d.error || 'Datos incorrectos';
                    err.style.display = 'block';
                    return;
                }
                document.getElementById('recovery-step-1').classList.add('hidden');
                document.getElementById('recovery-step-2').classList.remove('hidden');
            } catch (e) {
                err.textContent = 'Error de conexi√≥n';
                err.style.display = 'block';
            }
        }

        async function doResetPassword() {
            const username = document.getElementById('recovery-username').value.trim();
            const email = document.getElementById('recovery-email').value.trim();
            const newPassword = document.getElementById('recovery-new-password').value;
            const err = document.getElementById('recovery-error-2');

            if (!newPassword || newPassword.length < 4) {
                err.textContent = 'Contrase√±a m√≠nimo 4 caracteres';
                err.style.display = 'block';
                return;
            }

            try {
                const r = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, newPassword })
                });
                const d = await r.json();
                if (!d.success) {
                    err.textContent = d.error || 'Error al restablecer';
                    err.style.display = 'block';
                    return;
                }
                alert('¬°Contrase√±a actualizada! Ahora puedes iniciar sesi√≥n.');
                hideModal('recovery-modal');
                showScreen('auth-login');
            } catch (e) {
                err.textContent = 'Error de conexi√≥n';
                err.style.display = 'block';
            }
        }

        function logoutFromGame() {
            if (!confirm('¬øSalir de la partida y cerrar sesi√≥n?')) return;
            clearSessionFull();
            myCards = [];
            selectedIds = [];
            document.getElementById('selected-list').innerHTML = '<span class="empty-hint">Ning√∫n cart√≥n seleccionado</span>';
            document.getElementById('username').value = '';
            document.getElementById('username').readOnly = false;
            document.getElementById('back-to-welcome-btn').style.display = 'none';
            showScreen('welcome-screen');
        }
        // switchAuthTab removed - using separate screens now
        async function doLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            const err = document.getElementById('auth-error');
            if (!username || !password) { err.textContent = 'Completa todos los campos'; return; }
            try {
                const r = await fetch('/api/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const d = await r.json();
                if (!d.success) { err.textContent = d.error || 'Error'; return; }
                saveSession({ loggedIn: true, username: d.username });
                document.getElementById('username').value = d.username;
                document.getElementById('username').readOnly = true;
                showScreen('login-screen');
                document.getElementById('back-to-welcome-btn').style.display = 'block';
            } catch (e) { err.textContent = 'Error de conexi√≥n'; }
        }
        async function doRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const err = document.getElementById('reg-error');
            if (!username || !password || !email) { err.textContent = 'Completa todos los campos'; return; }
            if (password.length < 4) { err.textContent = 'Contrase√±a m√≠nimo 4 caracteres'; return; }
            try {
                const r = await fetch('/api/register', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const d = await r.json();
                if (!d.success) { err.textContent = d.error || 'Error'; return; }
                err.textContent = ''; err.style.color = 'var(--success)';
                err.textContent = '¬°Cuenta creada! Inicia sesi√≥n.';
                err.textContent = '¬°Cuenta creada! Inicia sesi√≥n.';
                showScreen('auth-login');
                document.getElementById('auth-username').value = username;
            } catch (e) { err.textContent = 'Error de conexi√≥n'; }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI: PANTALLAS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showScreen(id) {
            // New logic for Split Layout vs Game Screen
            const gameScreen = document.getElementById('game-screen');
            const authLayout = document.getElementById('auth-layout');

            if (id === 'game-screen') {
                authLayout.style.display = 'none';
                gameScreen.classList.add('active');
                gameScreen.style.display = 'block'; // Ensure visibility
                requestWakeLock();
                return;
            }

            // If leaving game-screen, release lock
            if (gameScreen.classList.contains('active')) {
                releaseWakeLock();
            }

            // It's an auth-related screen
            gameScreen.classList.remove('active');
            gameScreen.style.display = 'none';
            authLayout.style.display = 'grid';

            // Hide all auth panels inside split-left
            document.querySelectorAll('.auth-panel').forEach(p => p.classList.add('hidden'));

            // Show the requested panel
            const target = document.getElementById(id);
            if (target) {
                target.classList.remove('hidden');
                // Ensure form sliders are reset if needed
                if (id === 'auth-screen') {
                    // switchAuthTab('login'); // Optional: reset to login tab
                }
            }
        }

        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        function hideOverlay() { document.getElementById('winner-overlay').classList.add('hidden'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WAKE LOCK (MANTENER PANTALLA PRENDIDA)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake Lock activo: La pantalla no se apagar√°.');
                    wakeLock.addEventListener('release', () => {
                        console.log('üîí Wake Lock liberado.');
                    });
                } catch (err) {
                    console.error(`‚ùå Error al solicitar Wake Lock: ${err.name}, ${err.message}`);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // Re-activar si se vuelve a la pesta√±a
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI: SELECTOR DE CARTONES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderChips() {
            const container = document.getElementById('selected-list');
            if (selectedIds.length === 0) {
                container.innerHTML = '<span class="empty-hint">Ning√∫n cart√≥n seleccionado</span>';
                return;
            }
            container.innerHTML = selectedIds.map(id =>
                `<div class="chip"><span>#${id}</span><button onclick="removeCard(${id})">√ó</button></div>`
            ).join('');
        }

        function addCardToSelection(id) {
            id = parseInt(id);
            if (isNaN(id) || id < 1 || id > 300) {
                showError('N√∫mero debe estar entre 1 y 300');
                return;
            }
            if (selectedIds.includes(id)) {
                showError('Ya seleccionaste este cart√≥n');
                return;
            }
            selectedIds.push(id);
            renderChips();
            audio.click();
        }

        function removeCard(id) {
            selectedIds = selectedIds.filter(x => x !== id);
            renderChips();
        }

        function addManualCard() {
            const input = document.getElementById('manual-input');
            addCardToSelection(input.value);
            input.value = '';
            input.focus();
        }

        function addRandomCard() {
            let rand, safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (selectedIds.includes(rand) && safety < 500);
            addCardToSelection(rand);
        }

        function showError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JUEGO: UNIRSE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function joinGame() {
            const username = document.getElementById('username').value.trim();
            if (!username) return showError('Escribe tu nombre');
            if (selectedIds.length === 0) return showError('Selecciona al menos un cart√≥n');

            socket.emit('join_game', { username, cardIds: selectedIds });

            document.getElementById('waiting-info').textContent =
                `${username} - ${selectedIds.length} cart√≥n(es)`;
            showScreen('waiting-screen');
        }

        function goToAdmin() {
            window.location.href = '/admin-login.html';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JUEGO: GRITAR BINGO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function shoutBingo() {
            socket.emit('bingo_shout');
            audio.click();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SISTEMA DE VOZ PARA JUGADORES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let voiceSettings = {
            gender: 'male',
            volume: 0.8
        };

        function setVoiceGender(gender) {
            voiceSettings.gender = gender;
            document.getElementById('voice-male').classList.toggle('active', gender === 'male');
            document.getElementById('voice-female').classList.toggle('active', gender === 'female');
        }

        function setVoiceVolume(value) {
            voiceSettings.volume = value / 100;
            document.getElementById('volume-display').textContent = `${value}%`;
        }

        function testVoice() {
            const msg = `¬°N√∫mero ${Math.floor(Math.random() * 75) + 1}!`;
            speakNumber(msg);
        }

        let availableVoices = [];
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
        }
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function speakNumber(text) {
            if (!('speechSynthesis' in window)) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = voiceSettings.volume;

            // Seleccionar voz seg√∫n g√©nero y espa√±ol
            if (availableVoices.length === 0) loadVoices();

            const preferredVoice = availableVoices.find(v =>
                (voiceSettings.gender === 'male' && /male|man|pablo|raul|sergio|miguel|javier|espa√±ol/i.test(v.name.toLowerCase())) ||
                (voiceSettings.gender === 'female' && /female|woman|helena|laura|lucia|monica|espa√±ol/i.test(v.name.toLowerCase()))
            ) || availableVoices.find(v => /es-/i.test(v.lang)) || availableVoices[0];

            if (preferredVoice) {
                utterance.voice = preferredVoice;
                utterance.lang = preferredVoice.lang;
            }

            utterance.rate = 1.0;
            utterance.pitch = voiceSettings.gender === 'male' ? 0.7 : 1.3;

            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Escuchar eventos de n√∫meros llamados para anunciarlos
        socket.on('number_called', (data) => {
            // Peque√±o delay para asegurar que el n√∫mero est√© visible
            setTimeout(() => {
                const letter = getLetterForNumber(data.num);
                const msg = `¬°N√∫mero ${letter} ${data.num}!`;
                speakNumber(msg);
            }, 500);
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JUEGO: RENDERIZAR CARTONES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderCards(cards) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bingo-card';
                cardEl.id = `card-${card.id}`;

                cardEl.innerHTML = `
                    <div class="proximity-badge">üî• Falta 1</div>
                    <div class="card-header">
                        <span class="card-title">Cart√≥n #${card.id}</span>
                        <button class="btn-download" onclick="downloadCard(${card.id})" title="Descargar">‚¨áÔ∏è</button>
                    </div>
                    <div class="card-grid">
                        ${['B', 'I', 'N', 'G', 'O'].map(l =>
                    `<div class="grid-header col-${l}">${l}</div>`
                ).join('')}
                        ${[0, 1, 2, 3, 4].map(row =>
                    ['B', 'I', 'N', 'G', 'O'].map(col => {
                        const val = card[col][row];
                        const isFree = val === "FREE";
                        const id = isFree ? '' : `id="c${card.id}-n${val}"`;
                        return `<div class="grid-cell ${isFree ? 'marked free' : ''}" ${id}>${isFree ? '‚òÖ' : val}</div>`;
                    }).join('')
                ).join('')}
                    </div>
                `;

                container.appendChild(cardEl);
                checkCardProximity(card);
            });

            // Actualizar contador de cartones
            document.getElementById('cards-count').textContent = cards.length;
        }

        function toggleCell(el) {
            if (el.classList.contains('free')) return;

            // Animaci√≥n y marcado visual
            el.classList.remove('pop-anim');
            void el.offsetWidth; // Trigger reflow
            el.classList.add('pop-anim');
            el.classList.toggle('marked');

            if (el.classList.contains('marked')) audio.click();
        }

        function markNumber(num, shouldAnimate = false) {
            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${num}`);
                if (el) {
                    if (shouldAnimate) {
                        el.classList.remove('pop-anim');
                        void el.offsetWidth; // Trigger reflow
                        el.classList.add('pop-anim');
                    }
                    if (!el.classList.contains('marked')) el.classList.add('marked');
                    checkCardProximity(card);
                }
            });
        }

        function checkCardProximity(card) {
            const cardEl = document.getElementById(`card-${card.id}`);
            if (!cardEl) return;

            const badge = cardEl.querySelector('.proximity-badge');
            const flatValues = [...card.B, ...card.I, ...card.N, ...card.G, ...card.O];
            let sets = WINNING_PATTERNS[currentPattern];

            // Patrones personalizados del servidor
            if (!sets && patterns[currentPattern]?.positions) {
                const pos = patterns[currentPattern].positions;
                sets = pos.length > 0 && Array.isArray(pos[0]) ? pos : [pos];
            }

            if (!sets) {
                cardEl.classList.remove('near-win');
                if (badge) badge.style.display = 'none';
                return;
            }

            let minMissing = 99;
            for (const set of sets) {
                let missing = 0;
                for (const idx of set) {
                    const val = flatValues[idx];
                    if (val === "FREE") continue;
                    const cell = document.getElementById(`c${card.id}-n${val}`);
                    if (!cell || !cell.classList.contains('marked')) missing++;
                }
                if (missing < minMissing) minMissing = missing;
            }

            if (minMissing > 0 && minMissing <= 3) {
                cardEl.classList.add('near-win');
                if (badge) {
                    badge.style.display = 'block';
                    badge.textContent = minMissing === 1 ? 'üî• ¬°FALTA 1!' : `üî• ¬°Faltan ${minMissing}!`;
                    badge.className = `proximity-badge level-${minMissing}`;
                }
            } else {
                cardEl.classList.remove('near-win');
                if (badge) badge.style.display = 'none';
            }
        }

        function updateLastNumbers(arr) {
            document.getElementById('last-numbers').innerHTML =
                arr.map(n => `<div class="history-ball">${n}</div>`).join('');
        }

        function updateTotalCalled(total) {
            document.getElementById('total-called').textContent = `${total}/75`;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODALES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function handleNotificationsToggle(enabled) {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                alert('Tu navegador no soporta notificaciones push.');
                document.getElementById('notifications-toggle').checked = false;
                return;
            }

            const registration = await navigator.serviceWorker.ready;
            const existingSubscription = await registration.pushManager.getSubscription();

            if (enabled) {
                if (existingSubscription) return;

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert('Permiso de notificaciones denegado.');
                    document.getElementById('notifications-toggle').checked = false;
                    return;
                }

                try {
                    const response = await fetch('/api/vapid-public-key');
                    const vapidPublicKey = await response.text();
                    const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);

                    const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });

                    await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify({ subscription, username: playerSession.username }), headers: { 'Content-Type': 'application/json' } });
                    localStorage.setItem('notifications_enabled', 'true');
                } catch (error) {
                    console.error('Error al suscribirse:', error);
                    document.getElementById('notifications-toggle').checked = false;
                }
            } else {
                if (existingSubscription) await existingSubscription.unsubscribe();
                localStorage.setItem('notifications_enabled', 'false');
            }
        }

        function showCustomizeModal() {
            showModal('customize-modal');
        }

        function setTheme(themeName) {
            // Remover clases de tema existentes
            document.body.classList.remove('theme-blue', 'theme-red', 'theme-green', 'theme-orange', 'theme-pink', 'theme-teal', 'theme-slate');

            if (themeName !== 'default') {
                document.body.classList.add(`theme-${themeName}`);
            }

            localStorage.setItem('bingo_theme', themeName);

            // Feedback visual
            if (navigator.vibrate) navigator.vibrate(50);
            hideModal('customize-modal');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('bingo_theme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
        }

        function showSettingsModal() {
            showModal('settings-modal');
        }

        function showPatternModal() {
            const pattern = patterns[currentPattern];
            document.getElementById('pattern-name').textContent = pattern?.name || currentPattern;
            document.getElementById('pattern-description').textContent = pattern?.description || '';

            const grid = document.getElementById('pattern-grid');
            // Usar la misma funci√≥n estandarizada que el admin
            grid.innerHTML = renderPatternGrid(pattern?.positions || []);

            showModal('pattern-modal');
        }

        /**
         * Convierte √≠ndice display (row-major) a flatCard (column-major). Igual que servidor checkWin.
         */
        function displayToFlatIdx(i) {
            const row = Math.floor(i / 5), col = i % 5;
            return col * 5 + row;
        }

        /**
         * Renderiza patr√≥n. positions usa √≠ndices flatCard (igual que checkWin en servidor).
         */
        function renderPatternGrid(positions) {
            if (!positions || !Array.isArray(positions)) return '';
            const flatPos = positions.length > 0 && Array.isArray(positions[0])
                ? positions[0]
                : positions;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);

            let html = '';
            for (let i = 0; i < 25; i++) {
                const flatIdx = displayToFlatIdx(i);
                const isActive = flatSet.has(flatIdx);
                const isFree = flatIdx === 12;
                html += `<div class="pattern-cell ${isActive ? 'active' : ''} ${isFree ? 'free' : ''}">${isFree ? '‚òÖ' : ''}</div>`;
            }
            return html;
        }

        // Funci√≥n auxiliar para verificar si un √≠ndice est√° en el patr√≥n
        function isPatternCell(displayIdx, patternType) {
            const pattern = patterns[patternType];
            if (!pattern?.positions) return false;
            const flatIdx = displayToFlatIdx ? displayToFlatIdx(displayIdx) : (displayIdx % 5) * 5 + Math.floor(displayIdx / 5);
            const pos = pattern.positions;
            const flatPos = pos.length > 0 && Array.isArray(pos[0]) ? pos[0] : pos;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);
            return flatSet.has(flatIdx);
        }

        function showWinnersModal() {
            showModal('winners-modal');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAT GLOBAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                unreadChatCount = 0;
                document.getElementById('chat-badge').classList.add('hidden');
                scrollToBottomChat();
                setTimeout(() => document.getElementById('chat-input').focus(), 100);
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                socket.emit('send_chat', text);
                input.value = '';
                input.focus();
            }
        }

        function sendQuickEmoji(emoji) {
            socket.emit('send_chat', emoji);
            document.getElementById('chat-input').focus();
        }

        function appendChatMessage(data) {
            const container = document.getElementById('chat-messages');
            const isMine = data.user === playerSession?.username;
            const isAdmin = data.isAdmin;

            const div = document.createElement('div');
            div.id = `chat-msg-${data.id}`;
            div.className = `chat-bubble ${isAdmin ? 'admin' : (isMine ? 'mine' : 'others')}`;
            div.innerHTML = `
                ${!isMine ? `<span class="sender">${data.user}</span>` : ''}
                ${data.text}
                <span class="time">${data.time}</span>
            `;
            container.appendChild(div);

            // OPTIMIZACI√ìN: Mantener solo los √∫ltimos 15 mensajes
            while (container.children.length > 15) {
                container.removeChild(container.firstChild);
            }

            scrollToBottomChat();
        }

        function scrollToBottomChat() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        async function showStatsModal() {
            showModal('stats-modal');
            const username = playerSession?.username;
            if (!username) {
                document.getElementById('stat-games').textContent = '0';
                document.getElementById('stat-wins').textContent = '0';
                document.getElementById('stat-rate').textContent = '0%';
                document.getElementById('stat-level').textContent = '1';
                document.getElementById('stats-achievements-preview').innerHTML = '<p class="stats-hint">Entra al juego para ver tus estad√≠sticas</p>';
                return;
            }
            try {
                const r = await fetch('/api/stats/' + encodeURIComponent(username));
                const d = await r.json();
                if (d.stats) {
                    document.getElementById('stat-games').textContent = d.stats.totalGames || 0;
                    document.getElementById('stat-wins').textContent = d.stats.wins || 0;
                    document.getElementById('stat-rate').textContent = `${Math.round(d.stats.winRate || 0)}%`;
                }
                if (d.level) {
                    document.getElementById('stat-level').textContent = d.level.current || 1;
                    document.getElementById('lvl-current').textContent = d.level.current || 1;

                    const exp = d.level.exp || 0;
                    const next = d.level.expToNext || 100;
                    document.getElementById('lvl-exp').textContent = `${exp} / ${next} XP`;
                    const pct = Math.min(100, Math.max(0, (exp / next) * 100));
                    document.getElementById('lvl-bar').style.width = `${pct}%`;
                }
                const ach = d.achievements || [];
                const preview = ach.slice(0, 6).map(a => `<span class="ach-badge" title="${a.name}">${ALL_ACHIEVEMENTS.find(x => x.name === a.name)?.icon || 'üèÖ'} ${a.name}</span>`).join('');
                document.getElementById('stats-achievements-preview').innerHTML = preview ? `<div class="ach-preview">${preview}</div><button onclick="showAchievementsModal(); hideModal('stats-modal');" class="btn-link">Ver todos los logros ‚Üí</button>` : '<p class="stats-hint">Sin logros a√∫n</p>';
            } catch (e) {
                document.getElementById('stats-achievements-preview').innerHTML = '<p class="stats-hint">No se pudieron cargar</p>';
            }
        }

        async function showAchievementsModal() {
            showModal('achievements-modal');
            const grid = document.getElementById('achievements-grid');
            const username = playerSession?.username;
            let achieved = [];
            if (username) {
                try {
                    const r = await fetch('/api/stats/' + encodeURIComponent(username));
                    const d = await r.json();
                    achieved = (d.achievements || []).map(a => a.name);
                } catch (e) { }
            }
            grid.innerHTML = ALL_ACHIEVEMENTS.map(a => {
                const unlocked = achieved.includes(a.name);
                return `<div class="achievement-item ${unlocked ? 'unlocked' : 'locked'}">
                    <span class="ach-icon">${a.icon}</span>
                    <div>
                        <strong>${a.name}</strong>
                        <p>${a.desc}</p>
                        ${unlocked ? '<span class="ach-status">‚úì Desbloqueado</span>' : '<span class="ach-status locked">Bloqueado</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function showAchievementToast(name) {
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-toast-name').textContent = name;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function updateWinnersList(winners) {
            const list = document.getElementById('winners-list');
            if (!winners?.length) {
                list.innerHTML = '<li class="empty">No hay ganadores a√∫n</li>';
                return;
            }
            list.innerHTML = winners.map(w =>
                `<li><span class="winner-user">üèÜ ${w.user}</span><span class="winner-info">#${w.card} - ${w.time}</span></li>`
            ).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DESCARGA DE CARTONES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function downloadCard(cardId) {
            const el = document.getElementById(`card-${cardId}`);
            if (!el) return;

            const btn = el.querySelector('.btn-download');
            if (btn) btn.style.display = 'none';

            try {
                const canvas = await html2canvas(el, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                const link = document.createElement('a');
                link.download = `Bingo-Carton-${cardId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                console.error('Error descargando:', e);
            }

            if (btn) btn.style.display = '';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SOCKET EVENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        socket.on('connect', () => {
            // Re-identificarse al reconectar para poder enviar mensajes
            if (playerSession?.username && playerSession?.cardIds) {
                socket.emit('reconnect_player', {
                    username: playerSession.username,
                    cardIds: playerSession.cardIds
                });
            }
        });

        socket.on('sync_state', (state) => {
            document.getElementById('announcement-text').textContent = state.message;
            currentPattern = state.pattern;

            // Sincronizar patrones recibidos del servidor (fuente de verdad)
            if (state.patterns && state.patterns.length > 0) {
                patterns = {}; // Limpiar patrones anteriores
                state.patterns.forEach(p => {
                    patterns[p.id] = {
                        name: p.name,
                        description: p.description || '',
                        positions: p.positions || []
                    };
                });
                console.log('‚úÖ Patrones sincronizados desde servidor:', Object.keys(patterns).length);
            }

            const patternInfo = patterns[state.pattern];
            document.getElementById('mode-display').textContent = patternInfo?.name || state.pattern;

            updateWinnersList(state.last5Winners);
            updateLastNumbers(state.last5Numbers);
            state.calledNumbers.forEach(n => markNumber(n, false));
            updateTotalCalled(state.calledNumbers.length);
            myCards.forEach(checkCardProximity);

            if (state.isPaused) document.body.classList.add('is-paused');
            else document.body.classList.remove('is-paused');
        });

        socket.on('waiting_approval', (data) => {
            document.getElementById('waiting-info').textContent = data.message;
        });

        socket.on('join_error', (data) => {
            showScreen('login-screen');
            showError(data.message);
        });

        socket.on('player_accepted', () => {
            audio.join();
        });

        socket.on('player_rejected', (data) => {
            showScreen('login-screen');
            showError(data.message || 'Solicitud rechazada');
        });

        socket.on('init_cards', (data) => {
            myCards = data.cards;
            const username = document.getElementById('username').value.trim();

            saveSession({
                ...playerSession,
                username,
                cardIds: [...selectedIds],
                status: 'approved'
            });

            document.getElementById('player-name').textContent = username;
            document.getElementById('user-initial').textContent = username.charAt(0).toUpperCase();

            renderCards(data.cards);
            showScreen('game-screen');
        });

        socket.on('number_called', (data) => {
            audio.numberDraw();

            const ball = document.getElementById('current-number');
            ball.classList.add('animate');
            ball.textContent = data.num;
            setTimeout(() => ball.classList.remove('animate'), 300);

            markNumber(data.num, true);
            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);

            if (navigator.vibrate) navigator.vibrate(50);
        });

        socket.on('number_undone', (data) => {
            document.getElementById('current-number').textContent =
                data.calledNumbers.length > 0 ? data.calledNumbers[data.calledNumbers.length - 1] : '--';

            myCards.forEach(card => {
                const el = document.getElementById(`c${card.id}-n${data.number}`);
                if (el) el.classList.remove('marked');
            });
            myCards.forEach(checkCardProximity);

            updateLastNumbers(data.last5);
            updateTotalCalled(data.totalCalled);
        });

        socket.on('pattern_changed', (data) => {
            currentPattern = data.type;

            // Actualizar informaci√≥n del patr√≥n desde el servidor (fuente de verdad)
            if (!patterns[data.type]) {
                patterns[data.type] = {};
            }
            patterns[data.type].name = data.name;
            patterns[data.type].description = data.description || '';
            if (data.positions !== undefined) {
                patterns[data.type].positions = data.positions;
            }

            const patternInfo = patterns[data.type] || { name: data.name };
            document.getElementById('mode-display').textContent = patternInfo.name || data.type;

            // Actualizar visualizaci√≥n del patr√≥n en el modal si est√° abierto
            // Usar la funci√≥n estandarizada para asegurar consistencia
            if (!document.getElementById('pattern-modal').classList.contains('hidden')) {
                const pattern = patterns[currentPattern];
                const grid = document.getElementById('pattern-grid');
                grid.innerHTML = renderPatternGrid(pattern?.positions || []);
            }
            myCards.forEach(checkCardProximity);
        });

        socket.on('message_updated', (msg) => {
            document.getElementById('announcement-text').textContent = msg;
        });

        socket.on('winner_announced', (data) => {
            document.getElementById('winner-name').textContent = data.user;
            document.getElementById('winner-card-id').textContent = `#${data.card}`;
            document.getElementById('winner-overlay').classList.remove('hidden');

            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function () {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                // since particles fall down, start a bit higher than random
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);

            audio.bingo();
        });

        socket.on('bingo_audio', () => {
            audio.bingo();
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        socket.on('bingo_celebration', (data) => {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
        });

        socket.on('update_history', updateWinnersList);

        socket.on('invalid_bingo', () => {
            const btn = document.getElementById('bingo-btn');
            btn.style.background = '#ef4444';
            btn.textContent = '‚ùå';
            setTimeout(() => {
                btn.style.background = '';
                btn.textContent = 'BINGO';
            }, 1000);
        });

        socket.on('game_reset', () => {
            document.querySelectorAll('.grid-cell').forEach(c => {
                if (!c.classList.contains('free')) c.classList.remove('marked');
            });
            document.getElementById('current-number').textContent = '--';
            document.getElementById('winner-overlay').classList.add('hidden');
            updateLastNumbers([]);
            updateTotalCalled(0);
        });

        socket.on('full_reset', () => {
            const wasLoggedIn = playerSession?.loggedIn;
            const savedUsername = playerSession?.username;
            clearSession();
            myCards = [];
            selectedIds = [];
            document.getElementById('selected-list').innerHTML = '<span class="empty-hint">Ning√∫n cart√≥n seleccionado</span>';
            if (wasLoggedIn && savedUsername) {
                document.getElementById('username').value = savedUsername;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                showScreen('login-screen');
            } else {
                showScreen('welcome-screen');
            }
        });

        socket.on('kicked', () => {
            clearSession();
            alert('Has sido expulsado del juego');
            location.reload();
        });

        socket.on('reconnection_success', (data) => {
            myCards = data.cards;
            document.getElementById('player-name').textContent = playerSession.username;
            document.getElementById('user-initial').textContent = playerSession.username.charAt(0).toUpperCase();
            renderCards(data.cards);
            showScreen('game-screen');
            audio.join();
        });

        socket.on('reconnection_failed', () => {
            clearSession();
            if (playerSession?.loggedIn && playerSession?.username) {
                document.getElementById('username').value = playerSession.username;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
            }
            showScreen('login-screen');
        });

        socket.on('player_stats', (data) => {
            if (data.stats) {
                document.getElementById('stat-games').textContent = data.stats.totalGames || 0;
                document.getElementById('stat-wins').textContent = data.stats.wins || 0;
                document.getElementById('stat-rate').textContent = `${Math.round(data.stats.winRate || 0)}%`;
            }
            if (data.level) {
                document.getElementById('stat-level').textContent = data.level.current || 1;
            }
        });

        socket.on('achievement_unlocked', (data) => {
            if (data?.name) showAchievementToast(data.name);
        });

        socket.on('level_up', (data) => {
            showAchievementToast(`¬°NIVEL ${data.level} ALCANZADO!`);
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#FFD700', '#FFA500'] });
            if (audio && audio.bingo) audio.bingo();
        });

        socket.on('private_message', (data) => {
            document.getElementById('admin-message-text').textContent = data.message;
            showModal('message-modal');
            if (audio && audio.join) audio.join();
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        });

        socket.on('chat_message', (data) => {
            appendChatMessage(data);
            const panel = document.getElementById('chat-panel');
            if (!panel.classList.contains('open')) {
                unreadChatCount++;
                const badge = document.getElementById('chat-badge');
                badge.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
                badge.classList.remove('hidden');
            }
        });

        socket.on('chat_message_deleted', (msgId) => {
            const el = document.getElementById(`chat-msg-${msgId}`);
            if (el) el.remove();
        });

        socket.on('game_paused', (isPaused) => {
            if (isPaused) document.body.classList.add('is-paused');
            else document.body.classList.remove('is-paused');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INICIALIZACI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.addEventListener('load', async () => {
            // Registrar Service Worker para notificaciones
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(async (registration) => {
                    console.log('‚úÖ Service Worker registrado');
                    const enabled = localStorage.getItem('notifications_enabled') === 'true';
                    document.getElementById('notifications-toggle').checked = enabled;
                    const permission = await Notification.permission;
                    if (enabled && permission !== 'granted') {
                        document.getElementById('notifications-toggle').checked = false;
                        localStorage.setItem('notifications_enabled', 'false');
                    }
                }).catch(error => console.error('‚ùå Error registrando Service Worker:', error));
            }

            loadTheme();
            const session = playerSession;

            if (session?.status === 'approved') {
                socket.emit('reconnect_player', { username: session.username, cardIds: session.cardIds });
                showScreen('waiting-screen');
                document.getElementById('waiting-info').textContent = 'Reconectando...';
                setTimeout(() => {
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        const wasLoggedIn = playerSession?.loggedIn;
                        const savedUsername = playerSession?.username;
                        clearSession();
                        if (wasLoggedIn && savedUsername) {
                            document.getElementById('username').value = savedUsername;
                            document.getElementById('username').readOnly = true;
                            document.getElementById('back-to-welcome-btn').style.display = 'block';
                        }
                        showScreen('login-screen');
                    }
                }, 5000);
                return;
            }

            if (session?.guest) {
                showScreen('login-screen');
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                document.getElementById('username').readOnly = false;
                return;
            }

            if (session?.loggedIn && session?.username) {
                document.getElementById('username').value = session.username;
                document.getElementById('username').readOnly = true;
                document.getElementById('back-to-welcome-btn').style.display = 'block';
                showScreen('login-screen');
                try {
                    const r = await fetch('/api/active-game/' + encodeURIComponent(session.username));
                    const d = await r.json();
                    if (d.hasGame && d.cardIds?.length > 0) {
                        socket.emit('reconnect_player', { username: session.username, cardIds: d.cardIds });
                        showScreen('waiting-screen');
                        document.getElementById('waiting-info').textContent = 'Reconectando...';
                    }
                } catch (e) { }
                return;
            }

            showScreen('welcome-screen');
        });

        // Enter para agregar cart√≥n
        document.getElementById('manual-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addManualCard();
        });

        // Enter para unirse
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && selectedIds.length > 0) joinGame();
        });

        // Enter para enviar chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
    </script>
</body>

</html>