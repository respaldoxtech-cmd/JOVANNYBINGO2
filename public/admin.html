<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yovanny Bingo - Panel de Control</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Estilos del Chat Admin */
        #chat-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #chat-panel.open { transform: translateY(0); }
        .chat-header { padding: 10px 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; color: white; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; background: rgba(0,0,0,0.2); }
        .chat-bubble { max-width: 85%; padding: 0.6rem 1rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; color: white; }
        .chat-bubble.mine { align-self: flex-end; background: #dc2626; border-bottom-right-radius: 0.2rem; }
        .chat-bubble.others { align-self: flex-start; background: rgba(255,255,255,0.15); border-bottom-left-radius: 0.2rem; }
        .chat-bubble .sender { font-size: 0.7rem; opacity: 0.8; margin-bottom: 0.2rem; display: block; font-weight: 600; }
        .chat-input-area { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1); }
        .chat-input-area input { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 0.8rem; border-radius: 2rem; color: white; outline: none; }
        .chat-toggle-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #4f46e5; color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .chat-toggle-btn:hover { transform: scale(1.1); }
        .chat-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #1a1a1a; }
    </style>
</head>
<body class="admin-app">
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- HEADER PRINCIPAL -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="admin-header">
        <div class="header-brand">
            <img src="logo.svg" alt="" class="brand-icon">
            <span class="brand-text">BINGO YOVANNY</span>
            <span class="admin-badge">ADMIN</span>
        </div>
        <div class="header-status">
            <span id="connection-status" class="status-indicator online">ğŸŸ¢ Conectado</span>
            <span id="players-count" class="players-badge">0 jugadores</span>
            <a href="/admin-login.html" class="btn-logout" title="Cerrar sesiÃ³n">ğŸšª Salir</a>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TICKER DE MENSAJE -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="admin-ticker">
        <input type="text" id="admin-message" placeholder="Mensaje para los jugadores..." maxlength="200">
        <button onclick="setMessage()" class="btn-set">ğŸ“¢ Enviar</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- ÃREA PRINCIPAL -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="admin-main">
        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             PANEL IZQUIERDO: JUGADORES Y GANADORES
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="panel-left">
            <div class="roulette-box roulette-box-mini" style="margin-bottom: 1rem;">
                <div class="roulette-display">
                    <div id="roulette-wheel" class="roulette-wheel">
                        <span id="roulette-number" class="roulette-number">--</span>
                    </div>
                    <div class="roulette-stats">
                        <span id="called-count">0</span>/75 nÃºmeros
                    </div>
                </div>
            </div>
            <div class="last-balls" style="margin-bottom: 1rem;">
                <span class="label">Ãšltimos:</span>
                <div id="last-numbers" class="balls-row" style="justify-content: center; flex-wrap: wrap;"></div>
            </div>
            <!-- Controles de voz -->
            <div class="voice-controls-panel glass-card">
                <h4>ğŸ”Š Control de Voz</h4>
                <div class="voice-settings">
                    <div class="voice-gender">
                        <label>GÃ©nero de voz:</label>
                        <div class="gender-buttons">
                            <button id="admin-voice-male" class="gender-btn active" onclick="setAdminVoiceGender('male')">
                                ğŸ‘¨ Masculino
                            </button>
                            <button id="admin-voice-female" class="gender-btn" onclick="setAdminVoiceGender('female')">
                                ğŸ‘© Femenino
                            </button>
                        </div>
                    </div>
                    <div class="voice-volume">
                        <label>VolÃºmen:</label>
                        <input type="range" id="admin-voice-volume" min="0" max="100" value="80" oninput="setAdminVoiceVolume(this.value)">
                        <span id="admin-volume-display">80%</span>
                    </div>
                    <div class="voice-test">
                        <button onclick="testAdminVoice()" class="btn-test-voice">ğŸ”Š Probar voz</button>
                    </div>
                </div>
            </div>

            <!-- Controles de juego (miniatura) -->
            <div class="game-controls">
                <div class="control-group">
                    <button onclick="callNumber()" class="btn-call">ğŸ“¢ LLAMAR ALEATORIO</button>
                </div>
                <div class="control-buttons">
                    <button onclick="undoNumber()" class="btn-undo" title="Deshacer Ãºltimo">â†©ï¸ Deshacer</button>
                    <button onclick="toggleAuto()" id="auto-btn" class="btn-auto">â–¶ï¸ Auto</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('pending')">
                    â³ Pendientes <span id="pending-badge" class="badge">0</span>
                </button>
                <button class="tab" onclick="switchTab('active')">
                    ğŸ‘¥ Activos <span id="active-badge" class="badge">0</span>
                </button>
                <button class="tab" onclick="switchTab('winners')">
                    ğŸ† Ganadores
                </button>
            </div>

            <!-- Contenido de tabs -->
            <div id="pending-tab" class="tab-content active">
                <ul id="pending-list" class="player-list">
                    <li class="empty">No hay solicitudes pendientes</li>
                </ul>
            </div>
            
            <div id="active-tab" class="tab-content">
                <ul id="active-list" class="player-list">
                    <li class="empty">No hay jugadores activos</li>
                </ul>
            </div>
            
            <div id="winners-tab" class="tab-content">
                <ul id="winners-list" class="player-list winners">
                    <li class="empty">No hay ganadores aÃºn</li>
                </ul>
            </div>

            <!-- Acciones rÃ¡pidas -->
            <div class="quick-actions">
                <button onclick="showAddPlayerModal()" class="btn-action">â• Agregar Jugador</button>
                <button onclick="showCardStatusModal()" class="btn-action">ğŸ« Ver Cartones</button>
                <button onclick="newRound()" class="btn-warning">ğŸ”„ Nueva Ronda</button>
                <button onclick="fullReset()" class="btn-danger">âš ï¸ Reinicio Total</button>
            </div>
        </section>

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             PANEL CENTRAL: TABLERO Y RULETA
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="panel-center">
            <div class="board-header">
                <span class="board-title">Tablero de NÃºmeros</span>
                <button onclick="showBoardInfo()" class="btn-info">â„¹ï¸</button>
            </div>
            <div id="numbers-board" class="numbers-board">
                <!-- Los nÃºmeros se generan por JS -->
            </div>
        </section>

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             PANEL DERECHO: PATRÃ“N EN JUEGO (para transmisiÃ³n)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <section class="panel-right">
            <div class="pattern-box pattern-box-stream">
                <h4>ğŸ¯ PatrÃ³n en Juego</h4>
                <div class="pattern-display-large pattern-display-stream">
                    <div class="pattern-preview-large pattern-preview-stream">
                        <div id="current-pattern-grid" class="large-pattern-grid stream-pattern-grid"></div>
                        <div class="pattern-info pattern-info-stream">
                            <span id="current-pattern-name" class="pattern-name-large pattern-name-stream">LÃNEA</span>
                            <span id="current-pattern-desc" class="pattern-desc-small"></span>
                        </div>
                    </div>
                    <button onclick="showPatternSelector()" class="btn-change">Cambiar PatrÃ³n</button>
                </div>
            </div>
        </section>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- MODALES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- Modal: Selector de PatrÃ³n -->
    <div id="pattern-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ğŸ¯ Seleccionar PatrÃ³n</h3>
                <button onclick="hideModal('pattern-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="patterns-tabs">
                    <button class="pattern-tab active" onclick="showPatternCategory('basic')">BÃ¡sicos</button>
                    <button class="pattern-tab" onclick="showPatternCategory('letters')">Letras</button>
                    <button class="pattern-tab" onclick="showPatternCategory('shapes')">Figuras</button>
                    <button class="pattern-tab" onclick="showPatternCategory('advanced')">Avanzados</button>
                    <button class="pattern-tab" onclick="showPatternCategory('custom')">Personalizado</button>
                </div>
                <div id="patterns-grid" class="patterns-grid"></div>
                <div id="custom-pattern-area" class="custom-pattern hidden">
                    <p>Haz clic para activar/desactivar celdas:</p>
                    <div id="custom-grid" class="custom-grid"></div>
                    <button onclick="applyCustomPattern()" class="btn-primary">Aplicar PatrÃ³n Personalizado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Jugador -->
    <div id="add-player-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• Agregar Jugador Manual</h3>
                <button onclick="hideModal('add-player-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre del jugador</label>
                    <input type="text" id="new-player-name" placeholder="Nombre...">
                </div>
                <div class="form-group">
                    <label>Cartones (separados por coma)</label>
                    <input type="text" id="new-player-cards" placeholder="1, 5, 10...">
                </div>
                <button onclick="addPlayer()" class="btn-primary btn-full">Agregar Jugador</button>
            </div>
        </div>
    </div>

    <!-- Modal: Estado de Cartones -->
    <div id="card-status-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ğŸ« Estado de Cartones</h3>
                <button onclick="hideModal('card-status-modal')" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="card-stats">
                    <div class="stat"><span id="stat-available">0</span> Disponibles</div>
                    <div class="stat"><span id="stat-used">0</span> En uso</div>
                </div>
                <div id="cards-grid" class="cards-status-grid"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Ganador Detalle -->
    <div id="winner-detail-modal" class="modal hidden">
        <div class="modal-content modal-winner">
            <div class="winner-header">
                <span class="trophy">ğŸ†</span>
                <h2>Â¡BINGO!</h2>
            </div>
            <div class="winner-info">
                <h3 id="winner-name">Jugador</h3>
                <p>CartÃ³n <span id="winner-card-id">#00</span></p>
                <p id="winner-pattern">PatrÃ³n: LÃNEA</p>
            </div>
            <div id="winner-card-preview" class="card-preview"></div>
            <button onclick="hideModal('winner-detail-modal')" class="btn-primary">Continuar</button>
        </div>
    </div>

    <!-- BotÃ³n flotante del Chat -->
    <button onclick="toggleChat()" class="chat-toggle-btn">
        ğŸ’¬ <span id="chat-badge" class="chat-badge hidden">0</span>
    </button>

    <!-- Panel de Chat -->
    <div id="chat-panel">
        <div class="chat-header">
            <h3>ğŸ’¬ Chat Global</h3>
            <button onclick="toggleChat()" style="background:none; border:none; color:white; cursor:pointer;">â–¼</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Mensaje como ADMIN..." maxlength="100" autocomplete="off">
            <button onclick="sendAdminChat()" class="btn-primary" style="border-radius: 50%; width: 40px; height: 40px; padding: 0;">â¤</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- JAVASCRIPT -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SISTEMA DE AUDIO ADMIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        class AdminAudio {
            constructor() {
                this.ctx = null;
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) {}
            }
            
            tone(freq, dur, type = 'sine', vol = 0.3) {
                if (!this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.start();
                osc.stop(this.ctx.currentTime + dur);
            }
            
            numberCall() {
                this.tone(600, 0.1, 'sawtooth');
                setTimeout(() => this.tone(500, 0.1, 'sawtooth'), 50);
                setTimeout(() => this.tone(400, 0.15, 'sawtooth'), 100);
            }
            
            bingo() {
                this.tone(261.63, 0.8, 'triangle', 0.4);
                setTimeout(() => this.tone(329.63, 0.8, 'triangle', 0.4), 100);
                setTimeout(() => this.tone(392.00, 1.0, 'triangle', 0.4), 200);
            }
            
            newPlayer() {
                this.tone(440, 0.1);
                setTimeout(() => this.tone(554, 0.1), 100);
            }
        }
        
        const audio = new AdminAudio();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ESTADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const socket = io();
        let calledNumbers = [];
        let currentPattern = 'line';
        let customGrid = Array(25).fill(false);
        let isAutoPlaying = false;
        let takenCards = new Set();
        let unreadChatCount = 0;

        // Patrones se cargan desde el servidor (no hardcodeados)
        let PATTERNS = {};
        
        // CategorÃ­as para organizar los patrones en el selector
        const PATTERN_CATEGORIES = {
            basic: ['line', 'corners', 'full', 'corners_center', 'small_square'],
            letters: ['letter_t', 'letter_l', 'letter_h', 'letter_o'],
            shapes: ['x_shape', 'plus', 'diamond', 'heart', 'star', 'arrow', 'pyramid', 'cross'],
            advanced: ['frame', 'inner_square', 'hourglass', 'butterfly', 'checkerboard', 'crown', 'snake', 'zigzag']
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GENERADOR DE CARTONES (igual que servidor)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function mulberry32(seed) {
            return function() {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }

        function generateCard(cardId) {
            const rng = mulberry32(cardId);
            const fillCol = (min, max, count) => {
                const nums = new Set();
                let safety = 0;
                while (nums.size < count && safety < 500) {
                    nums.add(Math.floor(rng() * (max - min + 1)) + min);
                    safety++;
                }
                return Array.from(nums);
            };
            const colN = fillCol(31, 45, 4);
            return {
                id: cardId,
                B: fillCol(1, 15, 5),
                I: fillCol(16, 30, 5),
                N: [colN[0], colN[1], "FREE", colN[2], colN[3]],
                G: fillCol(46, 60, 5),
                O: fillCol(61, 75, 5)
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: TABLERO DE NÃšMEROS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initBoard() {
            const board = document.getElementById('numbers-board');
            board.innerHTML = '';
            
            // Headers B I N G O
            ['B', 'I', 'N', 'G', 'O'].forEach(letter => {
                const h = document.createElement('div');
                h.className = 'board-header-cell';
                h.textContent = letter;
                board.appendChild(h);
            });
            
            // NÃºmeros 1-75 en columnas
            const ranges = [[1,15], [16,30], [31,45], [46,60], [61,75]];
            for (let row = 0; row < 15; row++) {
                ranges.forEach(([min], colIdx) => {
                    const num = min + row;
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    cell.id = `board-${num}`;
                    cell.textContent = num;
                    cell.onclick = () => callNumberDirect(num);
                    board.appendChild(cell);
                });
            }
        }

        function markBoardNumber(num, marked = true) {
            const cell = document.getElementById(`board-${num}`);
            if (cell) {
                cell.classList.toggle('called', marked);
            }
        }

        function updateRoulette(num) {
            const wheel = document.getElementById('roulette-wheel');
            const display = document.getElementById('roulette-number');
            
            wheel.classList.add('spin');
            display.textContent = num;
            
            setTimeout(() => wheel.classList.remove('spin'), 500);
        }

        function updateLastNumbers(arr) {
            const container = document.getElementById('last-numbers');
            container.innerHTML = arr.map(n => {
                const letter = getLetterForNumber(n);
                return `<div class="ball ${letter.toLowerCase()}">${n}</div>`;
            }).join('');
        }

        function getLetterForNumber(n) {
            if (n <= 15) return 'B';
            if (n <= 30) return 'I';
            if (n <= 45) return 'N';
            if (n <= 60) return 'G';
            return 'O';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: TABS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI: MODALES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SELECTOR DE PATRONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPatternSelector() {
            showPatternCategory('basic');
            showModal('pattern-modal');
        }

        function showPatternCategory(category) {
            document.querySelectorAll('.pattern-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showPatternCategory('${category}')"]`).classList.add('active');
            
            const grid = document.getElementById('patterns-grid');
            const customArea = document.getElementById('custom-pattern-area');
            
            if (category === 'custom') {
                grid.classList.add('hidden');
                customArea.classList.remove('hidden');
                initCustomGrid();
            } else {
                customArea.classList.add('hidden');
                grid.classList.remove('hidden');
                
                // Usar categorÃ­as predefinidas para filtrar
                const patternIds = PATTERN_CATEGORIES[category] || [];
                const filtered = patternIds
                    .filter(key => PATTERNS[key]) // Solo mostrar si existe en PATTERNS
                    .map(key => [key, PATTERNS[key]]);
                
                grid.innerHTML = filtered.map(([key, pattern]) => `
                    <div class="pattern-option ${currentPattern === key ? 'selected' : ''}" onclick="selectPattern('${key}')">
                        <div class="pattern-mini-grid">${renderMiniGrid(pattern.positions)}</div>
                        <span class="pattern-name">${pattern.name}</span>
                    </div>
                `).join('');
            }
        }

        /**
         * Convierte Ã­ndice de display (row-major) a Ã­ndice flatCard (column-major).
         * flatCard = [B0,B1,B2,B3,B4, I0..I4, N0..N4, G0..G4, O0..O4]
         * display i = row*5+col -> flatCardIdx = col*5+row
         */
        function displayToFlatIdx(i) {
            const row = Math.floor(i / 5), col = i % 5;
            return col * 5 + row;
        }
        
        /**
         * Renderiza mini grid. positions usa Ã­ndices flatCard (igual que checkWin en servidor).
         */
        function renderMiniGrid(positions) {
            if (!positions || !Array.isArray(positions)) return '';
            const flatPos = positions.length > 0 && Array.isArray(positions[0])
                ? positions[0]
                : positions;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);
            
            let html = '';
            for (let i = 0; i < 25; i++) {
                const flatIdx = displayToFlatIdx(i);
                const isActive = flatSet.has(flatIdx);
                const isFree = flatIdx === 12;
                html += `<div class="mini-cell ${isActive ? 'active' : ''} ${isFree ? 'free' : ''}"></div>`;
            }
            return html;
        }

        function selectPattern(key) {
            currentPattern = key;
            socket.emit('admin_set_pattern', { type: key });
            updatePatternDisplay();
            hideModal('pattern-modal');
        }

        function initCustomGrid() {
            const grid = document.getElementById('custom-grid');
            grid.innerHTML = '';
            customGrid = Array(25).fill(false);
            customGrid[12] = true; // FREE siempre activo
            
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = `custom-cell ${customGrid[i] ? 'active' : ''} ${i === 12 ? 'free' : ''}`;
                cell.onclick = () => toggleCustomCell(i, cell);
                grid.appendChild(cell);
            }
        }

        function toggleCustomCell(idx, el) {
            if (idx === 12) return; // FREE no se puede desactivar
            customGrid[idx] = !customGrid[idx];
            el.classList.toggle('active');
        }

        function applyCustomPattern() {
            socket.emit('admin_set_pattern', { type: 'custom', grid: customGrid });
            currentPattern = 'custom';
            updatePatternDisplay();
            hideModal('pattern-modal');
        }

        function updatePatternDisplay() {
            const pattern = PATTERNS[currentPattern];
            const nameEl = document.getElementById('current-pattern-name');
            const descEl = document.getElementById('current-pattern-desc');
            
            if (!pattern && currentPattern !== 'custom') {
                console.warn(`âš ï¸ PatrÃ³n "${currentPattern}" no encontrado en PATTERNS. Esperando sincronizaciÃ³n...`);
                nameEl.textContent = 'Cargando...';
                descEl.textContent = '';
                return;
            }
            
            const mult = pattern?.multiplier ?? (currentPattern === 'custom' ? 2 : 1);
            nameEl.textContent = pattern?.name || (currentPattern === 'custom' ? 'PERSONALIZADO' : currentPattern);
            descEl.textContent = (pattern?.description || '') + (mult !== 1 ? ` â€¢ x${mult} pts` : '');
            
            const grid = document.getElementById('current-pattern-grid');
            if (currentPattern === 'custom') {
                grid.innerHTML = customGrid.map((active, i) => 
                    `<div class="large-pattern-cell ${active ? 'active' : ''} ${i === 12 ? 'free' : ''}">${i === 12 ? 'â˜…' : ''}</div>`
                ).join('');
            } else if (pattern && pattern.positions) {
                grid.innerHTML = renderLargeGrid(pattern.positions);
            } else {
                grid.innerHTML = '<div class="pattern-loading">Cargando patrÃ³n...</div>';
            }
        }
        
        /**
         * FunciÃ³n estandarizada para renderizar patrÃ³n (idÃ©ntica a index.html)
         * Sistema de Ã­ndices row-major (fila por fila, de izquierda a derecha):
         * 
         * Fila 0: Ã­ndices  0,  1,  2,  3,  4
         * Fila 1: Ã­ndices  5,  6,  7,  8,  9
         * Fila 2: Ã­ndices 10, 11, 12, 13, 14  (12 = centro/free)
         * Fila 3: Ã­ndices 15, 16, 17, 18, 19
         * Fila 4: Ã­ndices 20, 21, 22, 23, 24
         * 
         * Ãndice = row * 5 + col
         */
        function renderLargeGrid(positions) {
            if (!positions || !Array.isArray(positions)) return '';
            const flatPos = positions.length > 0 && Array.isArray(positions[0])
                ? positions[0]
                : positions;
            const flatSet = new Set(Array.isArray(flatPos[0]) ? flatPos.flat() : flatPos);
            
            let html = '';
            for (let i = 0; i < 25; i++) {
                const flatIdx = displayToFlatIdx(i);
                const isActive = flatSet.has(flatIdx);
                const isFree = flatIdx === 12;
                html += `<div class="large-pattern-cell ${isActive ? 'active' : ''} ${isFree ? 'free' : ''}">${isFree ? 'â˜…' : ''}</div>`;
            }
            return html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ACCIONES DE JUEGO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function callNumber() {
            const available = [];
            for (let n = 1; n <= 75; n++) {
                if (!calledNumbers.includes(n)) available.push(n);
            }
            if (available.length === 0) return;
            const num = available[Math.floor(Math.random() * available.length)];
            socket.emit('admin_call_number', num);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SISTEMA DE VOZ PARA ADMIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let adminVoiceSettings = {
            gender: 'male',
            volume: 0.8
        };

        function setAdminVoiceGender(gender) {
            adminVoiceSettings.gender = gender;
            document.getElementById('admin-voice-male').classList.toggle('active', gender === 'male');
            document.getElementById('admin-voice-female').classList.toggle('active', gender === 'female');
        }

        function setAdminVoiceVolume(value) {
            adminVoiceSettings.volume = value / 100;
            document.getElementById('admin-volume-display').textContent = `${value}%`;
        }

        function testAdminVoice() {
            const msg = `Â¡NÃºmero ${Math.floor(Math.random() * 75) + 1}!`;
            speakAdminNumber(msg);
        }

        function speakAdminNumber(text) {
            if (!('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = adminVoiceSettings.volume;
            
            // Seleccionar voz segÃºn gÃ©nero
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => 
                (adminVoiceSettings.gender === 'male' && /male|man|espaÃ±ol.*mexicano/i.test(v.name)) ||
                (adminVoiceSettings.gender === 'female' && /female|woman|espaÃ±ol.*mexicano/i.test(v.name))
            ) || voices.find(v => /espaÃ±ol/i.test(v.lang)) || voices[0];
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.rate = 1.0;
            utterance.pitch = adminVoiceSettings.gender === 'male' ? 0.8 : 1.2;
            
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Escuchar eventos de nÃºmeros llamados para anunciarlos
        socket.on('number_called', (data) => {
            // PequeÃ±o delay para asegurar que el nÃºmero estÃ© visible
            setTimeout(() => {
                const letter = getLetterForNumber(data.num);
                const msg = `Â¡NÃºmero ${letter} ${data.num}!`;
                speakAdminNumber(msg);
            }, 500);
        });

        function callNumberDirect(num) {
            if (!calledNumbers.includes(num)) {
                socket.emit('admin_call_number', num);
            }
        }

        function undoLast() {
            socket.emit('admin_undo_number');
        }

        function toggleAuto() {
            if (isAutoPlaying) {
                socket.emit('admin_stop_auto');
            } else {
                socket.emit('admin_start_auto');
            }
        }

        function callManualNumber() {
            const input = document.getElementById('manual-number');
            const num = parseInt(input.value);
            if (isNaN(num) || num < 1 || num > 75) {
                alert('Ingresa un nÃºmero entre 1 y 75');
                return;
            }
            socket.emit('admin_call_number', num);
            input.value = '';
        }

        function setMessage() {
            const msg = document.getElementById('admin-message').value.trim();
            if (msg) {
                socket.emit('admin_set_message', msg);
            }
        }

        function newRound() {
            if (confirm('Â¿Iniciar nueva ronda? Se borrarÃ¡n los nÃºmeros llamados.')) {
                socket.emit('admin_reset');
            }
        }

        function fullReset() {
            if (confirm('âš ï¸ Â¿REINICIO TOTAL? Se eliminarÃ¡n todos los jugadores y datos.')) {
                if (confirm('Esta acciÃ³n no se puede deshacer. Â¿Continuar?')) {
                    socket.emit('admin_full_reset');
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GESTIÃ“N DE JUGADORES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updatePendingList(players) {
            const list = document.getElementById('pending-list');
            const badge = document.getElementById('pending-badge');
            badge.textContent = players.length;
            
            if (!players.length) {
                list.innerHTML = '<li class="empty">No hay solicitudes pendientes</li>';
                return;
            }
            
            list.innerHTML = players.map(p => `
                <li class="player-item pending">
                    <div class="player-info">
                        <span class="player-name">${p.name}</span>
                        <span class="player-cards">${p.cardCount} cartÃ³n(es): #${p.cardIds.join(', #')}</span>
                    </div>
                    <div class="player-actions">
                        <button onclick="acceptPlayer('${p.id}')" class="btn-accept">âœ“</button>
                        <button onclick="rejectPlayer('${p.id}')" class="btn-reject">âœ•</button>
                    </div>
                </li>
            `).join('');
        }

        function updateActiveList(players) {
            const list = document.getElementById('active-list');
            const badge = document.getElementById('active-badge');
            badge.textContent = players.length;
            document.getElementById('players-count').textContent = `${players.length} jugadores`;
            
            if (!players.length) {
                list.innerHTML = '<li class="empty">No hay jugadores activos</li>';
                return;
            }
            
            list.innerHTML = players.map(p => `
                <li class="player-item">
                    <div class="player-info">
                        <span class="player-name">${p.name} <span class="status-badge ${p.status === 'online' ? 'online' : 'offline'}">${p.status === 'online' ? 'ğŸŸ¢' : 'âš«'}</span></span>
                        <span class="player-cards">${p.cardCount} cartÃ³n(es)</span>
                    </div>
                    <div class="player-actions">
                        <button onclick="kickPlayer(${p.status === 'online' ? `'${p.id}'` : `{username: '${p.name}'}`})" class="btn-kick" title="Eliminar">ğŸš«</button>
                    </div>
                </li>
            `).join('');
        }

        function updateWinnersList(winners) {
            const list = document.getElementById('winners-list');
            if (!winners?.length) {
                list.innerHTML = '<li class="empty">No hay ganadores aÃºn</li>';
                return;
            }
            list.innerHTML = winners.map(w => `
                <li class="winner-item">
                    <span class="winner-icon">ğŸ†</span>
                    <span class="winner-name">${w.user}</span>
                    <span class="winner-card">#${w.card}</span>
                    <span class="winner-time">${w.time}</span>
                </li>
            `).join('');
        }

        function acceptPlayer(id) {
            socket.emit('admin_accept_player', id);
            audio.newPlayer();
        }

        function rejectPlayer(id) {
            socket.emit('admin_reject_player', id);
        }

        function kickPlayer(idOrData) {
            const message = typeof idOrData === 'string' ? 'Â¿Expulsar a este jugador?' : 'Â¿Eliminar a este jugador offline?';
            if (confirm(message)) {
                socket.emit('admin_kick_player', idOrData);
            }
        }

        function showAddPlayerModal() {
            showModal('add-player-modal');
        }

        function addPlayer() {
            const name = document.getElementById('new-player-name').value.trim();
            const cardsInput = document.getElementById('new-player-cards').value;
            
            if (!name) return alert('Ingresa un nombre');
            
            const cardIds = cardsInput.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n) && n >= 1 && n <= 300);
            
            if (cardIds.length === 0) return alert('Ingresa cartones vÃ¡lidos');
            
            socket.emit('admin_add_player', { name, cardIds });
            hideModal('add-player-modal');
            document.getElementById('new-player-name').value = '';
            document.getElementById('new-player-cards').value = '';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHAT ADMIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                unreadChatCount = 0;
                document.getElementById('chat-badge').classList.add('hidden');
                scrollToBottomChat();
                setTimeout(() => document.getElementById('chat-input').focus(), 100);
            }
        }

        function sendAdminChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text) {
                socket.emit('admin_send_chat', text);
                input.value = '';
                input.focus();
            }
        }

        function appendChatMessage(data) {
            const container = document.getElementById('chat-messages');
            const isMine = data.isAdmin; // Si es admin, es mÃ­o (en este panel)
            
            const div = document.createElement('div');
            div.className = `chat-bubble ${isMine ? 'mine' : 'others'}`;
            div.innerHTML = `
                ${!isMine ? `<span class="sender">${data.user}</span>` : ''}
                ${data.text}
            `;
            container.appendChild(div);
            scrollToBottomChat();
        }

        function scrollToBottomChat() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ESTADO DE CARTONES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showCardStatusModal() {
            socket.emit('get_card_availability');
            showModal('card-status-modal');
        }

        function updateCardStatus(data) {
            takenCards = new Set(data.takenCards);
            
            document.getElementById('stat-available').textContent = data.availableCount;
            document.getElementById('stat-used').textContent = data.usedCount;
            
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 300; i++) {
                const cell = document.createElement('div');
                cell.className = `card-status-cell ${takenCards.has(i) ? 'taken' : 'available'}`;
                cell.textContent = i;
                cell.title = takenCards.has(i) ? 'En uso' : 'Disponible';
                grid.appendChild(cell);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOCKET EVENTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        socket.on('connect', () => {
            document.getElementById('connection-status').className = 'status-indicator online';
            document.getElementById('connection-status').innerHTML = 'ğŸŸ¢ Conectado';
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-status').className = 'status-indicator offline';
            document.getElementById('connection-status').innerHTML = 'ğŸ”´ Desconectado';
        });

        socket.on('sync_state', (state) => {
            calledNumbers = state.calledNumbers;
            currentPattern = state.pattern;
            
            // Sincronizar patrones recibidos del servidor (fuente de verdad)
            if (state.patterns && state.patterns.length > 0) {
                PATTERNS = {}; // Limpiar patrones anteriores
                state.patterns.forEach(p => {
                    PATTERNS[p.id] = {
                        name: p.name,
                        description: p.description || '',
                        positions: p.positions || [],
                        multiplier: p.multiplier || 1
                    };
                });
                console.log('âœ… Patrones sincronizados desde servidor:', Object.keys(PATTERNS).length);
            }
            
            document.getElementById('called-count').textContent = calledNumbers.length;
            document.getElementById('admin-message').value = state.message;
            
            calledNumbers.forEach(n => markBoardNumber(n, true));
            updateLastNumbers(state.last5Numbers);
            updateWinnersList(state.last5Winners);
            updatePatternDisplay();
            
            if (state.calledNumbers.length > 0) {
                document.getElementById('roulette-number').textContent = 
                    state.calledNumbers[state.calledNumbers.length - 1];
            }
        });

        socket.on('number_called', (data) => {
            calledNumbers.push(data.num);
            markBoardNumber(data.num, true);
            updateRoulette(data.num);
            updateLastNumbers(data.last5);
            document.getElementById('called-count').textContent = data.totalCalled;
            audio.numberCall();
        });

        socket.on('number_undone', (data) => {
            calledNumbers = data.calledNumbers;
            markBoardNumber(data.number, false);
            updateLastNumbers(data.last5);
            document.getElementById('called-count').textContent = data.totalCalled;
            document.getElementById('roulette-number').textContent = 
                calledNumbers.length > 0 ? calledNumbers[calledNumbers.length - 1] : '--';
        });

        socket.on('pattern_changed', (data) => {
            currentPattern = data.type;
            if (data.grid) {
                customGrid = data.grid;
            }
            // Actualizar PATTERNS con la informaciÃ³n recibida del servidor
            if (data.type) {
                if (!PATTERNS[data.type]) PATTERNS[data.type] = {};
                PATTERNS[data.type].name = data.name || PATTERNS[data.type].name;
                PATTERNS[data.type].description = data.description ?? PATTERNS[data.type].description;
                PATTERNS[data.type].positions = data.positions ?? PATTERNS[data.type].positions;
                PATTERNS[data.type].multiplier = data.multiplier ?? PATTERNS[data.type].multiplier ?? 1;
            }
            updatePatternDisplay();
        });

        socket.on('update_pending_players', updatePendingList);
        socket.on('update_players', updateActiveList);
        socket.on('update_history', updateWinnersList);

        socket.on('new_player_pending', (data) => {
            audio.newPlayer();
            switchTab('pending');
        });

        socket.on('winner_announced', (data) => {
            audio.bingo();
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            
            document.getElementById('winner-name').textContent = data.user;
            document.getElementById('winner-card-id').textContent = `#${data.card}`;
            document.getElementById('winner-pattern').textContent = `PatrÃ³n: ${data.patternName || data.pattern}`;
            
            showModal('winner-detail-modal');
        });

        socket.on('winner_card_details', (data) => {
            const preview = document.getElementById('winner-card-preview');
            const card = data.card;
            
            preview.innerHTML = `
                <div class="preview-grid">
                    ${['B','I','N','G','O'].map(l => `<div class="preview-header">${l}</div>`).join('')}
                    ${[0,1,2,3,4].map(row => 
                        ['B','I','N','G','O'].map(col => {
                            const val = card[col][row];
                            const isFree = val === "FREE";
                            const isMarked = isFree || data.calledNumbers.includes(val);
                            return `<div class="preview-cell ${isMarked ? 'marked' : ''}">${isFree ? 'â˜…' : val}</div>`;
                        }).join('')
                    ).join('')}
                </div>
            `;
        });

        socket.on('auto_play_started', () => {
            isAutoPlaying = true;
            const btn = document.getElementById('auto-btn');
            btn.textContent = 'â¹ï¸ Detener';
            btn.classList.add('active');
        });

        socket.on('auto_play_stopped', () => {
            isAutoPlaying = false;
            const btn = document.getElementById('auto-btn');
            btn.textContent = 'â–¶ï¸ Auto';
            btn.classList.remove('active');
        });

        socket.on('game_reset', () => {
            calledNumbers = [];
            document.querySelectorAll('.board-cell').forEach(c => c.classList.remove('called'));
            document.getElementById('roulette-number').textContent = '--';
            document.getElementById('called-count').textContent = '0';
            document.getElementById('last-numbers').innerHTML = '';
        });

        socket.on('card_availability', updateCardStatus);

        socket.on('admin_success', (data) => {
            alert(data.message);
        });

        socket.on('admin_error', (data) => {
            alert('Error: ' + data.message);
        });
        
        socket.on('chat_message', (data) => {
            appendChatMessage(data);
            const panel = document.getElementById('chat-panel');
            if (!panel.classList.contains('open')) {
                unreadChatCount++;
                const badge = document.getElementById('chat-badge');
                badge.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
                badge.classList.remove('hidden');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', () => {
            initBoard();
            updatePatternDisplay();
            
            document.getElementById('admin-message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setMessage();
            });
            
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendAdminChat();
            });
        });
    </script>
</body>
</html>
