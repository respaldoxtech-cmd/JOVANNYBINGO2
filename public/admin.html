<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Yovanny Bingo</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        if (!sessionStorage.getItem('yovanny_admin_auth')) {
            window.location.href = '/admin-login.html'; // O '/login.html' si no usaste el login dedicado
        }
    </script>
</head>
<body class="admin-ui">

    <div class="watermark-layer"></div>

    <div class="dashboard-layout">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="admin-logo-img">
                <span class="brand-name">PANEL DE CONTROL</span>
            </div>

            <div class="nav-group">
                <label>BOMBO VIRTUAL</label>
                <div class="roulette-widget">
                    <div id="roulette-display" class="big-num">--</div>
                    <button onclick="spinRoulette()" class="btn-action">GIRAR BOLA</button>
                    
                    <div class="last-5-container">
                        <small class="last-5-label">√öltimas 5:</small>
                        <div id="admin-last-5" class="last-5-row">
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                        </div>
                    </div>
                    <div class="stats-text">Total Sacadas: <span id="count-called">0</span>/300</div>
                </div>
            </div>

            <div class="nav-group">
                <label>NOTICIERO (TICKER)</label>
                <div class="input-row">
                    <input type="text" id="announce-input" placeholder="Escribe un anuncio...">
                    <button onclick="updateMessage()" class="btn-icon-sm">ENVIAR</button>
                </div>
            </div>

            <div class="nav-group">
                <label>üèÜ GANADORES</label>
                <ul id="winner-list" class="scroll-list gold-text sidebar-winners">
                </ul>
            </div>

            <div class="nav-group">
                <label>üé´ ESTADO DE CARTONES</label>
                <div class="sidebar-cards-status">
                    <div class="cards-summary">
                        <div class="status-item">
                            <span class="status-label">EN USO:</span>
                            <span class="status-count used" id="used-cards-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">DISPONIBLES:</span>
                            <span class="status-count available" id="available-cards-count">75</span>
                        </div>
                    </div>
                    <div class="cards-grid" id="cards-status-grid">
                        <!-- Cards will be populated here -->
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button onclick="openAddPlayerModal()" class="btn-danger-outline" style="margin-bottom: 8px;">‚ûï AGREGAR JUGADOR</button>
                <button onclick="resetGame()" class="btn-danger-outline">NUEVA RONDA</button>
                <button onclick="fullReset()" class="btn-danger-outline" style="margin-top: 8px;">REINICIAR TODO</button>
                <button onclick="logout()" class="btn-link" style="margin-top: 8px;">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <h2>
                    <span style="color:var(--stream-accent)">YOVANNY BINGO</span>
                    <span style="font-weight:400; font-size:1rem; margin-left:10px; color:#666;">| MONITOR EN VIVO</span>
                </h2>
                <span class="badge-live">‚óè TRANSMITIENDO</span>
            </header>

            <div class="grid-content">

                <div class="left-column">
                    <div class="last-number-display">
                        <div class="last-number-label">√öLTIMO N√öMERO</div>
                        <div id="last-number-large" class="last-number-large">--</div>
                    </div>
                    <div class="card board-card">
                        <div id="master-board" class="master-board-grid">
                            </div>
                    </div>
                </div>

                <div class="side-column">

                    <div class="card info-card">
                        <div class="card-header">
                            <h3>üéØ CONFIGURACI√ìN DE CARTONES</h3>
                        </div>
                        <div class="game-config-content">
                            <select id="game-mode" onchange="changeMode()" class="select-dark" style="margin-bottom: 15px;">
                                <option value="line">Normal (L√≠nea/Diagonal)</option>
                                <option value="full">Cart√≥n Lleno (Blackout)</option>
                                <option value="corners">4 Esquinas</option>
                                <option value="x">X (Diagonales Cruzadas)</option>
                                <option value="plus">Plus (Centro + Brazos)</option>
                                <option value="corners_center">Esquinas + Centro</option>
                                <option value="frame">Marco Exterior</option>
                                <option value="inner_frame">Marco Interior</option>
                                <option value="letter_h">Letra H</option>
                                <option value="letter_t">Letra T</option>
                                <option value="small_square">Cuadrado Peque√±o</option>
                                <option value="diamond">Diamante</option>
                                <option value="star">Estrella</option>
                                <option value="heart">Coraz√≥n</option>
                                <option value="airplane">Avi√≥n</option>
                                <option value="arrow">Flecha</option>
                                <option value="crazy">Crazy (Zigzag)</option>
                                <option value="pyramid">Pir√°mide</option>
                                <option value="cross">Cruz</option>
                                <option value="custom">Figura Manual (Personalizada)</option>
                            </select>

                            <div class="pattern-container">
                                <div id="pattern-display" class="pattern-display-large"></div>
                            </div>
                            <small id="pattern-explanation" class="pattern-explanation" style="display: block; text-align: center; margin: 10px 0; font-weight: 600;"></small>

                            <div id="custom-ui" class="hidden custom-pattern-ui">
                                <div style="text-align:center; margin-bottom:10px; font-size:0.8rem; font-weight:600;">DIBUJA TU FIGURA PERSONALIZADA:</div>
                                <div id="pattern-grid" class="pattern-mini-large"></div>
                                <button onclick="sendPattern()" class="btn-apply-pattern">APLICAR FIGURA</button>
                            </div>
                        </div>
                    </div>

                    <div class="card info-card">
                        <div class="card-header">
                            <h3>üë• JUGADORES</h3>
                        </div>
                        <div class="players-section">
                            <div class="player-tabs">
                                <button class="tab-button active" onclick="switchTab('pending')">‚è≥ PENDIENTES <span class="badge-count" id="pending-count">0</span></button>
                                <button class="tab-button" onclick="switchTab('active')">ACTIVOS <span class="badge-count" id="player-count">0</span></button>
                            </div>
                            <div id="pending-content" class="tab-content active">
                                <ul id="pending-list" class="scroll-list">
                                </ul>
                            </div>
                            <div id="active-content" class="tab-content">
                                <ul id="player-list" class="scroll-list">
                                </ul>
                                <div id="virtual-players-notice" class="info-notice" style="display: none; margin-top: 10px; padding: 8px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; font-size: 0.85rem; color: #2e7d32;">
                                    <strong>üì± Jugadores Agregados Manualmente:</strong> Estos jugadores pueden ganar premios pero no est√°n conectados f√≠sicamente.
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>
        </main>
    </div>

    <div id="admin-winner-modal" class="modal-backdrop hidden">
        <div class="winner-alert-box bounce-in">
            <div class="alert-icon">üö®</div>
            <h2>¬°BINGO CANTADO!</h2>
            <div class="winner-details">
                <h3 id="modal-winner-name">Nombre del Jugador</h3>
                <p>Gan√≥ con el Cart√≥n <span id="modal-winner-card" class="highlight-card">#000</span></p>
            </div>
            <div class="modal-actions">
                <button onclick="closeAdminModal()" class="btn-confirm">CONFIRMAR VICTORIA</button>
            </div>
        </div>
    </div>

    <div id="add-player-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>‚ûï AGREGAR JUGADOR MANUALMENTE</h3>
                <button onclick="closeAddPlayerModal()" class="btn-close">‚úï</button>
            </div>
            <div class="modal-content" style="padding: 20px; max-height: calc(80vh - 80px); overflow-y: auto;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre del Jugador:</label>
                    <input type="text" id="new-player-name" placeholder="Ingresa el nombre..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Seleccionar Cartones:</label>
                    <div class="card-picker-ui" style="border: 1px solid #eee; padding: 10px; border-radius: 6px;">
                        <div class="picker-controls">
                            <input type="number" id="admin-manual-input" placeholder="#" min="1" max="300">
                            <button onclick="adminAddManualCard()" class="btn-add">‚ûï Agregar</button>
                            <button onclick="adminAddRandomCard()" class="btn-random">üé≤ Aleatorio</button>
                        </div>
                        <small class="hint-text" id="card-availability-hint">Verificando disponibilidad...</small>
                        <div id="admin-selected-list" class="chips-container" style="margin-top: 10px;"></div>
                        <div id="card-availability-grid" class="mini-card-grid" style="margin-top: 10px; display: grid; grid-template-columns: repeat(15, 1fr); gap: 2px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;"></div>
                    </div>
                </div>

                <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeAddPlayerModal()" class="btn-secondary">CANCELAR</button>
                    <button onclick="addPlayerManually()" class="btn-primary">AGREGAR JUGADOR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let calledNumbers = new Set();
        let customGrid = Array(25).fill(false);
        let isSpinning = false;

        // 1. INICIALIZAR TABLERO MAESTRO
        const board = document.getElementById('master-board');
        board.innerHTML = ''; // Limpiar por seguridad
        for(let i=1; i<=75; i++) {
            const d = document.createElement('div');
            d.innerText = i;
            d.className = 'num-item'; // Clase del CSS nuevo
            d.id = `btn-${i}`;
            // Permitir marcar/desmarcar manualmente si el admin quiere corregir
            d.onclick = () => {
                if(!isSpinning) callNumber(i);
            };
            board.appendChild(d);
        }

        // 2. INICIALIZAR GRID DE PATR√ìN MANUAL
        const pGrid = document.getElementById('pattern-grid');
        pGrid.innerHTML = '';
        for(let i=0; i<25; i++) {
            const d = document.createElement('div');
            d.className = 'p-dot';
            if(i === 12) {
                d.style.background = '#ccc'; // Centro FREE
                d.style.cursor = 'default';
            } else {
                d.onclick = function() {
                    this.classList.toggle('active');
                    customGrid[i] = !customGrid[i];
                };
            }
            pGrid.appendChild(d);
        }

        // --- SOCKET LISTENERS (LA INTELIGENCIA) ---

        // Sincronizar estado al entrar
        socket.on('sync_state', (s) => {
            // Actualizar tablero
            s.calledNumbers.forEach(n => {
                calledNumbers.add(n);
                const el = document.getElementById(`btn-${n}`);
                if(el) el.classList.add('active');
            });
            
            // Actualizar textos y contadores
            document.getElementById('announce-input').value = s.message;
            document.getElementById('count-called').innerText = calledNumbers.size;
            updateWinners(s.last5Winners);
            updateAdminLast5(s.last5Numbers);
            
            // Sincronizar modo de juego
            const modeSelect = document.getElementById('game-mode');
            modeSelect.value = s.pattern;
            toggleCustomUI(s.pattern);
            updatePatternDisplay(s.pattern);
        });

        // Bola Nueva
        socket.on('number_called', ({num, last5}) => {
            calledNumbers.add(num);
            const el = document.getElementById(`btn-${num}`);
            if(el) {
                el.classList.add('active');
                // Efecto visual de parpadeo
                el.style.transform = "scale(1.3)";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            }

            // Update large last number display
            document.getElementById('last-number-large').innerText = num;
            // Add pulse animation effect
            const largeDisplay = document.getElementById('last-number-large');
            largeDisplay.style.animation = 'none';
            setTimeout(() => largeDisplay.style.animation = 'numberPulse 0.8s ease-out', 10);

            if(!isSpinning) document.getElementById('roulette-display').innerText = num;
            document.getElementById('count-called').innerText = calledNumbers.size;
            updateAdminLast5(last5);
        });

        // Lista de Jugadores
        socket.on('update_players', (p) => {
            document.getElementById('player-count').innerText = p.length;
            const list = document.getElementById('player-list');

            // Check if there are virtual players
            const hasVirtualPlayers = p.some(u => u.status === 'virtual');
            const noticeElement = document.getElementById('virtual-players-notice');
            if (hasVirtualPlayers) {
                noticeElement.style.display = 'block';
            } else {
                noticeElement.style.display = 'none';
            }

            list.innerHTML = p.map(u => {
                const isVirtual = u.status === 'virtual';
                const statusIcon = isVirtual ? 'üì±' : 'üü¢';
                const statusText = isVirtual ? 'Agregado manualmente' : 'Conectado';
                const kickButton = isVirtual ? '' : `<button onclick="kick('${u.id}')" class="btn-kick" title="Expulsar">‚úï</button>`;

                return `
                    <li style="${isVirtual ? 'background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 4px solid #4caf50;' : ''}">
                        <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                            <span style="font-weight:800; color:var(--stream-header); display:flex; align-items:center; gap:5px;">
                                ${statusIcon} ${u.name}
                            </span>
                            <span style="font-size:0.75rem; color:#666;">Cartones: ${u.cardCount} ‚Ä¢ ${statusText}</span>
                        </div>
                        ${kickButton}
                    </li>
                `;
            }).join('');
        });

        // Lista de Jugadores Pendientes
        socket.on('update_pending_players', (p) => {
            document.getElementById('pending-count').innerText = p.length;
            const list = document.getElementById('pending-list');
            list.innerHTML = p.map(u => `
                <li style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                        <span style="font-weight:800; color:#856404">${u.name}</span>
                        <span style="font-size:0.75rem; color:#856404;">Cartones: ${u.cardCount} (${u.cardIds.join(', ')})</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="acceptPlayer('${u.id}')" class="btn-accept" title="Aceptar">‚úì</button>
                        <button onclick="rejectPlayer('${u.id}')" class="btn-reject" title="Rechazar">‚úï</button>
                    </div>
                </li>
            `).join('');
        });

        // Notificaci√≥n de nuevo jugador pendiente
        socket.on('new_player_pending', (data) => {
            // Podr√≠amos mostrar una notificaci√≥n aqu√≠ si queremos
            console.log(`Nuevo jugador esperando aprobaci√≥n: ${data.name}`);
        });

        // Historial de Ganadores
        socket.on('update_history', (w) => updateWinners(w));

        // ALERTA DE GANADOR (POPUP)
        socket.on('winner_announced', (data) => {
            document.getElementById('modal-winner-name').innerText = data.user;
            document.getElementById('modal-winner-card').innerText = `#${data.card}`;
            const modal = document.getElementById('admin-winner-modal');
            modal.classList.remove('hidden');

            // Sonido de alerta (opcional)
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // El modal permanece abierto hasta que el admin haga clic en "CONFIRMAR VICTORIA"
        });

        // Reinicio
        socket.on('game_reset', () => {
            calledNumbers.clear();
            document.querySelectorAll('.num-item').forEach(b => b.classList.remove('active'));
            document.getElementById('count-called').innerText = "0";
            document.getElementById('roulette-display').innerText = "--";
            updateAdminLast5([]);
            closeAdminModal();
        });

        // --- FUNCIONES INTERNAS ---

        function updateAdminLast5(arr) {
            const container = document.getElementById('admin-last-5');
            const displayArr = [...arr];
            // Rellenar con guiones para mantener el layout fijo
            while(displayArr.length < 5) displayArr.push("-");
            
            container.innerHTML = displayArr.map(n => 
                `<div class="admin-ball">${n}</div>`
            ).join('');
        }

        function updateWinners(list) {
            const ul = document.getElementById('winner-list');
            ul.innerHTML = list.map(w => 
                `<li>
                    <span>‚≠ê ${w.user}</span> 
                    <span style="background:var(--stream-highlight); padding:2px 6px; border-radius:4px; color:white;">#${w.card}</span>
                </li>`
            ).join('');
        }

        function toggleCustomUI(mode) {
            const ui = document.getElementById('custom-ui');
            if(mode === 'custom') ui.classList.remove('hidden');
            else ui.classList.add('hidden');
        }

        function updatePatternDisplay(mode) {
            const container = document.getElementById('pattern-display');
            container.innerHTML = '';
            const cells = [];
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'pattern-cell-large';
                cells.push(cell);
                container.appendChild(cell);
            }

            const explanations = {
                'line': 'Cualquier l√≠nea horizontal, vertical o diagonal',
                'full': 'Todo el cart√≥n marcado (Blackout)',
                'corners': 'Las 4 esquinas del cart√≥n',
                'x': 'Ambas diagonales cruzadas (X)',
                'plus': 'Centro m√°s los 4 brazos (+)',
                'corners_center': '4 esquinas m√°s el centro',
                'frame': 'Marco exterior del cart√≥n',
                'inner_frame': 'Marco interior (cuadrado central)',
                'letter_h': 'Patr√≥n en forma de H',
                'letter_t': 'Patr√≥n en forma de T',
                'small_square': 'Cuadrado peque√±o en esquina superior izquierda',
                'diamond': 'Patr√≥n en forma de diamante',
                'custom': 'Patr√≥n personalizado definido abajo'
            };

            // Define patterns for each mode
            const patterns = {
                'full': Array(25).fill(true),
                'corners': [true,false,false,false,true, false,false,false,false,false, false,false,true,false,false, false,false,false,false,false, false,false,false,false,true],
                'x': [true,false,false,false,true, false,true,false,true,false, false,false,true,false,false, false,true,false,true,false, true,false,false,false,true],
                'plus': [false,false,true,false,false, false,false,true,false,false, true,true,true,true,true, false,false,true,false,false, false,false,true,false,false],
                'corners_center': [true,false,false,false,true, false,false,false,false,false, false,false,true,false,false, false,false,false,false,false, false,false,false,false,true],
                'frame': [true,true,true,true,true, true,false,false,false,true, true,false,false,false,true, true,false,false,false,true, true,true,true,true,true],
                'inner_frame': [false,false,false,false,false, false,true,true,true,false, false,true,false,true,false, false,true,true,true,false, false,false,false,false,false],
                'letter_h': [true,false,false,false,true, true,false,false,false,true, true,true,true,true,true, true,false,false,false,true, true,false,false,false,true],
                'letter_t': [true,true,true,true,true, false,false,true,false,false, false,false,true,false,false, false,false,true,false,false, false,false,true,false,false],
                'small_square': [true,true,false,false,false, true,true,false,false,false, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'diamond': [false,false,true,false,false, false,true,false,true,false, true,false,false,false,true, false,true,false,true,false, false,false,true,false,false],
                'line': [false,false,false,false,false, true,true,true,true,true, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'custom': customGrid
            };

            // Apply the pattern
            if(patterns[mode]) {
                cells.forEach((cell, index) => {
                    if(patterns[mode][index]) {
                        cell.classList.add('active');
                    }
                });
            }

            document.getElementById('pattern-explanation').innerText = explanations[mode] || '';
        }

        // --- ACCIONES DEL ADMIN ---

        function callNumber(n) {
            if(!calledNumbers.has(n)) socket.emit('admin_call_number', n);
        }

        function kick(id) {
            if(confirm("¬øSeguro que deseas expulsar a este jugador? Se liberar√°n sus cartones.")) {
                socket.emit('admin_kick_player', id);
            }
        }

        function updateMessage() {
            socket.emit('admin_set_message', document.getElementById('announce-input').value);
        }

        function changeMode() {
            const mode = document.getElementById('game-mode').value;
            console.log(`üéÆ Cambiando patr√≥n a: ${mode}`);
            toggleCustomUI(mode);
            updatePatternDisplay(mode);
            socket.emit('admin_set_pattern', { type: mode });
        }

        function sendPattern() {
            socket.emit('admin_set_pattern', { type: 'custom', grid: customGrid });
            alert("Figura personalizada aplicada.");
        }

        function resetGame() {
            if(confirm("‚ö†Ô∏è ¬øINICIAR NUEVA RONDA? \nLos jugadores permanecer√°n conectados pero se reiniciar√° el tablero.")) {
                socket.emit('admin_reset');
            }
        }

        function fullReset() {
            if(confirm("‚ö†Ô∏è ¬øREINICIAR TODO? \nSe desconectar√°n TODOS los jugadores y se reiniciar√° completamente el sistema.")) {
                socket.emit('admin_full_reset');
            }
        }

        function acceptPlayer(socketId) {
            socket.emit('admin_accept_player', socketId);
        }

        function rejectPlayer(socketId) {
            if(confirm("¬øRechazar a este jugador?")) {
                socket.emit('admin_reject_player', socketId);
            }
        }

        function logout() {
            sessionStorage.removeItem('yovanny_admin_auth');
            window.location.href = '/admin-login.html';
        }

        function closeAdminModal() {
            document.getElementById('admin-winner-modal').classList.add('hidden');
        }

        function switchTab(tab) {
            // Remove active class from all tab buttons and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab button and content
            if (tab === 'pending') {
                document.querySelector('.tab-button:first-child').classList.add('active');
                document.getElementById('pending-content').classList.add('active');
            } else if (tab === 'active') {
                document.querySelector('.tab-button:last-child').classList.add('active');
                document.getElementById('active-content').classList.add('active');
            }
        }

        let currentPendingPlayers = []; // Store pending players data

        // Funci√≥n para actualizar el estado de los cartones
        function updateCardsStatus() {
            // Get all active player cards
            const activePlayers = Array.from(document.querySelectorAll('#player-list li'))
                .map(li => {
                    const text = li.querySelector('span:last-child').textContent;
                    const match = text.match(/Cartones: (\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .reduce((total, count) => total + count, 0);

            // Get all pending player cards from stored data
            const pendingCards = currentPendingPlayers.reduce((total, player) => total + player.cardCount, 0);

            const usedCards = activePlayers + pendingCards;

            // Update counts
            document.getElementById('used-cards-count').innerText = usedCards;
            document.getElementById('available-cards-count').innerText = 300 - usedCards;

            // Update grid (simplified - just show used/available status)
            const grid = document.getElementById('cards-status-grid');
            grid.innerHTML = '';

            // For now, just show a simple indicator since we don't have detailed card assignment info
            for(let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-status-item available'; // Default to available
                cardDiv.innerText = i;
                grid.appendChild(cardDiv);
            }
        }



        socket.on('update_pending_players', (p) => {
            currentPendingPlayers = p; // Store pending players data
            document.getElementById('pending-count').innerText = p.length;
            const list = document.getElementById('pending-list');
            list.innerHTML = p.map(u => `
                <li style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                        <span style="font-weight:800; color:#856404">${u.name}</span>
                        <span style="font-size:0.75rem; color:#856404;">Cartones: ${u.cardCount} (${u.cardIds.join(', ')})</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="acceptPlayer('${u.id}')" class="btn-accept" title="Aceptar">‚úì</button>
                        <button onclick="rejectPlayer('${u.id}')" class="btn-reject" title="Rechazar">‚úï</button>
                    </div>
                </li>
            `).join('');
            updateCardsStatus(); // Update cards status when pending players change
        });

        // Initialize cards status on load
        document.addEventListener('DOMContentLoaded', () => {
            updateCardsStatus();
            // Request initial card status
            socket.emit('get_card_availability');
        });

        // Handle card availability response
        socket.on('card_availability', (data) => {
            takenCardsData = new Set(data.takenCards);
            updateCardAvailabilityDisplay(data.availableCount, data.usedCount);
            renderCardsStatusGrid();
        });

        // Update card status when players change
        socket.on('update_players', (p) => {
            // Request fresh card data when players change
            socket.emit('get_card_availability');
        });

        socket.on('admin_success', (data) => {
            alert(data.message);
            // Refresh card availability after adding player
            socket.emit('get_card_availability');
        });

        socket.on('admin_error', (data) => {
            alert('Error: ' + data.message);
        });

        // --- FUNCIONES PARA AGREGAR JUGADORES MANUALMENTE ---
        let adminSelectedCards = [];
        let takenCardsData = new Set();

        function openAddPlayerModal() {
            document.getElementById('add-player-modal').classList.remove('hidden');
            document.getElementById('new-player-name').value = '';
            adminSelectedCards = [];
            renderAdminSelectedCards();

            // Request current card availability
            socket.emit('get_card_availability');
        }

        function closeAddPlayerModal() {
            document.getElementById('add-player-modal').classList.add('hidden');
        }

        function renderAdminSelectedCards() {
            const container = document.getElementById('admin-selected-list');
            container.innerHTML = '';

            if (adminSelectedCards.length === 0) {
                container.innerHTML = '<span style="color:#666; font-size:0.8rem">Ning√∫n cart√≥n seleccionado</span>';
                return;
            }

            adminSelectedCards.forEach(id => {
                const chip = document.createElement('div');
                chip.className = 'card-chip';
                chip.innerHTML = `<span>#${id}</span> <button onclick="adminRemoveCard(${id})">√ó</button>`;
                container.appendChild(chip);
            });
        }

        function adminAddManualCard() {
            const input = document.getElementById('admin-manual-input');
            const id = parseInt(input.value);
            if (isNaN(id) || id < 1 || id > 300) {
                alert("El n√∫mero debe estar entre 1 y 300");
                return;
            }
            if (adminSelectedCards.includes(id)) {
                alert("Ya seleccionaste este cart√≥n");
                return;
            }
            adminSelectedCards.push(id);
            renderAdminSelectedCards();
            input.value = '';
        }

        function adminAddRandomCard() {
            let rand;
            let safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (adminSelectedCards.includes(rand) && safety < 500);

            adminSelectedCards.push(rand);
            renderAdminSelectedCards();
        }

        function adminRemoveCard(id) {
            adminSelectedCards = adminSelectedCards.filter(cardId => cardId !== id);
            renderAdminSelectedCards();
        }

        function addPlayerManually() {
            const playerName = document.getElementById('new-player-name').value.trim();

            if (!playerName) {
                alert("Por favor ingresa el nombre del jugador");
                return;
            }

            if (adminSelectedCards.length === 0) {
                alert("Por favor selecciona al menos un cart√≥n");
                return;
            }

            // Send to server
            socket.emit('admin_add_player', {
                name: playerName,
                cardIds: adminSelectedCards
            });

            // Close modal and reset
            closeAddPlayerModal();
            adminSelectedCards = [];
        }

        function updateCardAvailabilityDisplay(availableCount, usedCount) {
            // Update the main cards status display
            document.getElementById('used-cards-count').innerText = usedCount;
            document.getElementById('available-cards-count').innerText = availableCount;

            // Update the modal hint
            const hintElement = document.getElementById('card-availability-hint');
            hintElement.innerText = `Cartones disponibles: ${availableCount}/300`;
        }

        function renderCardsStatusGrid() {
            const gridElement = document.getElementById('cards-status-grid');
            gridElement.innerHTML = '';

            for (let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-status-item';
                cardDiv.innerText = i;

                if (takenCardsData.has(i)) {
                    cardDiv.classList.add('used');
                    cardDiv.title = 'Cart√≥n en uso';
                } else {
                    cardDiv.classList.add('available');
                    cardDiv.title = 'Cart√≥n disponible';
                }

                gridElement.appendChild(cardDiv);
            }
        }

        function renderCardAvailabilityGrid() {
            const gridElement = document.getElementById('card-availability-grid');
            gridElement.innerHTML = '';

            for (let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'availability-card';
                cardDiv.innerText = i;

                if (takenCardsData.has(i)) {
                    cardDiv.classList.add('taken');
                    cardDiv.title = 'Cart√≥n ocupado';
                } else {
                    cardDiv.classList.add('available');
                    cardDiv.title = 'Cart√≥n disponible';
                    cardDiv.onclick = () => toggleCardSelection(i);
                }

                gridElement.appendChild(cardDiv);
            }
        }

        function toggleCardSelection(cardId) {
            if (adminSelectedCards.includes(cardId)) {
                // Deselect
                adminSelectedCards = adminSelectedCards.filter(id => id !== cardId);
            } else {
                // Select
                adminSelectedCards.push(cardId);
            }
            renderAdminSelectedCards();
            updateCardGridSelection();
        }

        function updateCardGridSelection() {
            const gridCards = document.querySelectorAll('.availability-card');
            gridCards.forEach(card => {
                const cardId = parseInt(card.innerText);
                if (adminSelectedCards.includes(cardId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // --- ANIMACI√ìN DE RULETA ---
        function spinRoulette() {
            if(isSpinning) return;

            // Encontrar n√∫meros disponibles
            let pool = [];
            for(let i=1; i<=75; i++) {
                if(!calledNumbers.has(i)) pool.push(i);
            }

            if(pool.length === 0) return alert("¬°Juego Terminado! Ya salieron todas las bolas.");

            isSpinning = true;
            const disp = document.getElementById('roulette-display');
            let count = 0;
            const maxSpins = 15; // Cu√°ntas veces cambia el n√∫mero antes de parar

            const interval = setInterval(() => {
                // Mostrar n√∫mero aleatorio del pool visualmente
                const randomIndex = Math.floor(Math.random() * pool.length);
                disp.innerText = pool[randomIndex];

                count++;
                if(count > maxSpins) {
                    clearInterval(interval);
                    // Elegir el n√∫mero final REAL y enviarlo al servidor
                    const finalNumber = pool[Math.floor(Math.random() * pool.length)];
                    disp.innerText = finalNumber;
                    callNumber(finalNumber);
                    isSpinning = false;
                }
            }, 60); // Velocidad de cambio (ms)
        }
    </script>
</body>
</html>