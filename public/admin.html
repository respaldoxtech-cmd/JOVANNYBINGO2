<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Yovanny Bingo</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="fixes.js"></script>

    <!-- Audio System -->
    <script>
        // Audio System for Bingo Sounds
        class BingoAudio {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.enabled = true;
                this.init();
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.createSounds();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                    this.enabled = false;
                }
            }

            createSounds() {
                // Bingo Celebration Sound
                this.sounds.bingo = () => this.createBingoSound();

                // New Player Join Sound
                this.sounds.playerJoin = () => this.createPlayerJoinSound();

                // Button Click Sound
                this.sounds.buttonClick = () => this.createButtonClickSound();

                // Number Draw Sound
                this.sounds.numberDraw = () => this.createNumberDrawSound();

                // Success Sound for admin actions
                this.sounds.success = () => this.createSuccessSound();

                // Notification Sound for pending players
                this.sounds.notification = () => this.createNotificationSound();
            }

            createTone(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.enabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            createBingoSound() {
                // Triumphant fanfare-like sound
                const now = this.audioContext.currentTime;

                // C4, E4, G4 chord
                this.createTone(261.63, 0.8, 'triangle', 0.4); // C4
                setTimeout(() => this.createTone(329.63, 0.8, 'triangle', 0.4), 100); // E4
                setTimeout(() => this.createTone(392.00, 1.0, 'triangle', 0.4), 200); // G4

                // Higher celebration notes
                setTimeout(() => this.createTone(523.25, 0.3, 'sine', 0.3), 800); // C5
                setTimeout(() => this.createTone(659.25, 0.3, 'sine', 0.3), 900); // E5
                setTimeout(() => this.createTone(783.99, 0.5, 'sine', 0.3), 1000); // G5
            }

            createPlayerJoinSound() {
                // Pleasant notification sound
                this.createTone(440, 0.15, 'sine', 0.2); // A4
                setTimeout(() => this.createTone(554.37, 0.15, 'sine', 0.2), 150); // C#5
                setTimeout(() => this.createTone(659.25, 0.2, 'sine', 0.2), 300); // E5
            }

            createButtonClickSound() {
                // Short click sound
                this.createTone(800, 0.05, 'square', 0.1);
            }

            createNumberDrawSound() {
                // Ball rolling/dropping sound
                const now = this.audioContext.currentTime;

                // Quick descending tones
                this.createTone(600, 0.1, 'sawtooth', 0.2);
                setTimeout(() => this.createTone(500, 0.1, 'sawtooth', 0.2), 50);
                setTimeout(() => this.createTone(400, 0.15, 'sawtooth', 0.25), 100);
            }

            createSuccessSound() {
                // Pleasant success confirmation
                this.createTone(523.25, 0.1, 'sine', 0.2); // C5
                setTimeout(() => this.createTone(659.25, 0.1, 'sine', 0.2), 100); // E5
                setTimeout(() => this.createTone(783.99, 0.15, 'sine', 0.2), 200); // G5
            }

            createNotificationSound() {
                // Attention-grabbing notification sound for pending players
                this.createTone(800, 0.08, 'square', 0.15); // G5
                setTimeout(() => this.createTone(1000, 0.08, 'square', 0.15), 100); // E6
                setTimeout(() => this.createTone(1200, 0.12, 'square', 0.15), 200); // C6
            }

            play(soundName) {
                if (this.enabled && this.sounds[soundName]) {
                    // Resume audio context if suspended (required by browsers)
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    this.sounds[soundName]();
                }
            }

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        }

        // Initialize audio system
        const bingoAudio = new BingoAudio();
    </script>
    
    <script>
        if (!sessionStorage.getItem('yovanny_admin_auth')) {
            window.location.href = '/admin-login.html'; // O '/login.html' si no usaste el login dedicado
        }
    </script>
</head>
<body class="admin-ui">

    <div class="watermark-layer"></div>

    <div class="dashboard-layout">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="admin-logo-img">
                <span class="brand-name">PANEL DE CONTROL</span>
            </div>

            <div class="nav-group">
                <label>BOMBO VIRTUAL</label>
                <div class="roulette-widget">
                    <div id="roulette-display" class="big-num">--</div>
                    <button onclick="spinRoulette()" class="btn-action">GIRAR BOLA</button>
                    
                    <div class="last-5-container">
                        <small class="last-5-label">√öltimas 5:</small>
                        <div id="admin-last-5" class="last-5-row">
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                            <div class="admin-ball">-</div>
                        </div>
                    </div>
                    <div class="stats-text">Total Sacadas: <span id="count-called">0</span>/300</div>
                </div>
            </div>

            <div class="nav-group">
                <label>NOTICIERO (TICKER)</label>
                <div class="input-row">
                    <input type="text" id="announce-input" placeholder="Escribe un anuncio...">
                    <button onclick="updateMessage()" class="btn-icon-sm">ENVIAR</button>
                </div>
            </div>

            <div class="nav-group">
                <label>üîô CONTROL DE TIROS</label>
                <div class="undo-controls">
                    <button onclick="undoLastNumber()" class="btn-undo" title="Deshacer √∫ltimo tiro">‚Ü©Ô∏è DESHACER √öLTIMO</button>
                    <div class="uncall-section">
                        <input type="number" id="uncall-input" placeholder="N√∫mero a descarcelar" min="1" max="75">
                        <button onclick="uncallNumber()" class="btn-uncall" title="Descarcelar n√∫mero">üö´ DESCARCELAR</button>
                    </div>
                </div>
                <small class="hint-text" style="margin-top: 5px; display: block; text-align: center; color: #666;">Utiliza estas herramientas para corregir errores de tiro</small>
            </div>

            <div class="nav-group">
                <label>üèÜ GANADORES</label>
                <ul id="winner-list" class="scroll-list gold-text sidebar-winners">
                </ul>
            </div>

            <div class="nav-group">
                <label>üé´ ESTADO DE CARTONES</label>
                <div class="sidebar-cards-status">
                    <div class="cards-summary">
                        <div class="status-item">
                            <span class="status-label">EN USO:</span>
                            <span class="status-count used" id="used-cards-count">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">DISPONIBLES:</span>
                            <span class="status-count available" id="available-cards-count">75</span>
                        </div>
                    </div>
                    <div class="cards-grid" id="cards-status-grid">
                        <!-- Cards will be populated here -->
                    </div>
                    <button onclick="openCardAvailabilityModal()" class="btn-link" style="margin-top: 8px; font-size: 0.8rem;">Ver todos los cartones</button>
                </div>
            </div>

            <div class="sidebar-footer">
                <button onclick="openAddPlayerModal()" class="btn-danger-outline" style="margin-bottom: 8px;">‚ûï AGREGAR JUGADOR</button>
                <button id="startAutoCall" class="btn-primary" style="margin-bottom: 8px;" onclick="startAutoCall()">‚ñ∂Ô∏è INICIAR TIRO AUTOM√ÅTICO</button>
                <button id="stopAutoCall" class="btn-warning" style="margin-bottom: 8px; display: none;" onclick="stopAutoCall()">‚èπÔ∏è DETENER TIRO AUTOM√ÅTICO</button>
                <button onclick="resetGame()" class="btn-danger-outline">NUEVA RONDA</button>
                <button onclick="fullReset()" class="btn-danger-outline" style="margin-top: 8px;">REINICIAR TODO</button>
                <button onclick="logout()" class="btn-link" style="margin-top: 8px;">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <h2>
                    <span style="color:var(--stream-accent)">YOVANNY BINGO</span>
                    <span style="font-weight:400; font-size:1rem; margin-left:10px; color:#666;">| MONITOR EN VIVO</span>
                </h2>
                <span class="badge-live">‚óè TRANSMITIENDO</span>
            </header>

            <div class="grid-content">

                <div class="left-column">
                    <div class="last-number-display">
                        <div class="last-number-label">√öLTIMO N√öMERO</div>
                        <div id="last-number-large" class="last-number-large">--</div>
                    </div>
                    <div class="card board-card">
                        <div id="master-board" class="master-board-grid">
                            </div>
                    </div>
                </div>

                <div class="side-column">

        <div class="card info-card">
            <div class="card-header">
                <h3>üéØ CONFIGURACI√ìN DE CARTONES</h3>
            </div>
            <div class="game-config-content">
                <select id="game-mode" onchange="changeMode()" class="select-dark" style="margin-bottom: 15px;">
                    <optgroup label="L√≠neas Espec√≠ficas">
                        <option value="line_horizontal_1">L√≠nea Horizontal 1</option>
                        <option value="line_horizontal_2">L√≠nea Horizontal 2</option>
                        <option value="line_horizontal_3">L√≠nea Horizontal 3</option>
                        <option value="line_horizontal_4">L√≠nea Horizontal 4</option>
                        <option value="line_horizontal_5">L√≠nea Horizontal 5</option>
                        <option value="line_vertical_B">L√≠nea Vertical B</option>
                        <option value="line_vertical_I">L√≠nea Vertical I</option>
                        <option value="line_vertical_N">L√≠nea Vertical N</option>
                        <option value="line_vertical_G">L√≠nea Vertical G</option>
                        <option value="line_vertical_O">L√≠nea Vertical O</option>
                        <option value="line_diagonal_main">L√≠nea Diagonal Principal</option>
                        <option value="line_diagonal_secondary">L√≠nea Diagonal Secundaria</option>
                    </optgroup>
                    <optgroup label="L√≠neas Generales">
                        <option value="line_horizontal">Cualquier L√≠nea Horizontal</option>
                        <option value="line_vertical">Cualquier L√≠nea Vertical</option>
                        <option value="line_diagonal">Cualquier L√≠nea Diagonal</option>
                        <option value="line">Cualquier L√≠nea (H,V,D)</option>
                    </optgroup>
                    <optgroup label="Figuras Especiales">
                        <option value="full">Cart√≥n Lleno (Blackout)</option>
                        <option value="corners">4 Esquinas</option>
                        <option value="x">X (Diagonales Cruzadas)</option>
                        <option value="plus">Plus (Centro + Brazos)</option>
                        <option value="corners_center">Esquinas + Centro</option>
                        <option value="frame">Marco Exterior</option>
                        <option value="inner_frame">Marco Interior</option>
                        <option value="letter_h">Letra H</option>
                        <option value="letter_t">Letra T</option>
                        <option value="small_square">Cuadrado Peque√±o</option>
                        <option value="diamond">Diamante</option>
                        <option value="star">Estrella</option>
                        <option value="heart">Coraz√≥n</option>
                        <option value="airplane">Avi√≥n</option>
                        <option value="arrow">Flecha</option>
                        <option value="crazy">Crazy (Zigzag)</option>
                        <option value="pyramid">Pir√°mide</option>
                        <option value="cross">Cruz</option>
                        <option value="custom">Figura Manual (Personalizada)</option>
                    </optgroup>
                </select>

                <div class="pattern-container">
                    <div id="pattern-display" class="pattern-display-large"></div>
                </div>
                <small id="pattern-explanation" class="pattern-explanation" style="display: block; text-align: center; margin: 10px 0; font-weight: 600;"></small>

                <div id="custom-ui" class="hidden custom-pattern-ui">
                    <div style="text-align:center; margin-bottom:10px; font-size:0.8rem; font-weight:600;">DIBUJA TU FIGURA PERSONALIZADA:</div>
                    <div id="pattern-grid" class="pattern-mini-large"></div>
                    <button onclick="sendPattern()" class="btn-apply-pattern">APLICAR FIGURA</button>
                </div>
            </div>
        </div>

        <!-- NUEVA SECCI√ìN: NOTIFICACIONES DE BINGO -->
        <div class="card info-card">
            <div class="card-header">
                <h3>üö® NOTIFICACIONES DE BINGO</h3>
            </div>
            <div class="bingo-notifications-content">
                <div class="current-pattern-display">
                    <h4>Patr√≥n Actual: <span id="current-pattern-name-display">Selecciona un patr√≥n</span></h4>
                    <div id="admin-pattern-board" class="admin-pattern-grid">
                        <!-- Tablero de 5x5 para mostrar el patr√≥n actual -->
                    </div>
                    <p class="pattern-hint" style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;">
                        El patr√≥n seleccionado se mostrar√° visualmente aqu√≠
                    </p>
                </div>

                <div class="notifications-section">
                    <h4>Alertas de Bingo</h4>
                    <div id="bingo-notifications-list" class="notifications-list">
                        <p style="text-align: center; color: #666; font-style: italic; padding: 20px;">Esperando notificaciones de Bingo...</p>
                    </div>
                </div>
            </div>
        </div>

                    <div class="card info-card">
                        <div class="card-header">
                            <h3>üë• JUGADORES</h3>
                        </div>
                        <div class="players-section">
                            <div class="player-tabs">
                                <button class="tab-button active" onclick="switchTab('pending')">‚è≥ PENDIENTES <span class="badge-count" id="pending-count">0</span></button>
                                <button class="tab-button" onclick="switchTab('active')">ACTIVOS <span class="badge-count" id="player-count">0</span></button>
                            </div>
                            <div id="pending-content" class="tab-content active">
                                <ul id="pending-list" class="scroll-list">
                                </ul>
                            </div>
                            <div id="active-content" class="tab-content">
                                <ul id="player-list" class="scroll-list">
                                </ul>
                                <div id="virtual-players-notice" class="info-notice" style="display: none; margin-top: 10px; padding: 8px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; font-size: 0.85rem; color: #2e7d32;">
                                    <strong>üì± Jugadores Agregados Manualmente:</strong> Estos jugadores pueden ganar premios pero no est√°n conectados f√≠sicamente.
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>
        </main>
    </div>

    <div id="admin-winner-modal" class="modal-backdrop hidden">
        <div class="winner-alert-box bounce-in">
            <div class="alert-icon">üö®</div>
            <h2>üéâ ¬°BINGO GANADO!</h2>
            <div class="winner-details">
                <h3 id="modal-winner-name">Nombre del Jugador</h3>
                <p class="winner-card-info">Cart√≥n <span id="modal-winner-card" class="highlight-card">#000</span></p>
                <div class="winner-stats">
                    <span class="stat-item">‚è±Ô∏è <span id="modal-winner-time">--:--</span></span>
                    <span class="stat-item">üî¢ <span id="modal-winner-numbers">0</span> n√∫meros llamados</span>
                    <span class="stat-item">üéØ <span id="modal-winner-pattern">Patr√≥n</span></span>
                </div>
            </div>
            <div class="winner-card-preview">
                <h4>Cart√≥n Ganador</h4>
                <div id="winner-card-display" class="winner-card-grid">
                    <!-- Cart√≥n del ganador se mostrar√° aqu√≠ -->
                </div>
            </div>
            <div class="winner-pattern-info">
                <h4>Patr√≥n Completado</h4>
                <div id="winner-pattern-display" class="winner-pattern-grid">
                    <!-- Patr√≥n completado se mostrar√° aqu√≠ -->
                </div>
                <div class="pattern-numbers-called">
                    <span>N√∫meros llamados: <span id="modal-winner-calls">--</span></span>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="closeAdminModal()" class="btn-confirm">CONFIRMAR VICTORIA</button>
                <button onclick="shareWinner()" class="btn-share">üì§ COMPARTIR</button>
            </div>
        </div>
    </div>

    <div id="add-player-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>‚ûï AGREGAR JUGADOR MANUALMENTE</h3>
                <button onclick="closeAddPlayerModal()" class="btn-close">‚úï</button>
            </div>
            <div class="modal-content" style="padding: 20px; max-height: calc(80vh - 80px); overflow-y: auto;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre del Jugador:</label>
                    <input type="text" id="new-player-name" placeholder="Ingresa el nombre..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Seleccionar Cartones:</label>
                    <div class="card-picker-ui" style="border: 1px solid #eee; padding: 10px; border-radius: 6px;">
                        <div class="picker-controls">
                            <input type="number" id="admin-manual-input" placeholder="#" min="1" max="300">
                            <button onclick="adminAddManualCard()" class="btn-add">‚ûï Agregar</button>
                            <button onclick="adminAddRandomCard()" class="btn-random">üé≤ Aleatorio</button>
                        </div>
                        <small class="hint-text" id="card-availability-hint">Verificando disponibilidad...</small>
                        <div id="admin-selected-list" class="chips-container" style="margin-top: 10px;"></div>
                        <div id="card-availability-grid" class="mini-card-grid" style="margin-top: 10px; display: grid; grid-template-columns: repeat(15, 1fr); gap: 2px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;"></div>
                    </div>
                </div>

                <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeAddPlayerModal()" class="btn-secondary">CANCELAR</button>
                    <button onclick="addPlayerManually()" class="btn-primary">AGREGAR JUGADOR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="card-availability-modal" class="modal-backdrop hidden">
        <div class="modal-card slide-up" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>üé´ ESTADO DE CARTONES</h3>
                <button onclick="closeCardAvailabilityModal()" class="btn-close">‚úï</button>
            </div>
            <div class="modal-content" style="padding: 20px;">
                <div class="cards-summary" style="margin-bottom: 20px;">
                    <div class="status-item">
                        <span class="status-label">EN USO:</span>
                        <span class="status-count used" id="modal-used-cards-count">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">DISPONIBLES:</span>
                        <span class="status-count available" id="modal-available-cards-count">300</span>
                    </div>
                </div>
                <div id="modal-cards-grid" class="mini-card-grid" style="display: grid; grid-template-columns: repeat(15, 1fr); gap: 2px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let calledNumbers = new Set();
        let customGrid = Array(25).fill(false);
        let isSpinning = false;

        // 1. INICIALIZAR TABLERO MAESTRO
        const board = document.getElementById('master-board');
        board.innerHTML = ''; // Limpiar por seguridad
        for(let i=1; i<=75; i++) {
            const d = document.createElement('div');
            d.innerText = i;
            d.className = 'num-item'; // Clase del CSS nuevo
            d.id = `btn-${i}`;
            // Permitir marcar/desmarcar manualmente si el admin quiere corregir
            d.onclick = () => {
                if(!isSpinning) callNumber(i);
            };
            board.appendChild(d);
        }

        // 2. INICIALIZAR GRID DE PATR√ìN MANUAL
        const pGrid = document.getElementById('pattern-grid');
        pGrid.innerHTML = '';
        for(let i=0; i<25; i++) {
            const d = document.createElement('div');
            d.className = 'p-dot';
            if(i === 12) {
                d.style.background = '#ccc'; // Centro FREE
                d.style.cursor = 'default';
            } else {
                d.onclick = function() {
                    this.classList.toggle('active');
                    customGrid[i] = !customGrid[i];
                };
            }
            pGrid.appendChild(d);
        }

        // --- SOCKET LISTENERS (LA INTELIGENCIA) ---

        // Sincronizar estado al entrar
        socket.on('sync_state', (s) => {
            // Actualizar tablero
            s.calledNumbers.forEach(n => {
                calledNumbers.add(n);
                const el = document.getElementById(`btn-${n}`);
                if(el) el.classList.add('active');
            });
            
            // Actualizar textos y contadores
            document.getElementById('announce-input').value = s.message;
            document.getElementById('count-called').innerText = calledNumbers.size;
            updateWinners(s.last5Winners);
            updateAdminLast5(s.last5Numbers);
            
            // Sincronizar modo de juego
            const modeSelect = document.getElementById('game-mode');
            modeSelect.value = s.pattern;
            toggleCustomUI(s.pattern);
            updatePatternDisplay(s.pattern);
        });

        // Bola Nueva
        socket.on('number_called', ({num, last5}) => {
            calledNumbers.add(num);
            const el = document.getElementById(`btn-${num}`);
            if(el) {
                el.classList.add('active');
                // Efecto visual de parpadeo
                el.style.transform = "scale(1.3)";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            }

            // Update large last number display
            document.getElementById('last-number-large').innerText = num;
            // Add pulse animation effect
            const largeDisplay = document.getElementById('last-number-large');
            largeDisplay.style.animation = 'none';
            setTimeout(() => largeDisplay.style.animation = 'numberPulse 0.8s ease-out', 10);

            if(!isSpinning) document.getElementById('roulette-display').innerText = num;
            document.getElementById('count-called').innerText = calledNumbers.size;
            updateAdminLast5(last5);
        });

        // Lista de Jugadores
        socket.on('update_players', (p) => {
            document.getElementById('player-count').innerText = p.length;
            const list = document.getElementById('player-list');

            // Check if there are virtual players
            const hasVirtualPlayers = p.some(u => u.status === 'virtual');
            const noticeElement = document.getElementById('virtual-players-notice');
            if (hasVirtualPlayers) {
                noticeElement.style.display = 'block';
            } else {
                noticeElement.style.display = 'none';
            }

            list.innerHTML = p.map(u => {
                const isVirtual = u.status === 'virtual';
                const statusIcon = isVirtual ? 'üì±' : 'üü¢';
                const statusText = isVirtual ? 'Agregado manualmente' : 'Conectado';
                const kickButton = isVirtual ? '' : `<button onclick="kick('${u.id}')" class="btn-kick" title="Expulsar">‚úï</button>`;

                return `
                    <li style="${isVirtual ? 'background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 4px solid #4caf50;' : ''}">
                        <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                            <span style="font-weight:800; color:var(--stream-header); display:flex; align-items:center; gap:5px;">
                                ${statusIcon} ${u.name}
                            </span>
                            <span style="font-size:0.75rem; color:#666;">Cartones: ${u.cardCount} ‚Ä¢ ${statusText}</span>
                        </div>
                        ${kickButton}
                    </li>
                `;
            }).join('');
        });

        // Lista de Jugadores Pendientes
        socket.on('update_pending_players', (p) => {
            document.getElementById('pending-count').innerText = p.length;
            const list = document.getElementById('pending-list');
            list.innerHTML = p.map(u => `
                <li style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                        <span style="font-weight:800; color:#856404">${u.name}</span>
                        <span style="font-size:0.75rem; color:#856404;">Cartones: ${u.cardCount} (${u.cardIds.join(', ')})</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="acceptPlayer('${u.id}')" class="btn-accept" title="Aceptar">‚úì</button>
                        <button onclick="rejectPlayer('${u.id}')" class="btn-reject" title="Rechazar">‚úï</button>
                    </div>
                </li>
            `).join('');
        });

        // Notificaci√≥n de nuevo jugador pendiente
        socket.on('new_player_pending', (data) => {
            // üéµ Sonido de notificaci√≥n para jugadores pendientes
            bingoAudio.play('notification');

            console.log(`Nuevo jugador esperando aprobaci√≥n: ${data.name}`);
        });

        // Historial de Ganadores
        socket.on('update_history', (w) => updateWinners(w));

        // ALERTA DE GANADOR (POPUP)
        socket.on('winner_announced', (data) => {
            document.getElementById('modal-winner-name').innerText = data.user;
            document.getElementById('modal-winner-card').innerText = `#${data.card}`;
            const modal = document.getElementById('admin-winner-modal');
            modal.classList.remove('hidden');

            // üéµ Sonido de bingo en admin
            bingoAudio.play('bingo');

            // Vibraci√≥n si est√° disponible
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);

            // Mostrar informaci√≥n detallada del ganador
            showWinnerDetails(data);

            // El modal permanece abierto hasta que el admin haga clic en "CONFIRMAR VICTORIA"
        });

        // Funci√≥n para mostrar detalles del ganador (MEJORADA)
        function showWinnerDetails(winnerData) {
            // Generar el cart√≥n del ganador
            const winnerCard = generateCard(winnerData.card);
            
            // Mostrar estad√≠sticas del ganador con datos reales
            const currentTime = new Date();
            document.getElementById('modal-winner-time').innerText = currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            document.getElementById('modal-winner-numbers').innerText = calledNumbers.size;
            document.getElementById('modal-winner-pattern').innerText = getPatternName(gameState.pattern);
            document.getElementById('modal-winner-calls').innerText = Array.from(calledNumbers).join(', ');

            // Mostrar el cart√≥n ganador
            renderWinnerCard(winnerCard);

            // Mostrar el patr√≥n completado
            renderWinnerPattern(winnerCard);

            // Mostrar informaci√≥n adicional del ganador
            showWinnerAdditionalInfo(winnerData, winnerCard);
        }

        // Funci√≥n para mostrar informaci√≥n adicional del ganador
        function showWinnerAdditionalInfo(winnerData, winnerCard) {
            // Calcular estad√≠sticas avanzadas
            const totalNumbersCalled = calledNumbers.size;
            const cardNumbers = extractCardNumbers(winnerCard);
            const matchedNumbers = cardNumbers.filter(num => calledNumbers.has(num));
            const winPercentage = ((matchedNumbers.length / cardNumbers.length) * 100).toFixed(1);
            const freeSpaces = cardNumbers.filter(num => num === "FREE").length;
            const actualMatches = matchedNumbers.filter(num => num !== "FREE").length;

            // Mostrar estad√≠sticas detalladas
            const statsContainer = document.querySelector('.winner-stats');
            statsContainer.innerHTML = `
                <span class="stat-item">‚è±Ô∏è <span id="modal-winner-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</span></span>
                <span class="stat-item">üî¢ <span id="modal-winner-numbers">${totalNumbersCalled}</span> n√∫meros llamados</span>
                <span class="stat-item">üéØ <span id="modal-winner-pattern">${getPatternName(gameState.pattern)}</span></span>
                <span class="stat-item">‚úÖ <span>${actualMatches}</span> coincidencias</span>
                <span class="stat-item">üìä <span>${winPercentage}%</span> completado</span>
            `;

            // Mostrar n√∫meros ganadores espec√≠ficos
            const patternNumbers = getWinningNumbersForPattern(winnerCard, gameState.pattern);
            const winningNumbersText = patternNumbers.length > 0 ? patternNumbers.join(', ') : Array.from(calledNumbers).slice(0, 10).join(', ') + '...';
            document.getElementById('modal-winner-calls').innerText = winningNumbersText;

            // Resaltar celdas ganadoras en el cart√≥n
            highlightWinningCells(winnerCard, gameState.pattern);
        }

        // Funci√≥n para extraer todos los n√∫meros del cart√≥n
        function extractCardNumbers(card) {
            const numbers = [];
            const columns = ['B', 'I', 'N', 'G', 'O'];
            columns.forEach(col => {
                card[col].forEach(num => {
                    if (num !== "FREE") {
                        numbers.push(num);
                    } else {
                        numbers.push("FREE");
                    }
                });
            });
            return numbers;
        }

        // Funci√≥n para obtener los n√∫meros ganadores seg√∫n el patr√≥n
        function getWinningNumbersForPattern(card, patternType) {
            const winningNumbers = [];
            const columns = ['B', 'I', 'N', 'G', 'O'];
            
            // Definir patrones para obtener n√∫meros ganadores
            const patterns = {
                'full': Array(25).fill(true),
                'corners': [true,false,false,false,true, false,false,false,false,false, false,false,true,false,false, false,false,false,false,false, false,false,false,false,true],
                'x': [true,false,false,false,true, false,true,false,true,false, false,false,true,false,false, false,true,false,true,false, true,false,false,false,true],
                'plus': [false,false,true,false,false, false,false,true,false,false, true,true,true,true,true, false,false,true,false,false, false,false,true,false,false],
                'corners_center': [true,false,false,false,true, false,false,false,false,false, false,false,true,false,false, false,false,false,false,false, false,false,false,false,true],
                'frame': [true,true,true,true,true, true,false,false,false,true, true,false,false,false,true, true,false,false,false,true, true,true,true,true,true],
                'inner_frame': [false,false,false,false,false, false,true,true,true,false, false,true,false,true,false, false,true,true,true,false, false,false,false,false,false],
                'line_horizontal': [false,false,false,false,false, true,true,true,true,true, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'line_vertical': [true,false,false,false,false, true,false,false,false,false, true,false,false,false,false, true,false,false,false,false, true,false,false,false,false],
                'line_diagonal': [true,false,false,false,false, false,true,false,false,false, false,false,true,false,false, false,false,false,true,false, false,false,false,false,true],
                'custom': customGrid
            };

            const pattern = patterns[patternType] || patterns['line_horizontal'];
            
            // Mapear el patr√≥n a los n√∫meros del cart√≥n
            let index = 0;
            columns.forEach(col => {
                card[col].forEach((num, row) => {
                    if (pattern[index] && num !== "FREE") {
                        winningNumbers.push(num);
                    }
                    index++;
                });
            });

            return winningNumbers;
        }

        // Funci√≥n para resaltar celdas ganadoras
        function highlightWinningCells(card, patternType) {
            const winningNumbers = getWinningNumbersForPattern(card, patternType);
            const cardContainer = document.getElementById('winner-card-display');
            const cells = cardContainer.querySelectorAll('.winner-card-cell');
            
            cells.forEach((cell, index) => {
                const cellNumber = parseInt(cell.innerText);
                if (winningNumbers.includes(cellNumber)) {
                    cell.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    cell.style.color = 'white';
                    cell.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.8)';
                    cell.style.transform = 'scale(1.1)';
                    cell.style.fontWeight = '900';
                }
            });
        }

        // Funci√≥n para generar un cart√≥n (copiada de la l√≥gica del cliente)
        function generateCard(cardId) {
            const rng = mulberry32(cardId);
            const fillCol = (min, max, count) => {
                let nums = new Set();
                let safety = 0;
                while(nums.size < count && safety < 500) {
                    let n = Math.floor(rng() * (max - min + 1)) + min;
                    nums.add(n);
                    safety++;
                }
                return Array.from(nums);
            };

            const colN = fillCol(31, 45, 4);
            const N = [colN[0], colN[1], "FREE", colN[2], colN[3]];

            return {
                id: cardId,
                B: fillCol(1, 15, 5),
                I: fillCol(16, 30, 5),
                N: N,
                G: fillCol(46, 60, 5),
                O: fillCol(61, 75, 5)
            };
        }

        // Funci√≥n para renderizar el cart√≥n ganador
        function renderWinnerCard(card) {
            const container = document.getElementById('winner-card-display');
            container.innerHTML = '';

            const columns = ['B', 'I', 'N', 'G', 'O'];
            const colors = ['#e3f2fd', '#e8f5e8', '#fff3e0', '#fce4ec', '#f3e5f5'];

            columns.forEach((col, colIndex) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'winner-card-column';
                colDiv.style.backgroundColor = colors[colIndex];

                // Header de columna
                const header = document.createElement('div');
                header.className = 'winner-card-header';
                header.innerText = col;
                colDiv.appendChild(header);

                // N√∫meros de la columna
                card[col].forEach(num => {
                    const cell = document.createElement('div');
                    cell.className = 'winner-card-cell';
                    cell.innerText = num;
                    
                    // Marcar como llamado si el n√∫mero fue llamado
                    if (calledNumbers.has(num)) {
                        cell.classList.add('called');
                    }
                    
                    colDiv.appendChild(cell);
                });

                container.appendChild(colDiv);
            });
        }

        // Funci√≥n para renderizar el patr√≥n completado
        function renderWinnerPattern(card) {
            const container = document.getElementById('winner-pattern-display');
            container.innerHTML = '';

            // Crear una cuadr√≠cula 5x5 para el patr√≥n
            for (let row = 0; row < 5; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'winner-pattern-row';

                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'winner-pattern-cell';

                    // Obtener el n√∫mero en esta posici√≥n
                    const columns = ['B', 'I', 'N', 'G', 'O'];
                    const num = card[columns[col]][row];

                    // Verificar si este n√∫mero fue llamado
                    const isCalled = calledNumbers.has(num);
                    const isFree = num === "FREE";

                    if (isFree) {
                        cell.classList.add('free-cell');
                        cell.innerText = "FREE";
                    } else {
                        cell.innerText = num;
                        if (isCalled) {
                            cell.classList.add('pattern-completed');
                        }
                    }

                    rowDiv.appendChild(cell);
                }

                container.appendChild(rowDiv);
            }
        }

        // Funci√≥n para obtener el nombre del patr√≥n
        function getPatternName(patternType) {
            const patternNames = {
                'line_horizontal': 'L√≠nea Horizontal',
                'line_vertical': 'L√≠nea Vertical', 
                'line_diagonal': 'L√≠nea Diagonal',
                'full': 'Cart√≥n Lleno (Blackout)',
                'corners': '4 Esquinas',
                'x': 'X (Diagonales Cruzadas)',
                'plus': 'Plus (Centro + Brazos)',
                'corners_center': 'Esquinas + Centro',
                'frame': 'Marco Exterior',
                'inner_frame': 'Marco Interior',
                'letter_h': 'Letra H',
                'letter_t': 'Letra T',
                'small_square': 'Cuadrado Peque√±o',
                'diamond': 'Diamante',
                'star': 'Estrella',
                'heart': 'Coraz√≥n',
                'airplane': 'Avi√≥n',
                'arrow': 'Flecha',
                'crazy': 'Crazy (Zigzag)',
                'pyramid': 'Pir√°mide',
                'cross': 'Cruz',
                'custom': 'Figura Personalizada'
            };

            return patternNames[patternType] || 'Patr√≥n Desconocido';
        }

        // Funci√≥n para compartir el ganador (copiar al portapapeles)
        function shareWinner() {
            const winnerName = document.getElementById('modal-winner-name').innerText;
            const winnerCard = document.getElementById('modal-winner-card').innerText;
            const winnerTime = document.getElementById('modal-winner-time').innerText;
            const winnerNumbers = document.getElementById('modal-winner-numbers').innerText;
            const winnerPattern = document.getElementById('modal-winner-pattern').innerText;

            const shareText = `üéâ ¬°${winnerName} ha ganado el Bingo! üéâ\nCart√≥n: ${winnerCard}\nHora: ${winnerTime}\nN√∫meros llamados: ${winnerNumbers}\nPatr√≥n: ${winnerPattern}\n\n¬°Felicidades!`;

            navigator.clipboard.writeText(shareText).then(() => {
                alert('¬°Informaci√≥n del ganador copiada al portapapeles!\n' + shareText);
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar al portapapeles. Por favor, comparte manualmente:\n\n' + shareText);
            });
        }

        // Reinicio
        socket.on('game_reset', () => {
            calledNumbers.clear();
            document.querySelectorAll('.num-item').forEach(b => b.classList.remove('active'));
            document.getElementById('count-called').innerText = "0";
            document.getElementById('roulette-display').innerText = "--";
            updateAdminLast5([]);
            closeAdminModal();
            
            // Reset large last number display
            document.getElementById('last-number-large').innerText = "--";
        });

        // --- FUNCIONES INTERNAS ---

        function updateAdminLast5(arr) {
            const container = document.getElementById('admin-last-5');
            const displayArr = [...arr];
            // Rellenar con guiones para mantener el layout fijo
            while(displayArr.length < 5) displayArr.push("-");
            
            container.innerHTML = displayArr.map(n => 
                `<div class="admin-ball">${n}</div>`
            ).join('');
        }

        function updateWinners(list) {
            const ul = document.getElementById('winner-list');
            ul.innerHTML = list.map(w => 
                `<li>
                    <span>‚≠ê ${w.user}</span> 
                    <span style="background:var(--stream-highlight); padding:2px 6px; border-radius:4px; color:white;">#${w.card}</span>
                </li>`
            ).join('');
        }

        function toggleCustomUI(mode) {
            const ui = document.getElementById('custom-ui');
            if(mode === 'custom') ui.classList.remove('hidden');
            else ui.classList.add('hidden');
        }

        // Funci√≥n para mapear √≠ndice visual (fila por fila) a √≠ndice l√≥gico (columna por columna)
        function visualToLogicalIndex(visualIndex) {
            // El grid visual se muestra en orden de filas:
            // Fila 0: 0,1,2,3,4
            // Fila 1: 5,6,7,8,9
            // Fila 2: 10,11,12,13,14
            // Fila 3: 15,16,17,18,19
            // Fila 4: 20,21,22,23,24

            // El servidor indexa por columnas (B,I,N,G,O):
            // Columna B: 0,1,2,3,4
            // Columna I: 5,6,7,8,9
            // Columna N: 10,11,12,13,14
            // Columna G: 15,16,17,18,19
            // Columna O: 20,21,22,23,24

            // Conversi√≥n: visualIndex -> (fila, columna) -> logicalIndex
            const row = Math.floor(visualIndex / 5);
            const col = visualIndex % 5;
            return col * 5 + row;
        }

        function updatePatternDisplay(mode) {
            const container = document.getElementById('pattern-display');
            container.innerHTML = '';
            const cells = [];
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'pattern-cell-large';
                cells.push(cell);
                container.appendChild(cell);
            }

            const explanations = {
                'line': 'Cualquier l√≠nea horizontal, vertical o diagonal',
                'line_horizontal': 'Cualquier l√≠nea horizontal (filas)',
                'line_vertical': 'Cualquier l√≠nea vertical (columnas)',
                'line_diagonal': 'Cualquier l√≠nea diagonal',
                'full': 'Todo el cart√≥n marcado (Blackout)',
                'corners': 'Las 4 esquinas del cart√≥n',
                'x': 'Ambas diagonales cruzadas (X)',
                'plus': 'Centro m√°s los 4 brazos (+)',
                'corners_center': '4 esquinas m√°s el centro',
                'frame': 'Marco exterior del cart√≥n',
                'inner_frame': 'Marco interior (cuadrado central)',
                'letter_h': 'Patr√≥n en forma de H',
                'letter_t': 'Patr√≥n en forma de T',
                'small_square': 'Cuadrado peque√±o en esquina superior izquierda',
                'diamond': 'Patr√≥n en forma de diamante',
                'star': 'Estrella',
                'heart': 'Coraz√≥n',
                'airplane': 'Avi√≥n',
                'arrow': 'Flecha',
                'crazy': 'Crazy (Zigzag)',
                'pyramid': 'Pir√°mide',
                'cross': 'Cruz',
                'custom': 'Patr√≥n personalizado definido abajo'
            };

            // Define patterns using LOGICAL indexing (columnas B,I,N,G,O)
            // Column B: 0,1,2,3,4
            // Column I: 5,6,7,8,9
            // Column N: 10,11,12,13,14
            // Column G: 15,16,17,18,19
            // Column O: 20,21,22,23,24
            const patterns = {
                'full': Array(25).fill(true),
                'corners': [true,false,false,false,true, true,false,false,false,true, true,false,false,false,true, true,false,false,false,true, true,false,false,false,true],
                'x': [true,false,false,false,true, false,true,false,true,false, false,false,true,false,false, false,true,false,true,false, true,false,false,false,true],
                'plus': [false,false,true,false,false, false,false,true,false,false, true,true,true,true,true, false,false,true,false,false, false,false,true,false,false],
                'corners_center': [true,false,false,false,true, true,false,false,false,true, true,false,true,false,true, true,false,false,false,true, true,false,false,false,true],
                'frame': [true,true,true,true,true, true,false,false,false,true, true,false,false,false,true, true,false,false,false,true, true,true,true,true,true],
                'inner_frame': [false,false,false,false,false, false,true,true,true,false, false,true,false,true,false, false,true,true,true,false, false,false,false,false,false],
                'letter_h': [true,false,false,false,true, true,false,false,false,true, true,true,true,true,true, true,false,false,false,true, true,false,false,false,true],
                'letter_t': [true,true,true,true,true, false,false,true,false,false, false,false,true,false,false, false,false,true,false,false, false,false,true,false,false],
                'small_square': [true,true,false,false,false, true,true,false,false,false, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'diamond': [false,false,true,false,false, false,true,false,true,false, true,false,false,false,true, false,true,false,true,false, false,false,true,false,false],
                'star': [false,true,false,true,false, true,true,true,true,true, false,true,true,true,false, true,true,true,true,true, false,true,false,true,false],
                'heart': [false,true,false,true,false, true,true,true,true,true, true,true,true,true,true, true,true,true,true,true, false,true,true,true,false],
                'airplane': [false,false,true,false,false, true,true,true,true,true, false,true,true,true,false, false,true,false,true,false, false,false,false,false,false],
                'arrow': [false,false,true,false,false, false,true,true,true,false, true,true,true,true,true, false,false,true,false,false, false,false,true,false,false],
                'crazy': [true,false,false,false,false, false,false,true,false,false, false,false,false,false,true, false,true,false,false,false, false,false,false,true,false],
                'pyramid': [false,false,true,false,false, false,true,true,true,false, true,true,true,true,true, false,false,false,false,false, false,false,false,false,false],
                'cross': [false,true,false,false,false, true,true,true,false,false, false,true,false,false,false, false,true,false,false,false, false,true,false,false,false],
                'line': [false,false,false,false,false, true,true,true,true,true, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'line_horizontal': [false,false,false,false,false, true,true,true,true,true, false,false,false,false,false, false,false,false,false,false, false,false,false,false,false],
                'line_vertical': [true,false,false,false,false, true,false,false,false,false, true,false,false,false,false, true,false,false,false,false, true,false,false,false,false],
                'line_diagonal': [true,false,false,false,false, false,true,false,false,false, false,false,true,false,false, false,false,false,true,false, false,false,false,false,true],
                'custom': customGrid
            };

            // Apply the pattern using LOGICAL indexing
            if(patterns[mode]) {
                cells.forEach((cell, visualIndex) => {
                    const logicalIndex = visualToLogicalIndex(visualIndex);
                    if(patterns[mode][logicalIndex]) {
                        cell.classList.add('active');
                    }
                });
            }

            document.getElementById('pattern-explanation').innerText = explanations[mode] || '';
        }

        // --- ACCIONES DEL ADMIN ---

        function callNumber(n) {
            if(!calledNumbers.has(n)) socket.emit('admin_call_number', n);
        }

        function kick(id) {
            if(confirm("¬øSeguro que deseas expulsar a este jugador? Se liberar√°n sus cartones.")) {
                socket.emit('admin_kick_player', id);
            }
        }

        function updateMessage() {
            socket.emit('admin_set_message', document.getElementById('announce-input').value);
        }

        function changeMode() {
            const mode = document.getElementById('game-mode').value;
            console.log(`üéÆ Cambiando patr√≥n a: ${mode}`);
            toggleCustomUI(mode);
            updatePatternDisplay(mode);
            socket.emit('admin_set_pattern', { type: mode });
        }

        function sendPattern() {
            socket.emit('admin_set_pattern', { type: 'custom', grid: customGrid });
            alert("Figura personalizada aplicada.");
        }

        function resetGame() {
            if(confirm("‚ö†Ô∏è ¬øINICIAR NUEVA RONDA? \nLos jugadores permanecer√°n conectados pero se reiniciar√° el tablero.")) {
                socket.emit('admin_reset');
            }
        }

        function fullReset() {
            if(confirm("‚ö†Ô∏è ¬øREINICIAR TODO? \nSe desconectar√°n TODOS los jugadores y se reiniciar√° completamente el sistema.")) {
                socket.emit('admin_full_reset');
            }
        }

        function acceptPlayer(socketId) {
            socket.emit('admin_accept_player', socketId);
        }

        function rejectPlayer(socketId) {
            if(confirm("¬øRechazar a este jugador?")) {
                socket.emit('admin_reject_player', socketId);
            }
        }

        function logout() {
            sessionStorage.removeItem('yovanny_admin_auth');
            window.location.href = '/admin-login.html';
        }

        function closeAdminModal() {
            document.getElementById('admin-winner-modal').classList.add('hidden');
        }

        function switchTab(tab) {
            // Remove active class from all tab buttons and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab button and content
            if (tab === 'pending') {
                document.querySelector('.tab-button:first-child').classList.add('active');
                document.getElementById('pending-content').classList.add('active');
            } else if (tab === 'active') {
                document.querySelector('.tab-button:last-child').classList.add('active');
                document.getElementById('active-content').classList.add('active');
            }
        }

        let currentPendingPlayers = []; // Store pending players data

        // Funci√≥n para actualizar el estado de los cartones
        function updateCardsStatus() {
            // Get all active player cards
            const activePlayers = Array.from(document.querySelectorAll('#player-list li'))
                .map(li => {
                    const text = li.querySelector('span:last-child').textContent;
                    const match = text.match(/Cartones: (\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .reduce((total, count) => total + count, 0);

            // Get all pending player cards from stored data
            const pendingCards = currentPendingPlayers.reduce((total, player) => total + player.cardCount, 0);

            const usedCards = activePlayers + pendingCards;

            // Update counts
            document.getElementById('used-cards-count').innerText = usedCards;
            document.getElementById('available-cards-count').innerText = 300 - usedCards;

            // Update grid (simplified - just show used/available status)
            const grid = document.getElementById('cards-status-grid');
            grid.innerHTML = '';

            // For now, just show a simple indicator since we don't have detailed card assignment info
            for(let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-status-item available'; // Default to available
                cardDiv.innerText = i;
                grid.appendChild(cardDiv);
            }
        }



        socket.on('update_pending_players', (p) => {
            currentPendingPlayers = p; // Store pending players data
            document.getElementById('pending-count').innerText = p.length;
            const list = document.getElementById('pending-list');
            list.innerHTML = p.map(u => `
                <li style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <div style="display:flex; flex-direction:column; line-height:1.2; flex:1;">
                        <span style="font-weight:800; color:#856404">${u.name}</span>
                        <span style="font-size:0.75rem; color:#856404;">Cartones: ${u.cardCount} (${u.cardIds.join(', ')})</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="acceptPlayer('${u.id}')" class="btn-accept" title="Aceptar">‚úì</button>
                        <button onclick="rejectPlayer('${u.id}')" class="btn-reject" title="Rechazar">‚úï</button>
                    </div>
                </li>
            `).join('');
            updateCardsStatus(); // Update cards status when pending players change
        });

        // Initialize cards status on load
        document.addEventListener('DOMContentLoaded', () => {
            updateCardsStatus();
            // Request initial card status
            socket.emit('get_card_availability');
        });

        // Handle card availability response
        socket.on('card_availability', (data) => {
            takenCardsData = new Set(data.takenCards);
            updateCardAvailabilityDisplay(data.availableCount, data.usedCount);
            renderCardsStatusGrid();
        });

        // Update card status when players change
        socket.on('update_players', (p) => {
            // Request fresh card data when players change
            socket.emit('get_card_availability');
        });

        socket.on('admin_success', (data) => {
            // üéµ Sonido de √©xito al agregar jugador
            bingoAudio.play('success');

            alert(data.message);
            // Refresh card availability after adding player
            socket.emit('get_card_availability');
        });

        socket.on('admin_error', (data) => {
            alert('Error: ' + data.message);
        });

        // --- FUNCIONES PARA AGREGAR JUGADORES MANUALMENTE ---
        let adminSelectedCards = [];
        let takenCardsData = new Set();

        function openAddPlayerModal() {
            document.getElementById('add-player-modal').classList.remove('hidden');
            document.getElementById('new-player-name').value = '';
            adminSelectedCards = [];
            renderAdminSelectedCards();

            // Request current card availability
            socket.emit('get_card_availability');
        }

        function closeAddPlayerModal() {
            document.getElementById('add-player-modal').classList.add('hidden');
        }

        function openCardAvailabilityModal() {
            document.getElementById('card-availability-modal').classList.remove('hidden');
            renderModalCardsGrid();
        }

        function closeCardAvailabilityModal() {
            document.getElementById('card-availability-modal').classList.add('hidden');
        }

        function renderModalCardsGrid() {
            const gridElement = document.getElementById('modal-cards-grid');
            gridElement.innerHTML = '';

            for (let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'availability-card';
                cardDiv.innerText = i;

                if (takenCardsData.has(i)) {
                    cardDiv.classList.add('taken');
                    cardDiv.title = 'Cart√≥n ocupado';
                } else {
                    cardDiv.classList.add('available');
                    cardDiv.title = 'Cart√≥n disponible';
                }

                gridElement.appendChild(cardDiv);
            }
        }

        function renderAdminSelectedCards() {
            const container = document.getElementById('admin-selected-list');
            container.innerHTML = '';

            if (adminSelectedCards.length === 0) {
                container.innerHTML = '<span style="color:#666; font-size:0.8rem">Ning√∫n cart√≥n seleccionado</span>';
                return;
            }

            adminSelectedCards.forEach(id => {
                const chip = document.createElement('div');
                chip.className = 'card-chip';
                chip.innerHTML = `<span>#${id}</span> <button onclick="adminRemoveCard(${id})">√ó</button>`;
                container.appendChild(chip);
            });
        }

        function adminAddManualCard() {
            const input = document.getElementById('admin-manual-input');
            const id = parseInt(input.value);
            if (isNaN(id) || id < 1 || id > 300) {
                alert("El n√∫mero debe estar entre 1 y 300");
                return;
            }
            if (adminSelectedCards.includes(id)) {
                alert("Ya seleccionaste este cart√≥n");
                return;
            }
            adminSelectedCards.push(id);
            renderAdminSelectedCards();
            input.value = '';
        }

        function adminAddRandomCard() {
            let rand;
            let safety = 0;
            do {
                rand = Math.floor(Math.random() * 300) + 1;
                safety++;
            } while (adminSelectedCards.includes(rand) && safety < 500);

            adminSelectedCards.push(rand);
            renderAdminSelectedCards();
        }

        function adminRemoveCard(id) {
            adminSelectedCards = adminSelectedCards.filter(cardId => cardId !== id);
            renderAdminSelectedCards();
        }

        function addPlayerManually() {
            const playerName = document.getElementById('new-player-name').value.trim();

            if (!playerName) {
                alert("Por favor ingresa el nombre del jugador");
                return;
            }

            if (adminSelectedCards.length === 0) {
                alert("Por favor selecciona al menos un cart√≥n");
                return;
            }

            // Send to server
            socket.emit('admin_add_player', {
                name: playerName,
                cardIds: adminSelectedCards
            });

            // Close modal and reset
            closeAddPlayerModal();
            adminSelectedCards = [];
        }

        function updateCardAvailabilityDisplay(availableCount, usedCount) {
            // Update the main cards status display
            document.getElementById('used-cards-count').innerText = usedCount;
            document.getElementById('available-cards-count').innerText = availableCount;

            // Update the modal hint
            const hintElement = document.getElementById('card-availability-hint');
            hintElement.innerText = `Cartones disponibles: ${availableCount}/300`;
        }

        function renderCardsStatusGrid() {
            const gridElement = document.getElementById('cards-status-grid');
            gridElement.innerHTML = '';

            for (let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-status-item';
                cardDiv.innerText = i;

                if (takenCardsData.has(i)) {
                    cardDiv.classList.add('used');
                    cardDiv.title = 'Cart√≥n en uso';
                } else {
                    cardDiv.classList.add('available');
                    cardDiv.title = 'Cart√≥n disponible';
                }

                gridElement.appendChild(cardDiv);
            }
        }

        function renderCardAvailabilityGrid() {
            const gridElement = document.getElementById('card-availability-grid');
            gridElement.innerHTML = '';

            for (let i = 1; i <= 300; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'availability-card';
                cardDiv.innerText = i;

                if (takenCardsData.has(i)) {
                    cardDiv.classList.add('taken');
                    cardDiv.title = 'Cart√≥n ocupado';
                } else {
                    cardDiv.classList.add('available');
                    cardDiv.title = 'Cart√≥n disponible';
                    cardDiv.onclick = () => toggleCardSelection(i);
                }

                gridElement.appendChild(cardDiv);
            }
        }

        function toggleCardSelection(cardId) {
            if (adminSelectedCards.includes(cardId)) {
                // Deselect
                adminSelectedCards = adminSelectedCards.filter(id => id !== cardId);
            } else {
                // Select
                adminSelectedCards.push(cardId);
            }
            renderAdminSelectedCards();
            updateCardGridSelection();
        }

        function updateCardGridSelection() {
            const gridCards = document.querySelectorAll('.availability-card');
            gridCards.forEach(card => {
                const cardId = parseInt(card.innerText);
                if (adminSelectedCards.includes(cardId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // --- ANIMACI√ìN DE RULETA ---
        // --- TIRO AUTOM√ÅTICO (CADA 5 SEGUNDOS) ---
        let autoCallInterval = null;
        let isAutoCalling = false;

        function startAutoCall() {
            if (isAutoCalling) return;

            const startBtn = document.getElementById('startAutoCall');
            const stopBtn = document.getElementById('stopAutoCall');

            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            isAutoCalling = true;

            // üéµ Sonido de inicio de tiro autom√°tico
            bingoAudio.play('buttonClick');

            autoCallInterval = setInterval(() => {
                // Encontrar n√∫meros disponibles
                let pool = [];
                for(let i=1; i<=75; i++) {
                    if(!calledNumbers.has(i)) pool.push(i);
                }

                if(pool.length === 0) {
                    stopAutoCall();
                    alert("¬°Juego Terminado! Ya salieron todas las bolas.");
                    return;
                }

                // Elegir n√∫mero aleatorio y llamarlo
                const randomIndex = Math.floor(Math.random() * pool.length);
                const numberToCall = pool[randomIndex];
                callNumber(numberToCall);

                // üéµ Sonido de n√∫mero llamado
                bingoAudio.play('numberDraw');
            }, 5000); // Cada 5 segundos

            console.log('üéØ Tiro autom√°tico iniciado (cada 5 segundos)');
        }

        function stopAutoCall() {
            if (!isAutoCalling) return;

            const startBtn = document.getElementById('startAutoCall');
            const stopBtn = document.getElementById('stopAutoCall');

            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            isAutoCalling = false;

            if (autoCallInterval) {
                clearInterval(autoCallInterval);
                autoCallInterval = null;
            }

            console.log('üõë Tiro autom√°tico detenido');
        }

        // --- FUNCIONES DE ACTUALIZACI√ìN DE FIGURAS ---
        // Funci√≥n para mapear √≠ndice visual (fila por fila) a √≠ndice l√≥gico (columna por columna)
        function visualToLogicalIndex(visualIndex) {
            // El grid visual se muestra en orden de filas:
            // Fila 0: 0,1,2,3,4
            // Fila 1: 5,6,7,8,9
            // Fila 2: 10,11,12,13,14
            // Fila 3: 15,16,17,18,19
            // Fila 4: 20,21,22,23,24
            
            // El servidor indexa por columnas (B,I,N,G,O):
            // Columna B: 0,1,2,3,4
            // Columna I: 5,6,7,8,9
            // Columna N: 10,11,12,13,14
            // Columna G: 15,16,17,18,19
            // Columna O: 20,21,22,23,24
            
            // Conversi√≥n: visualIndex -> (fila, columna) -> logicalIndex
            const row = Math.floor(visualIndex / 5);
            const col = visualIndex % 5;
            return col * 5 + row;
        }

        // Definici√≥n centralizada de patrones (debe coincidir con el servidor)
        const BINGO_PATTERNS = {
            'line': [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
                [0,6,12,18,24], [4,8,12,16,20]
            ],
            'line_horizontal_1': [[0,5,10,15,20]],
            'line_horizontal_2': [[1,6,11,16,21]],
            'line_horizontal_3': [[2,7,12,17,22]],
            'line_horizontal_4': [[3,8,13,18,23]],
            'line_horizontal_5': [[4,9,14,19,24]],
            'line_vertical_B': [[0,1,2,3,4]],
            'line_vertical_I': [[5,6,7,8,9]],
            'line_vertical_N': [[10,11,12,13,14]],
            'line_vertical_G': [[15,16,17,18,19]],
            'line_vertical_O': [[20,21,22,23,24]],
            'line_diagonal_main': [[0,6,12,18,24]],
            'line_diagonal_secondary': [[4,8,12,16,20]],
            'line_horizontal': [
                [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24]
            ],
            'line_vertical': [
                [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24]
            ],
            'line_diagonal': [
                [0,6,12,18,24], [4,8,12,16,20]
            ],
            'full': [[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]],
            'corners': [[0,4,20,24]],
            'x': [[0,6,12,18,24], [4,8,12,16,20]],
            'plus': [[7,11,12,13,17]],
            'corners_center': [[0,4,12,20,24]],
            'frame': [[0,1,2,3,4,9,14,19,24,23,22,21,20,15,10,5]],
            'inner_frame': [[6,7,8,11,13,16,17,18]],
            'letter_h': [[0,5,10,15,20,2,7,12,17,22,4,9,14,19,24]],
            'letter_t': [[0,1,2,3,4,7,12,17]],
            'small_square': [[0,1,5,6]],
            'diamond': [[2,6,10,14,18,22]],
            'star': [[2,6,8,10,12,14,16,18,7,11,12,13,17]],
            'heart': [[1,3,6,7,8,9,11,12,13,16,18]],
            'airplane': [[1,3,5,7,9,11,13,15,17,19,21,23]],
            'arrow': [[2,7,10,11,12,13,14,17]],
            'crazy': [[0,2,4,6,8,10,12,14,16,18,20,22,24]],
            'pyramid': [[2,6,7,8,10,11,12,13,14,16,17,18]],
            'cross': [[2,7,11,12,13,17,22]],
            'custom': null
        };

        function updatePatternDisplay(mode) {
            const container = document.getElementById('pattern-display');
            container.innerHTML = '';
            const cells = [];
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'pattern-cell-large';
                cells.push(cell);
                container.appendChild(cell);
            }

            const explanations = {
                'line': 'Cualquier l√≠nea horizontal, vertical o diagonal',
                'line_horizontal': 'Cualquier l√≠nea horizontal (filas)',
                'line_vertical': 'Cualquier l√≠nea vertical (columnas)',
                'line_diagonal': 'Cualquier l√≠nea diagonal',
                'full': 'Todo el cart√≥n marcado (Blackout)',
                'corners': 'Las 4 esquinas del cart√≥n',
                'x': 'Ambas diagonales cruzadas (X)',
                'plus': 'Centro m√°s los 4 brazos (+)',
                'corners_center': '4 esquinas m√°s el centro',
                'frame': 'Marco exterior del cart√≥n',
                'inner_frame': 'Marco interior (cuadrado central)',
                'letter_h': 'Patr√≥n en forma de H',
                'letter_t': 'Patr√≥n en forma de T',
                'small_square': 'Cuadrado peque√±o en esquina superior izquierda',
                'diamond': 'Patr√≥n en forma de diamante',
                'star': 'Estrella',
                'heart': 'Coraz√≥n',
                'airplane': 'Avi√≥n',
                'arrow': 'Flecha',
                'crazy': 'Crazy (Zigzag)',
                'pyramid': 'Pir√°mide',
                'cross': 'Cruz',
                'custom': 'Patr√≥n personalizado definido abajo'
            };

            // Aplicar el patr√≥n usando el mapeo visual a l√≥gico
            if(BINGO_PATTERNS[mode]) {
                const pattern = BINGO_PATTERNS[mode];
                
                // Para patrones que son arrays de arrays (m√∫ltiples l√≠neas posibles)
                if(Array.isArray(pattern) && Array.isArray(pattern[0])) {
                    // Tomar la primera l√≠nea como representaci√≥n visual
                    const firstLine = pattern[0];
                    cells.forEach((cell, visualIndex) => {
                        const logicalIndex = visualToLogicalIndex(visualIndex);
                        if(firstLine.includes(logicalIndex)) {
                            cell.classList.add('active');
                        }
                    });
                }
                // Para patrones que son arrays simples (patrones estrictos)
                else if(Array.isArray(pattern)) {
                    cells.forEach((cell, visualIndex) => {
                        const logicalIndex = visualToLogicalIndex(visualIndex);
                        if(pattern.includes(logicalIndex)) {
                            cell.classList.add('active');
                        }
                    });
                }
            }

            document.getElementById('pattern-explanation').innerText = explanations[mode] || '';
        }

        // Actualizar la funci√≥n changeMode para usar la nueva l√≥gica
        function changeMode() {
            const mode = document.getElementById('game-mode').value;
            console.log(`üéÆ Cambiando patr√≥n a: ${mode}`);
            toggleCustomUI(mode);
            updatePatternDisplay(mode);
            socket.emit('admin_set_pattern', { type: mode });
        }

        // Actualizar la funci√≥n sendPattern para usar el nuevo mapeo
        function sendPattern() {
            // Convertir el grid visual a √≠ndices l√≥gicos
            const logicalGrid = customGrid.map((isActive, visualIndex) => {
                if (isActive) {
                    return visualToLogicalIndex(visualIndex);
                }
                return null;
            }).filter(index => index !== null);

            socket.emit('admin_set_pattern', { type: 'custom', grid: logicalGrid });
            alert("Figura personalizada aplicada.");
        }

        // --- ANIMACI√ìN DE RULETA ---
        function spinRoulette() {
            if(isSpinning) return;

            // Encontrar n√∫meros disponibles
            let pool = [];
            for(let i=1; i<=75; i++) {
                if(!calledNumbers.has(i)) pool.push(i);
            }

            if(pool.length === 0) return alert("¬°Juego Terminado! Ya salieron todas las bolas.");

            isSpinning = true;
            const disp = document.getElementById('roulette-display');
            let count = 0;
            const maxSpins = 15; // Cu√°ntas veces cambia el n√∫mero antes de parar

            const interval = setInterval(() => {
                // Mostrar n√∫mero aleatorio del pool visualmente
                const randomIndex = Math.floor(Math.random() * pool.length);
                disp.innerText = pool[randomIndex];

                count++;
                if(count > maxSpins) {
                    clearInterval(interval);
                    // Elegir el n√∫mero final REAL y enviarlo al servidor
                    const finalNumber = pool[Math.floor(Math.random() * pool.length)];
                    disp.innerText = finalNumber;
                    callNumber(finalNumber);
                    isSpinning = false;
                }
            }, 60); // Velocidad de cambio (ms)
        }

        // --- FUNCIONES DE DESHACER Y DESCARCELAR ---
        function undoLastNumber() {
            if (calledNumbers.size === 0) {
                alert("No hay n√∫meros llamados para deshacer.");
                return;
            }

            // üéµ Sonido de deshacer
            bingoAudio.play('buttonClick');

            // Enviar solicitud al servidor para deshacer el √∫ltimo n√∫mero
            socket.emit('admin_undo_last_number');
        }

        function uncallNumber() {
            const input = document.getElementById('uncall-input');
            const number = parseInt(input.value);

            if (isNaN(number) || number < 1 || number > 75) {
                alert("Por favor ingresa un n√∫mero v√°lido entre 1 y 75.");
                return;
            }

            // üéµ Sonido de descarcelar
            bingoAudio.play('buttonClick');

            // Enviar solicitud al servidor para descarcelar el n√∫mero
            socket.emit('admin_uncall_number', number);
            input.value = ''; // Limpiar el input
        }

        // --- SOCKET LISTENERS PARA DESHACER Y DESCARCELAR ---
        socket.on('number_undone', (data) => {
            // Actualizar el conjunto de n√∫meros llamados
            calledNumbers.delete(data.number);
            
            // Actualizar el tablero maestro
            const el = document.getElementById(`btn-${data.number}`);
            if(el) {
                el.classList.remove('active');
                // Efecto visual de deshacer
                el.style.transform = "scale(0.8)";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            }

            // Update large last number display
            if (data.calledNumbers.length > 0) {
                document.getElementById('last-number-large').innerText = data.calledNumbers[data.calledNumbers.length - 1];
            } else {
                document.getElementById('last-number-large').innerText = "--";
            }

            // Actualizar contador
            document.getElementById('count-called').innerText = data.totalCalled;
            
            // Actualizar √∫ltima ronda
            updateAdminLast5(data.last5);

            console.log(`üîô √öltimo tiro deshecho: ${data.number}`);
        });

        socket.on('number_uncalled', (data) => {
            // Actualizar el conjunto de n√∫meros llamados
            calledNumbers.delete(data.number);
            
            // Actualizar el tablero maestro
            const el = document.getElementById(`btn-${data.number}`);
            if(el) {
                el.classList.remove('active');
                // Efecto visual de descarcelar
                el.style.transform = "scale(0.8)";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            }

            // Update large last number display (no cambiar si no es el √∫ltimo)
            // Solo actualizar si el n√∫mero descarcelado era el √∫ltimo llamado
            if (data.calledNumbers.length > 0 && data.number === data.calledNumbers[data.calledNumbers.length - 1]) {
                document.getElementById('last-number-large').innerText = data.calledNumbers[data.calledNumbers.length - 1];
            }

            // Actualizar contador
            document.getElementById('count-called').innerText = data.totalCalled;
            
            // Actualizar √∫ltima ronda
            updateAdminLast5(data.last5);

            console.log(`üîô N√∫mero descarcelado: ${data.number}`);
        });

        // --- FUNCIONES DE NOTIFICACIONES DE BINGO ---

        // Inicializar el tablero de patr√≥n del administrador
        function initializeAdminPatternBoard() {
            const board = document.getElementById('admin-pattern-board');
            board.innerHTML = '';
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'admin-pattern-cell';
                // Remove the index display for cleaner visual appearance
                cell.innerText = ''; // Clean visual appearance
                board.appendChild(cell);
            }
        }

        // Actualizar el display del patr√≥n actual
        function updateCurrentPatternDisplay(patternKey) {
            const patternNameDisplay = document.getElementById('current-pattern-name-display');
            const patternName = getPatternName(patternKey);
            patternNameDisplay.innerText = patternName || 'Patr√≥n Desconocido';

            // Resaltar el patr√≥n en el tablero del administrador
            highlightAdminPattern(patternKey);
        }

        // Resaltar el patr√≥n en el tablero del administrador
        function highlightAdminPattern(patternKey) {
            const board = document.getElementById('admin-pattern-board');
            const cells = board.querySelectorAll('.admin-pattern-cell');
            
            // Limpiar resaltados anteriores
            cells.forEach(cell => {
                cell.classList.remove('pattern-highlight');
                cell.classList.remove('bingo-highlight');
            });

            // Obtener el patr√≥n y resaltarlo
            const pattern = BINGO_PATTERNS[patternKey];
            if (pattern) {
                // Para patrones que son arrays de arrays (m√∫ltiples l√≠neas posibles)
                if(Array.isArray(pattern) && Array.isArray(pattern[0])) {
                    // Tomar la primera l√≠nea como representaci√≥n visual
                    const firstLine = pattern[0];
                    cells.forEach((cell, visualIndex) => {
                        const logicalIndex = visualToLogicalIndex(visualIndex);
                        if(firstLine.includes(logicalIndex)) {
                            cell.classList.add('pattern-highlight');
                        }
                    });
                }
                // Para patrones que son arrays simples (patrones estrictos)
                else if(Array.isArray(pattern)) {
                    cells.forEach((cell, visualIndex) => {
                        const logicalIndex = visualToLogicalIndex(visualIndex);
                        if(pattern.includes(logicalIndex)) {
                            cell.classList.add('pattern-highlight');
                        }
                    });
                }
            }
        }

        // A√±adir una notificaci√≥n de Bingo al panel del administrador
        function addBingoNotification(playerId, patternKey, patternName) {
            const notificationsContainer = document.getElementById('bingo-notifications-list');
            
            // Quitar el mensaje de "Esperando Bingos..." si existe
            const waitingMessage = notificationsContainer.querySelector('p');
            if (waitingMessage) {
                waitingMessage.remove();
            }

            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');
            notificationItem.setAttribute('data-player-id', playerId);

            notificationItem.innerHTML = `
                <span>üö® ¬°BINGO de Jugador ${playerId} con patr√≥n ${patternName}!</span>
                <button onclick="resolveBingoNotification('${playerId}', this)" class="btn-resolve">Resolver</button>
            `;
            
            // A√±adir al principio de la lista
            notificationsContainer.prepend(notificationItem);

            // üéµ Sonido de notificaci√≥n de Bingo
            bingoAudio.play('notification');

            // Opcional: Resaltar el tablero del administrador brevemente con el patr√≥n que hizo Bingo
            const winningPatternIndices = BINGO_PATTERNS[patternKey];
            if (winningPatternIndices) {
                const board = document.getElementById('admin-pattern-board');
                const cells = board.querySelectorAll('.admin-pattern-cell');
                
                cells.forEach((cell, visualIndex) => {
                    const logicalIndex = visualToLogicalIndex(visualIndex);
                    if (Array.isArray(winningPatternIndices) && winningPatternIndices.includes(logicalIndex)) {
                        cell.classList.add('bingo-highlight');
                    }
                });
                
                // Despu√©s de un tiempo, quitar el highlight de bingo y restaurar el de patr√≥n si aplica
                setTimeout(() => {
                    cells.forEach((cell, visualIndex) => {
                        cell.classList.remove('bingo-highlight');
                        const logicalIndex = visualToLogicalIndex(visualIndex);
                        if (BINGO_PATTERNS[patternKey] && BINGO_PATTERNS[patternKey].includes && BINGO_PATTERNS[patternKey].includes(logicalIndex)) {
                            cell.classList.add('pattern-highlight');
                        }
                    });
                }, 3000); // 3 segundos de resalte
            }
        }

        // Marcar una notificaci√≥n de Bingo como resuelta
        function resolveBingoNotification(playerId, buttonElement) {
            const notificationItem = buttonElement.closest('.notification-item');
            if (notificationItem) {
                notificationItem.classList.add('resolved');
                buttonElement.remove(); // Quitar el bot√≥n de resolver
                
                // Enviar evento de resoluci√≥n al servidor
                socket.emit('admin_resolve_bingo', { playerId: playerId });
            }
            console.log(`Bingo del jugador ${playerId} resuelto.`);
        }

        // --- SOCKET LISTENERS PARA NOTIFICACIONES DE BINGO ---
        // Sincronizar el patr√≥n actual con el panel de administraci√≥n
        socket.on('sync_state', (s) => {
            // ... c√≥digo existente ...
            
            // Actualizar el patr√≥n actual en el panel de notificaciones
            updateCurrentPatternDisplay(s.pattern);
        });

        // Escuchar cuando se establece un nuevo patr√≥n
        socket.on('pattern_set', (data) => {
            updateCurrentPatternDisplay(data.pattern);
        });

        // Escuchar notificaciones de Bingo de los clientes
        socket.on('client_bingo_notification', (data) => {
            addBingoNotification(data.playerId, data.patternKey, data.patternName);
        });

        // Escuchar resoluci√≥n de Bingo
        socket.on('bingo_resolved', (data) => {
            resolveBingoNotification(data.playerId);
        });

        // Inicializar el tablero de patr√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            initializeAdminPatternBoard();
        });
    </script>
</body>
</html>